---
title: "Lathyrus ms3: Selective agents"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggthemes)
library(MuMIn)
library(knitr)
library(gridExtra)
library(lme4)
library(parallel)
library(lmerTest)
library(effects)
library(broom)
library(car)
library(grid)
library(RColorBrewer)
library(ggeffects)
library(piecewiseSEM)
library(glmmTMB)
library(DHARMa)
library(performance)
```

```{r Define ggplot themes and palettes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
```

```{r function to check for overdispersion, include=FALSE}
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
```

```{r function summarySE, include=FALSE}
## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
  library(plyr)
  
  # New version of length which can handle NA's: if na.rm==T, don't count them
  length2 <- function (x, na.rm=FALSE) {
    if (na.rm) sum(!is.na(x))
    else       length(x)
  }
  
  # This does the summary. For each group's data frame, return a vector with
  # N, mean, and sd
  datac <- ddply(data, groupvars, .drop=.drop,
                 .fun = function(xx, col) {
                   c(N    = length2(xx[[col]], na.rm=na.rm),
                     mean = mean   (xx[[col]], na.rm=na.rm),
                     sd   = sd     (xx[[col]], na.rm=na.rm)
                   )
                 },
                 measurevar
  )
  
  # Rename the "mean" column    
  datac <- rename(datac, c("mean" = measurevar))
  
  datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean
  
  # Confidence interval multiplier for standard error
  # Calculate t-statistic for confidence interval: 
  # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
  ciMult <- qt(conf.interval/2 + .5, datac$N-1)
  datac$ci <- datac$se * ciMult
  
  return(datac)
}
```


# Data preparation

Load data, keep variables needed and merge

```{r Load data}
data_selag<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata_weather_subs.csv",header=T,sep="\t",dec=".") 
mean_weather<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/mean_weather.csv",header=T,sep="\t",dec=".")
```

```{r Keep vars}
data_selag<-data_selag[c(1:7,9:10,12,14:15,17:18,21,22)]
data_selag$n_fl<-data_selag$cum_n_fl
data_selag$cum_n_fl<-NULL
mean_weather<-mean_weather[c(1,115:118)]
data_selag<-merge(data_selag,mean_weather,by="year")%>%
  arrange(id)%>%
  anti_join(subset(data_selag,is.na(FFD)&is.na(grazing)&
                     is.na(shoot_vol)&is.na(n_fr)&is.na(n_ovules)&
                     is.na(n_seeds)&is.na(n_intact_seeds)&
                     is.na(n_fl)))%>% # Remove rows with all these NAs
  filter(year!=1995) # Remove data from 1995 because of problems with predation
names(data_selag)
head(data_selag)
```

List of variables in data set:

- year
- FFD: first flowering date (as number of days from vernal equinox)
- id: individual identifier (including "old" for individuals in period 1987-1996 and "new" for individuals in period 2006-2017)
- ruta, genet: identifiers for plots and ids in old data
- data: 1 if data available, 0 if not
- vernal: date of vernal equinox in each year
- grazing: proportion of grazing by deer
- shoot_vol: shoot volume
- n_fr: number of fruits
- n_ovules: number of ovules
- FFD_corr: first flowering date (as a date)
- period: "old" for 1987-1996 and "new" for 2006-2017
- n_seeds: number of seeds
- n_intact_seeds: number of intact (non-predated) seeds
- n_fl: number of flowers
- mean_3/4/5/6: average of daily mean temperatures for March/April/May/June

Interactions that we will focus on:

- Seed predation: proportion of seeds escaping predation
- Grazing (by deer) before flowering: proportion of grazing

Calculate proportion of predated seeds

```{r calc interactions}
data_selag<-data_selag%>%
  mutate(prop_pred_seeds=ifelse(n_seeds==0,NA,(n_seeds-n_intact_seeds)/n_seeds),
         n_pred_seeds=n_seeds-n_intact_seeds)
```

Using only mean temperatures. Using grazing as a proportion, and for 2008-2015 use values of proportion of aboveground volume. 
- 1987-1996: grazing = proportion of flowers removed
- 2006: grazing = proportion of grazed shoots
- 2007-2015: grazing = proportion of aboveground volume removed
- 2016-2017: grazing = proportion of flowers removed

```{r message=FALSE, warning=FALSE, include=FALSE}
grazing_new<-read.table("data/grazing_new.csv",
                        header=T,sep=",",dec=".") 
data_selag<-left_join(data_selag,grazing_new)%>%
  mutate(grazing_corr=ifelse(is.na(grazing_new),grazing,grazing_new))
```

Calculate successes/failures for grazing (and weights)

```{r}
data_selag$grazing_success<-round(with(data_selag,
                                       ifelse(is.na(grazing_corr),NA,
                                              ifelse(year<1997|year>2015,
                                                     grazing_corr*n_fl,
                                                     ifelse(year>2006&year<2016,
                                                            grazing_corr*shoot_vol,
                                                            999)))))
data_selag$grazing_failure<-round(with(data_selag,
                                       ifelse(is.na(grazing_corr),NA,
                                              ifelse(year<1997|year>2015,
                                                     n_fl-grazing_success,
                                                     ifelse(year>2006&year<2016,
                                                            shoot_vol-grazing_success,
                                                                 999)))))
data_selag$grazing_weights<-round(with(data_selag,
                                       ifelse(is.na(grazing_corr),NA,
                                              ifelse(year<1997|year>2015,
                                                     n_fl,
                                                     ifelse(year>2006&year<2016,
                                                            shoot_vol,
                                                            999)))))

grazing_success_2006<-read.table("data/grazing_success_2006.csv",
                                 header=T,sep=",",dec=".")
grazing_success_2006<-grazing_success_2006%>%
  mutate(weights=gr_success+gr_failure)
data_selag<-data_selag%>%
  left_join(grazing_success_2006)
data_selag$grazing_success<-with(data_selag,
                                 ifelse(year==2006,gr_success,grazing_success))
data_selag$grazing_failure<-with(data_selag,
                                 ifelse(year==2006,gr_failure,grazing_failure))
data_selag$grazing_weights<-with(data_selag,
                                 ifelse(year==2006,weights,grazing_weights))
data_selag$gr_success<-NULL
data_selag$gr_failure<-NULL
data_selag$weights<-NULL
head(data_selag)
```

# Appendix S5: Raw relationships interactions ~ FFD in different years

# NOTE: Revise naming of appendices!

## Grazing

```{r echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
ggplot(subset(data_selag,year<2009),
       aes(x=FFD,y=grazing_success/(grazing_success+grazing_failure),
                      succ=grazing_success, fail=grazing_failure))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Grazing")+xlab("FFD")
ggsave(filename="output/figures/AppendixS5_1A.tiff",device="tiff",width=168,
       height=210,units="mm",dpi=300,compression="lzw")
ggplot(subset(data_selag,year>2008),
       aes(x=FFD,y=grazing_success/(grazing_success+grazing_failure),
                      succ=grazing_success, fail=grazing_failure))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Grazing")+xlab("FFD")
ggsave(filename="output/figures/AppendixS5_1B.tiff",device="tiff",width=168,
       height=158,units="mm",dpi=300,compression="lzw")
```

## Predation

```{r echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
ggplot(subset(data_selag,year<2009),
       aes(x=FFD,y=n_pred_seeds/(n_pred_seeds+n_intact_seeds),
                      succ=n_pred_seeds, fail=n_intact_seeds))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Seed predation")+xlab("FFD")
ggsave(filename="output/figures/AppendixS5_2A.tiff",device="tiff",width=168,
       height=210,units="mm",dpi=300,compression="lzw")
ggplot(subset(data_selag,year>2008),
       aes(x=FFD,y=n_pred_seeds/(n_pred_seeds+n_intact_seeds),
                      succ=n_pred_seeds, fail=n_intact_seeds))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Seed predation")+xlab("FFD")
ggsave(filename="output/figures/AppendixS5_2B.tiff",device="tiff",width=168,
       height=158,units="mm",dpi=300,compression="lzw")
```

# Path model H1 and H2

H1: Flowering phenology of individuals influences the intensities of interactions with seed predators and grazers.

H2: These biotic interactions have important effects on fitness, and alter selection on flowering time within years. 

Models include the effects of FFD and n_fl standardized within years (FFD_s_y and n_fl_s_y), grazing and seed predation on fitness relativized within years (fitness_rel_y), as well as the effects of FFD_s_y and n_fl_s_y on grazing and seed predation.  

Calculate FFD_s_y, n_fl_s_y and fitness_rel_y:

```{r}
data_selag<-data_selag%>% 
  group_by(year) %>% 
  mutate(FFD_mean=mean(FFD,na.rm=T),
         FFD_sd=sd(FFD,na.rm=T),
         FFD_s_y=(FFD-FFD_mean)/FFD_sd,
         n_fl_mean=mean(n_fl,na.rm=T),
         n_fl_sd=sd(n_fl,na.rm=T),
         n_fl_s_y=(n_fl-n_fl_mean)/n_fl_sd,
         fitness_mean=mean(n_intact_seeds,na.rm=T),
         fitness_rel_y=n_intact_seeds/fitness_mean)
```

```{r}
data_selag$seeds_01<-with(data_selag,ifelse(is.na(n_seeds),NA,
                                              ifelse(n_seeds>0,1,0)))
```


```{r message=FALSE, warning=FALSE}
path1_mod1<-glmer(seeds_01~FFD_s_y+n_fl_s_y+grazing_corr+(1|id),
                data=data_selag,family="binomial")
path1_mod2<-lmer(fitness_rel_y~FFD_s_y+n_fl_s_y+grazing_corr+prop_pred_seeds+(1|id),
               data=data_selag)
path1_mod3<-glmer(grazing_corr~FFD_s_y+n_fl_s_y+(1|id),
                  data=data_selag,family="binomial",weights=grazing_weights)
path1_mod4<-glmer(prop_pred_seeds~FFD_s_y+n_fl_s_y+(1|id),
                  data=data_selag,family="binomial",
                  weights=n_seeds)
```

```{r}
nobs(path1_mod1)
nobs(path1_mod2)
nobs(path1_mod3)
nobs(path1_mod4)
```
```{r message=FALSE, warning=FALSE}
path1<-psem(path1_mod1,path1_mod2,path1_mod3,path1_mod4)
coefs(path1) 
plot(path1,show="unstd") 
```

piecewiseSEM does not give standardized effects for binomial GLMMs --> we could take the missing standardized effects from models without the random effects.

```{r message=FALSE, warning=FALSE}
path1_mod3_glmmTMB<-glmmTMB(grazing_corr~FFD_s_y+n_fl_s_y+(1|id),
                            data=data_selag,family="binomial",
                            weights=grazing_weights)
path1_mod4_glmmTMB<-glmmTMB(prop_pred_seeds~FFD_s_y+n_fl_s_y+(1|id),
                            data=data_selag,family="binomial",
                            weights=round(n_seeds))
# Using glmmTMB cause using glmer gave error in DHARMa, results are similar
# Also needs round() to avoid errors in DHARMa
```

Model diagnostics with DHARMa
 
```{r message=FALSE, warning=FALSE}
sim_path1_mod1 <- simulateResiduals(fittedModel = path1_mod1, n = 5000) 
sim_path1_mod2 <- simulateResiduals(fittedModel = path1_mod2, n = 5000) 
sim_path1_mod3 <- simulateResiduals(fittedModel = path1_mod3_glmmTMB, n = 5000) 
sim_path1_mod4 <- simulateResiduals(fittedModel = path1_mod4_glmmTMB, n = 5000) 
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_path1_mod1,quantreg=T) # model OK
plot(sim_path1_mod2,quantreg=T) # not OK - calculate BCA intervals
plot(sim_path1_mod3,quantreg=T) # not OK 
plot(sim_path1_mod4,quantreg=T) # not OK
```

```{r}
testDispersion(sim_path1_mod3) # underdispersed
testDispersion(sim_path1_mod4) # overdispersed
```

Refit models 3 and 4 with betabinomial distribution.

```{r message=FALSE, warning=FALSE}
path1_mod3_bb<-glmmTMB(grazing_corr~FFD_s_y+n_fl_s_y+(1|id),
                            data=data_selag,family="betabinomial",
                            weights=grazing_weights)
path1_mod4_bb<-glmmTMB(prop_pred_seeds~FFD_s_y+n_fl_s_y+(1|id),
                            data=data_selag,family="betabinomial",
                            weights=round(n_seeds))
```

Model diagnostics with DHARMa
 
```{r message=FALSE, warning=FALSE}
sim_path1_mod3_bb <- simulateResiduals(fittedModel = path1_mod3_bb, n = 5000) 
sim_path1_mod4_bb <- simulateResiduals(fittedModel = path1_mod4_bb, n = 5000) 
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_path1_mod3_bb,quantreg=T) # not OK 
plot(sim_path1_mod4_bb,quantreg=T) # not OK
```

KS test being significant is probably not a problem.

From https://github.com/florianhartig/DHARMa/issues/181

"the p-value shows you that there is a significant deviation from the assumed distribution, but significance != effect size. In other words, if you have a large number of data points (as you have here), even the slightest deviation will become significant. [...] the qq-plot is nearly linear, suggesting that the overall distribution is roughly OK.

```{r}
testDispersion(sim_path1_mod3_bb) # still a bit of underdispersion probably OK
testDispersion(sim_path1_mod4_bb) # no overdispersion
```

Plot residuals against the predictors in the model

```{r}
par(mfrow=c(2,2))
plotResiduals(sim_path1_mod3_bb,
              subset(data_selag,!is.na(FFD_s_y)&!is.na(n_fl_s_y)&
                       !is.na(grazing_corr)&!is.na(grazing_weights))$FFD_s_y,
              main="Residuals vs FFD_s_y",quantreg = T)
plotResiduals(sim_path1_mod3_bb,
              subset(data_selag,!is.na(FFD_s_y)&!is.na(n_fl_s_y)&
                       !is.na(grazing_corr)&!is.na(grazing_weights))$n_fl_s_y,
              main="Residuals vs n_fl_s_y",quantreg = T)
plotResiduals(sim_path1_mod4_bb,
              subset(data_selag,!is.na(FFD_s_y)&!is.na(n_fl_s_y)&
                       !is.na(prop_pred_seeds)&!is.na(n_seeds))$FFD_s_y,
              main="Residuals vs FFD_s_y",quantreg = T)
plotResiduals(sim_path1_mod4_bb,
              subset(data_selag,!is.na(FFD_s_y)&!is.na(n_fl_s_y)&
                       !is.na(prop_pred_seeds)&!is.na(n_seeds))$n_fl_s_y,
              main="Residuals vs n_fl_s_y",quantreg = T)
```

They look OK (but keep an eye on FFD_s_y for mod4).

Tested quadratic effects of FFD on grazing and seed predation, and they were not significant in betabinomial models. 

Boostrapped confidence intervals for model 2:

```{r}
b_par<-bootMer(x=path1_mod2,FUN=fixef,nsim=10000)
```


```{r}
confint(b_par,level=0.95, method="boot") # Percentile method
```

Similar to significances in the lmer model.

For linear model without the random effect:

```{r}
path1_mod2_lm<-lm(fitness_rel_y~FFD_s_y+n_fl_s_y+grazing_corr+prop_pred_seeds,
               data=subset(data_selag,
                           !is.na(fitness_rel_y)&!is.na(FFD_s_y)&
                             !is.na(n_fl_s_y)&!is.na(grazing_corr)&
                             !is.na(prop_pred_seeds)))
```


```{r}
# FFD_s_y
slp <- function(path1_mod2_lm) coef(path1_mod2_lm)[2]
b <- car::Boot(path1_mod2_lm,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
FFD_s_y_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# n_fl_s_y
slp <- function(path1_mod2_lm) coef(path1_mod2_lm)[3]
b <- car::Boot(path1_mod2_lm,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
n_fl_s_y_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# grazing_corr
slp <- function(path1_mod2_lm) coef(path1_mod2_lm)[4]
b <- car::Boot(path1_mod2_lm,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
grazing_corr_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# prop_pred_seeds
slp <- function(path1_mod2_lm) coef(path1_mod2_lm)[5]
b <- car::Boot(path1_mod2_lm,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
prop_pred_seeds_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# Save confidence intervals as a table
lower_A <- rbind(FFD_s_y_ci[1,] ,n_fl_s_y_ci[1,])
lower_B <- rbind(lower_A ,grazing_corr_ci[1,])
lower_C <- rbind(lower_B ,prop_pred_seeds_ci[1,])
lower <- lower_C

upper_A <- rbind(FFD_s_y_ci[2,] ,n_fl_s_y_ci[2,])
upper_B <- rbind(upper_A ,grazing_corr_ci[2,])
upper_C <- rbind(upper_B ,prop_pred_seeds_ci[2,])
upper <- upper_C


BCIs_path1_mod2_lm <- cbind(lower, upper) 
rownames(BCIs_path1_mod2_lm) <- c("FFD_s_y","n_fl_s_y",
                                  "grazing_corr","prop_pred_seeds")
BCIs_path1_mod2_lm
```

Similar to significances in the lmer model (except for FFD_s_y where intervals overlap zero here). Maybe we can stay with the percentile intervals?

New model path1

```{r message=FALSE, warning=FALSE}
summary(path1_mod1)$coefficients 
# std coefs if needed from path1 without id
summary(path1_mod2)$coefficients 
# get significances from bootstrapped CIs, std coefs from path1 without id
summary(path1_mod3_bb)$coefficients 
# significances and ustd coefs from here, std if needed from path1 without id
summary(path1_mod4_bb)$coefficients 
# significances and ustd coefs from here, std if needed from path1 without id
```
piecewiseSEM does not work with glmmTMB - and that is the only package I found that fits betabinomial mixed models.

```{r message=FALSE, warning=FALSE}
path1_noid<-psem(
  glm(seeds_01~FFD_s_y+n_fl_s_y+grazing_corr,
                data=data_selag,family="binomial"),
  lm(fitness_rel_y~FFD_s_y+n_fl_s_y+grazing_corr+prop_pred_seeds,
               data=data_selag),
  glm(grazing_corr~FFD_s_y+n_fl_s_y,
                  data=data_selag,family="binomial",weights=grazing_weights),
  glm(prop_pred_seeds~FFD_s_y+n_fl_s_y,
                  data=data_selag,family="binomial",
                  weights=n_seeds))
coefs(path1_noid) 
plot(path1_noid)
```

# Path model H3

H3: Variation in climatic conditions during spring among years causes differences in selection on flowering time, through effects mediated by the intensity of biotic interactions. Also direct effects of climate on selection.

Using FFD and n_fl standardized across years (FFD_s and n_fl_s), and fitness relativized across years (fitness_rel).

Calculate FFD_s, n_fl_s and fitness_rel:

```{r}
data_selag<-data_selag%>% 
  ungroup()%>%
  mutate(FFD_s=scale(FFD),
         n_fl_s=scale(n_fl),
         fitness_rel=n_intact_seeds/mean(n_intact_seeds,na.rm=T))
```

Component models path 3

```{r message=FALSE, warning=FALSE}
path2_mod1<-glmer(seeds_01~FFD_s+n_fl_s+grazing_corr+grazing_corr:FFD_s+
                    (1|id)+(1|year),data=data_selag,family="binomial")
path2_mod2<-lmer(fitness_rel~FFD_s+n_fl_s+grazing_corr+prop_pred_seeds+
                   FFD_s:grazing_corr+FFD_s:prop_pred_seeds+(1|id)+(1|year),
                 data=data_selag)
path2_mod3<-lmer(FFD_s~mean_3+mean_4+mean_5+(1|id),data_selag)
path2_mod4<-glmer(grazing_corr~mean_3+mean_4+mean_5+(1|id),
                  data=data_selag,family="binomial",weights=grazing_weights)
# random effect of year not needed - temperatures "are" year
path2_mod5<-glmer(prop_pred_seeds~mean_3+mean_4+mean_5+mean_6+(1|id),
                  data=data_selag,family="binomial",weights=n_seeds)
# random effect of year not needed - temperatures "are" year
# convergence problems in glmer but not in glmmTMB
```

```{r}
nobs(path2_mod1)
nobs(path2_mod2)
nobs(path2_mod3)
nobs(path2_mod4)
nobs(path2_mod5)
```

```{r message=FALSE, warning=FALSE}
path2_mod4_glmmTMB<-glmmTMB(grazing_corr~mean_3+mean_4+mean_5+(1|id),
                  data=data_selag,family="binomial",weights=grazing_weights)
path2_mod5_glmmTMB<-glmmTMB(prop_pred_seeds~mean_3+mean_4+mean_5+mean_6+(1|id),
                  data=data_selag,family="binomial",weights=round(n_seeds))
# Using glmmTMB cause using glmer gave error in DHARMa, results are similar
# Also needs round() to avoid errors in DHARMa
```

Model diagnostics with DHARMa
 
```{r message=FALSE, warning=FALSE}
sim_path2_mod1 <- simulateResiduals(fittedModel = path2_mod1, n = 5000) 
sim_path2_mod2 <- simulateResiduals(fittedModel = path2_mod2, n = 5000) 
sim_path2_mod3 <- simulateResiduals(fittedModel = path2_mod3, n = 5000) 
sim_path2_mod4 <- simulateResiduals(fittedModel = path2_mod4_glmmTMB, n = 5000) 
sim_path2_mod5 <- simulateResiduals(fittedModel = path2_mod5_glmmTMB, n = 5000) 
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_path2_mod1,quantreg=T) # close to OK
plot(sim_path2_mod2,quantreg=T) # not OK - calculate BCA intervals
plot(sim_path2_mod3,quantreg=T) # not OK - see what to do
# Add square terms?
# plot residuals against predictors?
plot(sim_path2_mod4,quantreg=T) # not OK - use betabinomial
plot(sim_path2_mod5,quantreg=T) # not OK - use betabinomial
```

```{r}
testDispersion(sim_path2_mod1) # a bit overdispersed
testDispersion(sim_path2_mod4)
testDispersion(sim_path2_mod4,alternative="less") # slightly underdispersed
testDispersion(sim_path2_mod5) # a bit overdispersed
```

Plot residuals against the predictors in the model

```{r}
par(mfrow=c(1,3))
plotResiduals(sim_path2_mod3,
              subset(data_selag,!is.na(FFD_s))$mean_3,
              main="Residuals vs mean_3",quantreg = T)
plotResiduals(sim_path2_mod3,
              subset(data_selag,!is.na(FFD_s))$mean_4,
              main="Residuals vs mean_4",quantreg = T)
plotResiduals(sim_path2_mod3,
              subset(data_selag,!is.na(FFD_s))$mean_5,
              main="Residuals vs mean_5",quantreg = T)

```

Refit models 1,4 and 5 with betabinomial distribution.

```{r message=FALSE, warning=FALSE}
path2_mod1_bb<-glmmTMB(seeds_01~FFD_s+n_fl_s+grazing_corr+grazing_corr:FFD_s+
                    (1|id)+(1|year),data=data_selag,family="betabinomial")
path2_mod4_bb<-glmmTMB(grazing_corr~mean_3+mean_4+mean_5+(1|id),
                  data=data_selag,family="betabinomial",weights=grazing_weights)
path2_mod5_bb<-glmmTMB(prop_pred_seeds~mean_3+mean_4+mean_5+mean_6+(1|id),
                  data=data_selag,family="betabinomial",weights=round(n_seeds))
```

Model diagnostics with DHARMa
 
```{r message=FALSE, warning=FALSE}
sim_path2_mod1_bb <- simulateResiduals(fittedModel = path2_mod1_bb, n = 5000) 
sim_path2_mod4_bb <- simulateResiduals(fittedModel = path2_mod4_bb, n = 5000) 
sim_path2_mod5_bb <- simulateResiduals(fittedModel = path2_mod5_bb, n = 5000) 
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_path2_mod1_bb,quantreg=T) # 
plot(sim_path2_mod4_bb,quantreg=T) # 
plot(sim_path2_mod5_bb,quantreg=T) # 
```

These should be OK.

Calculate bootstrapped CIs for models 2 and 3.

Boostrapped confidence intervals for model 2:

```{r}
b_par<-bootMer(x=path2_mod2,FUN=fixef,nsim=10000)
```


```{r}
confint(b_par,level=0.95, method="boot") # Percentile method
```

Similar to significances in the lmer model.

Boostrapped confidence intervals for model 3:

```{r}
b_par<-bootMer(x=path2_mod2,FUN=fixef,nsim=10000)
```


```{r}
confint(b_par,level=0.95, method="boot") # Percentile method
```

Similar to significances in the lmer model.

See if we calculate also BCA intervals for linear models without random effects.

New model path2

```{r message=FALSE, warning=FALSE}
summary(glmmTMB(seeds_01~FFD_s+n_fl_s+grazing_corr+grazing_corr:FFD_s+
                    (1|id)+(1|year),data=data_selag,family="betabinomial"))
# std coefs if needed from path2 without id and year
summary(lmer(fitness_rel~FFD_s+n_fl_s+grazing_corr+prop_pred_seeds+
                   FFD_s:grazing_corr+FFD_s:prop_pred_seeds+(1|id)+(1|year),
                 data=data_selag))
# get significances from bootstrapped CIs, std coefs from path2 without id and year
summary(lmer(FFD_s~mean_3+mean_4+mean_5+(1|id),data_selag))
# get significances from bootstrapped CIs, std coefs from path2 without id and year
summary(glmmTMB(grazing_corr~mean_3+mean_4+mean_5+(1|id),
                  data=data_selag,family="betabinomial",weights=grazing_weights))
# significances and ustd coefs from here, std if needed from path2 without id
summary(glmmTMB(prop_pred_seeds~mean_3+mean_4+mean_5+mean_6+(1|id),
                  data=data_selag,family="betabinomial",weights=round(n_seeds)))
# significances and ustd coefs from here, std if needed from path2 without id
```




# OLD STUFF BELOW HERE

# 2. Models for each interaction

Including the effects of FFD standardized within years (FFD_s_y), yearly mean of FFD (FFD_mean), yearly standard deviation of FFD (FFD_sd), and the interactions FFD_s_y:FFD_mean andn FFD_s_y:FFD_sd.

Calculate FFD_s_y, FFD_mean and FFD_sd:

```{r}
data_selag<-data_selag%>% 
  dplyr::group_by(year) %>% 
  dplyr::mutate(FFD_mean=mean(FFD,na.rm=T),
         FFD_sd=sd(FFD,na.rm=T),
         FFD_s_y=(FFD-FFD_mean)/FFD_sd)
```

## Grazing

### Global models

```{r message=FALSE, warning=FALSE}
data_selag_subset1<-subset(data_selag,!is.na(grazing_success)&!is.na(FFD)&!is.na(n_fl))
globmod_grazing_A<-glmer(cbind(grazing_success,grazing_failure)~
                           (scale(mean_3)+scale(mean_4)+scale(mean_5))*FFD_s_y+
                           scale(n_fl)+(1|id),
                         data = data_selag_subset1,family="binomial",na.action="na.fail")
globmod_grazing_B<-glmer(cbind(grazing_success,grazing_failure)~
                           scale(n_fl)+FFD_s_y*(scale(FFD_mean)+scale(FFD_sd))+(1|id),
                         data = data_selag_subset1,family="binomial",na.action="na.fail")
# Summary: failed to converge
overdisp_fun(globmod_grazing_A)
overdisp_fun(globmod_grazing_B)
```

Significant overdispersion

### Rerun with beta binomial distribution in glmmTMB

```{r message=FALSE, warning=FALSE}
data_selag_subset1$id_factor<-as.factor(data_selag_subset1$id)
globmod_grazing1_A<-glmmTMB(cbind(grazing_success,grazing_failure)~
                            (scale(mean_3)+scale(mean_4)+scale(mean_5))*FFD_s_y+
                           scale(n_fl)+(1|id_factor),
                          data=data_selag_subset1,family=betabinomial,na.action="na.fail")
globmod_grazing1_B<-glmmTMB(cbind(grazing_success,grazing_failure)~
                            scale(n_fl)+FFD_s_y*(scale(FFD_mean)+scale(FFD_sd))+(1|id_factor),
                          data=data_selag_subset1,family=betabinomial,na.action="na.fail")
kable(summary(globmod_grazing1_A)$coefficients,digits=c(3,3,2,3))
kable(summary(globmod_grazing1_B)$coefficients,digits=c(3,3,2,3))
```

#### Collinearity

Check for collinearity with variance inflation factors:

```{r}
check_collinearity(globmod_grazing1_A) # OK, all below 2
check_collinearity(globmod_grazing1_B) # OK, all below 2
```


#### Model diagnostics with DHARMa

From: https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html

The ‘DHARMa’ package uses a simulation-based approach to create readily interpretable scaled (quantile) residuals for fitted (generalized) linear mixed models. 

The ‘DHARMa’ package creates readily interpretable residuals for generalized linear (mixed) models that are standardized to values between 0 and 1, and that can be interpreted as intuitively as residuals for the linear model. This is achieved by a simulation-based approach, similar to the Bayesian p-value or the parametric bootstrap, that transforms the residuals to a standardized scale. The basic steps are:

1. Simulate new data from the fitted model for each observation.

2.  each observation, calculate the empirical cumulative density function for the simulated observations, which describes the possible values (and their probability) at the predictor combination of the observed value, assuming the fitted model is correct.

3. The residual is then defined as the value of the empirical density function at the value of the observed data, so a residual of 0 means that all simulated values are larger than the observed value, and a residual of 0.5 means half of the simulated values are larger than the observed value.

The key advantage of this definition is that the so-defined residuals always have the same, known distribution, independent of the model that is fit, if the model is correctly specified. To see this, note that, if the observed data was created from the same data-generating process that we simulate from, all values of the cumulative distribution should appear with equal probability. That means we expect the distribution of the residuals to be flat, regardless of the model structure (Poisson, binomial, random effects and so on).

For a correctly specified model we would expect a uniform (flat) distribution of the overall residuals, and uniformity in y direction if we plot against any predictor.

Simulate residuals of the model:

```{r}
simulationOutput_globmod_grazing1_A <- 
  simulateResiduals(fittedModel=globmod_grazing1_A,n=5000)
simulationOutput_globmod_grazing1_B <-
  simulateResiduals(fittedModel=globmod_grazing1_B,n=5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(simulationOutput_globmod_grazing1_A)
plot(simulationOutput_globmod_grazing1_B)
```

Test of dispersion is significant --> what does this mean?

```{r}
testDispersion(simulationOutput_globmod_grazing1_A)
testDispersion(simulationOutput_globmod_grazing1_A,alternative="greater",plot=F) # Overdispersion
testDispersion(simulationOutput_globmod_grazing1_A,alternative="less",plot=F) # Underdispersion
testDispersion(simulationOutput_globmod_grazing1_B)
testDispersion(simulationOutput_globmod_grazing1_B,alternative="greater",plot=F) 
testDispersion(simulationOutput_globmod_grazing1_B,alternative="less",plot=F) 
```

The test shows that there is underdispersion. However, according to https://stats.stackexchange.com/questions/396336/r-glmm-for-unbalanced-zero-inflated-data-glmmtmb, when fitting GLMMs with variable dispersion, zero-inflation often shows up as underdispersion, so the most reliable test is usually to run a model selection with ZIP against standard model.

Zero inflation test is not significant:

```{r}
testZeroInflation(simulationOutput_globmod_grazing1_A)
testZeroInflation(simulationOutput_globmod_grazing1_B)
```

Plot the residuals against other predictors:

```{r}
par(mfrow=c(2,2))
plotResiduals(simulationOutput_globmod_grazing1_A, scale(data_selag_subset1$mean_3))
plotResiduals(simulationOutput_globmod_grazing1_A, scale(data_selag_subset1$mean_4))
plotResiduals(simulationOutput_globmod_grazing1_A, scale(data_selag_subset1$mean_5))
plotResiduals(simulationOutput_globmod_grazing1_A, scale(data_selag_subset1$n_fl))
plotResiduals(simulationOutput_globmod_grazing1_A, scale(data_selag_subset1$FFD_s_y))
plotResiduals(simulationOutput_globmod_grazing1_B, scale(data_selag_subset1$n_fl))
plotResiduals(simulationOutput_globmod_grazing1_B, scale(data_selag_subset1$FFD_s_y))
plotResiduals(simulationOutput_globmod_grazing1_B, scale(data_selag_subset1$FFD_mean))
plotResiduals(simulationOutput_globmod_grazing1_B, scale(data_selag_subset1$FFD_sd))
```

Histogram of the residuals:

```{r}
hist(simulationOutput_globmod_grazing1_A)
hist(simulationOutput_globmod_grazing1_B)
```

Seems OK, with no outliers.

Goodness-of-fit tests on the simulated residuals:

testUniformity() - tests if the overall distribution conforms to expectations
testOutliers() - tests if there are more simulation outliers than expected
testDispersion() - tests if the simulated dispersion is equal to the observed dispersion

```{r}
testResiduals(simulationOutput_globmod_grazing1_A)
testResiduals(simulationOutput_globmod_grazing1_B)
```

The simulated dispersion is not equal to the observed dispersion.

Using glmmTMB, we cannot perform model selection using dredge or use piecewiseSEM.

## Proportion of predated seeds

### Global models

```{r message=FALSE, warning=FALSE}
data_selag_subset2<-subset(subset(data_selag,n_seeds>0),!is.na(n_intact_seeds)&
                             !is.na(n_fl)&!is.na(FFD))
globmod_pred_GLM_A<-glm(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                        (scale(mean_3)+scale(mean_4)+scale(mean_5)+scale(mean_6))*FFD_s_y+
                          scale(n_fl),data = data_selag_subset2,family="binomial",na.action="na.fail")
globmod_pred_GLM_B<-glm(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                        scale(n_fl)+FFD_s_y*(scale(FFD_mean)+scale(FFD_sd)),
                         data = data_selag_subset2,family="binomial",na.action="na.fail")
overdisp_fun(globmod_pred_GLM_A)
overdisp_fun(globmod_pred_GLM_B)
```

Significant overdispersion

### Rerun with beta binomial distribution in glmmTBM

```{r}
globmod_pred_GLM1_A<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                             (scale(mean_3)+scale(mean_4)+scale(mean_5)+scale(mean_6))*FFD_s_y+
                          scale(n_fl),
                          data=data_selag_subset2,family=betabinomial,na.action="na.fail")
globmod_pred_GLM1_B<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                             scale(n_fl)+FFD_s_y*(scale(FFD_mean)+scale(FFD_sd)),
                           data=data_selag_subset2,family=betabinomial,na.action="na.fail")
kable(summary(globmod_pred_GLM1_A)$coefficients,digits=c(3,3,2,3))
kable(summary(globmod_pred_GLM1_B)$coefficients,digits=c(3,3,2,3))
```

#### Collinearity

Check for collinearity with variance inflation factors:

```{r}
check_collinearity(globmod_pred_GLM1_A) # OK, all below 2
check_collinearity(globmod_pred_GLM1_B) # OK, all below 2
```

#### Model diagnostics with DHARMa

Simulate residuals of the model:

```{r}
simulationOutput_globmod_pred_GLM1_A <- 
  simulateResiduals(fittedModel = globmod_pred_GLM1_A, n = 5000)
simulationOutput_globmod_pred_GLM1_B <- 
  simulateResiduals(fittedModel = globmod_pred_GLM1_B, n = 5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(simulationOutput_globmod_pred_GLM1_A)
plot(simulationOutput_globmod_pred_GLM1_B)
# Both are good!
```

There seems to be heteroscedasticity. According to https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html, this means that there is a systematic dependency of the dispersion / variance on another variable in the model. It is not sufficiently appreciated that also binomial or Poisson models can show heteroscedasticity. Basically, it means that the level of over/underdispersion depends on another parameter. 

Maybe we can live with this?

```{r}
testDispersion(simulationOutput_globmod_pred_GLM1_A)
testDispersion(simulationOutput_globmod_pred_GLM1_A,alternative="greater",
               plot=F) # Overdispersion
testDispersion(simulationOutput_globmod_pred_GLM1_A,alternative="less",
               plot=F) # Underdispersion
testDispersion(simulationOutput_globmod_pred_GLM1_B)
testDispersion(simulationOutput_globmod_pred_GLM1_B,alternative="greater",
               plot=F) # Overdispersion
testDispersion(simulationOutput_globmod_pred_GLM1_B,alternative="less",
               plot=F) # Underdispersion
```

Zero inflation test is significant:

```{r}
testZeroInflation(simulationOutput_globmod_pred_GLM1_A)
testZeroInflation(simulationOutput_globmod_pred_GLM1_B)
```

There is a slight zero-inflation.

Plot the residuals against other predictors:

```{r}
par(mfrow=c(2,2))
plotResiduals(simulationOutput_globmod_pred_GLM1_A, scale(data_selag_subset2$mean_3))
plotResiduals(simulationOutput_globmod_pred_GLM1_A, scale(data_selag_subset2$mean_4))
plotResiduals(simulationOutput_globmod_pred_GLM1_A, scale(data_selag_subset2$mean_5))
plotResiduals(simulationOutput_globmod_pred_GLM1_A, scale(data_selag_subset2$mean_6))
plotResiduals(simulationOutput_globmod_pred_GLM1_A, scale(data_selag_subset2$n_fl))
plotResiduals(simulationOutput_globmod_pred_GLM1_A, scale(data_selag_subset2$FFD_s_y))
plotResiduals(simulationOutput_globmod_pred_GLM1_B, scale(data_selag_subset2$n_fl))
plotResiduals(simulationOutput_globmod_pred_GLM1_B, scale(data_selag_subset2$FFD_s_y))
plotResiduals(simulationOutput_globmod_pred_GLM1_B, scale(data_selag_subset2$FFD_mean))
plotResiduals(simulationOutput_globmod_pred_GLM1_B, scale(data_selag_subset2$FFD_sd))
```

Histogram of the residuals:

```{r}
hist(simulationOutput_globmod_pred_GLM1_A)
hist(simulationOutput_globmod_pred_GLM1_B)
```

Seems OK, with no outliers.

Goodness-of-fit tests on the simulated residuals:

testUniformity() - tests if the overall distribution conforms to expectations
testOutliers() - tests if there are more simulation outliers than expected
testDispersion() - tests if the simulated dispersion is equal to the observed dispersion

```{r}
testResiduals(simulationOutput_globmod_pred_GLM1_A)
testResiduals(simulationOutput_globmod_pred_GLM1_B)
```

They seem OK.

## Number of seeds per flower

### Global model

```{r message=FALSE, warning=FALSE}
data_selag_subset3<-subset(data_selag,!is.na(n_seeds_per_fl)&!is.na(FFD))
globmod_seedsperfl_A<-glmmTMB(round(n_seeds_per_fl)~
                                (scale(mean_3)+scale(mean_4)+scale(mean_5))*FFD_s_y+
                                scale(n_fl)+scale(grazing_corr)+(1|id),
                              data = data_selag_subset3,family="poisson",na.action="na.fail")
globmod_seedsperfl_B<-glmmTMB(round(n_seeds_per_fl)~
                              scale(n_fl)+FFD_s_y*(scale(FFD_mean)+scale(FFD_sd))+
                              scale(grazing_corr)+(1|id),
                         data = data_selag_subset3,family="poisson",na.action="na.fail")
overdisp_fun(globmod_seedsperfl_A) # No overdispersion
overdisp_fun(globmod_seedsperfl_B) # No overdispersion
kable(summary(globmod_seedsperfl_A)$coefficients,digits=c(3,3,2,3))
kable(summary(globmod_seedsperfl_B)$coefficients,digits=c(3,3,2,3))
```

#### Collinearity

Check for collinearity with variance inflation factors:

```{r}
check_collinearity(globmod_seedsperfl_A) # OK, all below 2
check_collinearity(globmod_seedsperfl_B) # OK, all below 2
```

#### Model diagnostics with DHARMa

Simulate residuals of the model:

```{r}
simulationOutput_globmod_seedsperfl_A <- 
  simulateResiduals(fittedModel = globmod_seedsperfl_A, n = 5000)
simulationOutput_globmod_seedsperfl_B <- 
  simulateResiduals(fittedModel = globmod_seedsperfl_B, n = 5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(simulationOutput_globmod_seedsperfl_A) # Good!
plot(simulationOutput_globmod_seedsperfl_B) # Good!
```

```{r}
testDispersion(simulationOutput_globmod_seedsperfl_A)
testDispersion(simulationOutput_globmod_seedsperfl_A,alternative="greater",
               plot=F) # Overdispersion
testDispersion(simulationOutput_globmod_seedsperfl_A,alternative="less",
               plot=F) # Underdispersion
testDispersion(simulationOutput_globmod_seedsperfl_B)
testDispersion(simulationOutput_globmod_seedsperfl_B,alternative="greater",
               plot=F) # Overdispersion
testDispersion(simulationOutput_globmod_seedsperfl_B,alternative="less",
               plot=F) # Underdispersion
```

Zero inflation test is not significant:

```{r}
testZeroInflation(simulationOutput_globmod_seedsperfl_A)
testZeroInflation(simulationOutput_globmod_seedsperfl_B)
```

Plot the residuals against other predictors:

```{r}
par(mfrow=c(2,2))
plotResiduals(simulationOutput_globmod_seedsperfl_A, scale(data_selag_subset3$mean_3))
plotResiduals(simulationOutput_globmod_seedsperfl_A, scale(data_selag_subset3$mean_4))
plotResiduals(simulationOutput_globmod_seedsperfl_A, scale(data_selag_subset3$mean_5))
plotResiduals(simulationOutput_globmod_seedsperfl_A, scale(data_selag_subset3$n_fl))
plotResiduals(simulationOutput_globmod_seedsperfl_A, data_selag_subset3$FFD_s_y)
plotResiduals(simulationOutput_globmod_seedsperfl_A,
              scale(data_selag_subset3$grazing_corr))
plotResiduals(simulationOutput_globmod_seedsperfl_B, scale(data_selag_subset3$FFD_mean))
plotResiduals(simulationOutput_globmod_seedsperfl_B, scale(data_selag_subset3$FFD_sd))
plotResiduals(simulationOutput_globmod_seedsperfl_B, scale(data_selag_subset3$n_fl))
plotResiduals(simulationOutput_globmod_seedsperfl_B, data_selag_subset3$FFD_s_y)
plotResiduals(simulationOutput_globmod_seedsperfl_B,
              scale(data_selag_subset3$grazing_corr))
```

Histogram of the residuals:

```{r}
hist(simulationOutput_globmod_seedsperfl_A)
hist(simulationOutput_globmod_seedsperfl_B)
```

Goodness-of-fit tests on the simulated residuals:

testUniformity() - tests if the overall distribution conforms to expectations
testOutliers() - tests if there are more simulation outliers than expected
testDispersion() - tests if the simulated dispersion is equal to the observed dispersion

```{r}
testResiduals(simulationOutput_globmod_seedsperfl_A)
testResiduals(simulationOutput_globmod_seedsperfl_B)
```

## Graphs

Fit models with all non-scaled variables, but keep FFD_s_y. When FFD_s_y is significant, effects are taken from models with temperatures (i.e. "A" models).

```{r}
globmod_grazing1_A_ns<-glmmTMB(cbind(grazing_success,grazing_failure)~(mean_3+mean_4+mean_5)*FFD_s_y+
                                 n_fl+(1|id_factor),data=data_selag_subset1,
                               family=betabinomial,na.action="na.fail")
globmod_grazing1_B_ns<-glmmTMB(cbind(grazing_success,grazing_failure)~n_fl+FFD_s_y*(FFD_mean+FFD_sd)+
                              (1|id_factor),data=data_selag_subset1,
                              family=betabinomial,na.action="na.fail")
globmod_seedsperfl_A_ns<-glmmTMB(round(n_seeds_per_fl)~
                                (mean_3+mean_4+mean_5)*FFD_s_y+n_fl+grazing_corr+(1|id),
                              data = data_selag_subset3,family="poisson",na.action="na.fail")
globmod_seedsperfl_B_ns<-glmmTMB(round(n_seeds_per_fl)~
                              n_fl+FFD_s_y*(FFD_mean+FFD_sd)+grazing_corr+(1|id),
                         data = data_selag_subset3,family="poisson",na.action="na.fail")
globmod_pred_GLM1_A_ns<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                             (mean_3+mean_4+mean_5+mean_6)*FFD_s_y+n_fl,
                           data=data_selag_subset2,family=betabinomial,na.action="na.fail")
globmod_pred_GLM1_B_ns<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                             n_fl+FFD_s_y*(FFD_mean+FFD_sd),
                           data=data_selag_subset2,family=betabinomial,na.action="na.fail")
```

```{r echo=FALSE, fig.height=4, fig.width=12, message=FALSE, warning=FALSE}
# Fig. 1: Temperatures

fig1a<-grid.arrange(
  # Grazing <- Temperature March
ggpredict(globmod_grazing1_A_ns,terms = "mean_3 [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("A) Grazing")+
  my_theme()+xlab(NULL)+ylab(NULL)+
  theme(plot.title=element_text(hjust=0,vjust=1))+
  labs(subtitle = "March")+theme(plot.subtitle = element_text(hjust = 0.5,margin=margin(t=10,b=-20))),
# Grazing <- Temperature April
ggpredict(globmod_grazing1_A_ns,terms = "mean_4 [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("blank")+
  my_theme()+xlab(NULL)+ylab(NULL)+
  theme(plot.title=element_text(hjust=0,vjust=1,color="white"))+
  labs(subtitle = "April")+theme(plot.subtitle = element_text(hjust = 0.5,margin=margin(t=10,b=-20))),
# Grazing <- Temperature May
ggpredict(globmod_grazing1_A_ns,terms = "mean_5 [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("blank")+
  my_theme()+xlab(NULL)+ylab(NULL)+
  theme(plot.title=element_text(hjust=0,vjust=1,color="white"))+
  labs(subtitle = "May")+theme(plot.subtitle = element_text(hjust = 0.5,margin=margin(t=10,b=-20))),
ncol=3)

fig1b<-grid.arrange(
# N seeds per fl <- Temperature May
ggpredict(globmod_seedsperfl_A_ns,terms = "mean_5 [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("B) Number of seeds per flower")+
  my_theme()+xlab(NULL)+ylab(NULL)+
  theme(plot.title=element_text(hjust=0,vjust=1))+
  labs(subtitle = "May")+theme(plot.subtitle = element_text(hjust = 0.5,margin=margin(t=10,b=-20))),
# Blank plot
ggplot() + theme_void(),
# Blank plot
ggplot() + theme_void(),
ncol=3)

fig1c<-grid.arrange(
# Predation <- Temperature March
ggpredict(globmod_pred_GLM1_A_ns,terms = "mean_3 [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("C) Seed predation")+
  my_theme()+xlab(NULL)+ylab(NULL)+
  theme(plot.title=element_text(hjust=0,vjust=1))+
  labs(subtitle = "March")+theme(plot.subtitle = element_text(hjust = 0.5,margin=margin(t=10,b=-20))),
# Predation <- Temperature May
ggpredict(globmod_pred_GLM1_A_ns,terms = "mean_5 [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("blank")+
  my_theme()+xlab(NULL)+ylab(NULL)+
  theme(plot.title=element_text(hjust=0,vjust=1,color="white"))+
  labs(subtitle = "May")+theme(plot.subtitle = element_text(hjust = 0.5,margin=margin(t=10,b=-20))),
# Predation <- Temperature June
ggpredict(globmod_pred_GLM1_A_ns,terms = "mean_6 [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("blank")+
  my_theme()+xlab(NULL)+ylab(NULL)+
  theme(plot.title=element_text(hjust=0,vjust=1,color="white"))+
  labs(subtitle = "June")+theme(plot.subtitle = element_text(hjust = 0.5,margin=margin(t=10,b=-20))),
ncol=3)

fig1<-grid.arrange(fig1a,fig1b,fig1c,
                   nrow=3,
                   bottom=textGrob("Temperature (ºC)",
                                   gp=gpar(fontsize=20,fontfamily="serif")),
                   left=textGrob("Predicted interaction intensity",
                                 just="center",hjust=0.48,
                                 gp=gpar(fontsize=20,fontfamily="serif"),rot=90))
plot(fig1)
ggsave(filename=
          "output/figures/Figure_1.tiff",
        plot=fig1,device="tiff",width=30,height=27,units="cm",dpi=300,compression="lzw")
```

```{r echo=FALSE, fig.height=4, fig.width=12, message=FALSE, warning=FALSE}
# Fig. 2: Mean and SD of FFD
fig2<-grid.arrange(
  # N seeds per fl <- SD FFD
ggpredict(globmod_seedsperfl_B_ns,terms = "FFD_sd [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("A)")+
  my_theme()+xlab("Standard deviation of FFD")+
  ylab("Predicted number of\nseeds per flower")+
  theme(plot.title=element_text(hjust=-0.15,vjust=1)),
# Predation <- Mean FFD
ggpredict(globmod_pred_GLM1_B_ns,terms = "FFD_mean [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("B)")+
  my_theme()+xlab("Mean FFD")+ylab("Predicted seed predation")+
  theme(plot.title=element_text(hjust=-0.15,vjust=1)),
# Predation <- SD FFD
ggpredict(globmod_pred_GLM1_B_ns,terms = "FFD_sd [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("C)")+
  my_theme()+xlab("Standard deviation of FFD")+ylab("Predicted seed predation")+
  theme(plot.title=element_text(hjust=-0.15,vjust=1)),
ncol=3)
ggsave(filename=
          "output/figures/Figure_2.tiff",
        plot=fig2,device="tiff",width=30,height=9,units="cm",dpi=300,compression="lzw")
```

```{r echo=FALSE, fig.height=4, fig.width=12, message=FALSE, warning=FALSE}
# Fig. 3: Individual FFD
fig3<-grid.arrange(
  # Grazing <- Individual FFD
ggpredict(globmod_grazing1_A_ns,terms = "FFD_s_y [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("A)")+
  my_theme()+xlab(NULL)+ylab("Predicted grazing")+
  theme(plot.title=element_text(hjust=-0.15,vjust=1)),
ggpredict(globmod_seedsperfl_A_ns,terms = "FFD_s_y [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+ggtitle("B)")+
  my_theme()+xlab(NULL)+ylab("Predicted number of\nseeds per flower")+
  theme(plot.title=element_text(hjust=-0.15,vjust=1)),
# Predation <- Temperature April * FFD
ggpredict(globmod_pred_GLM1_A_ns,terms = c("FFD_s_y [all]","mean_4 [all]"))%>%
  ggplot(aes(x,predicted, ymin = conf.low, ymax = conf.high, colour = group, fill = group))+
  geom_line(aes(color=as.numeric(as.character(group))),size=0.6) + 
  scale_colour_gradientn(colours = myPalette(100)) +
  my_theme()+xlab(NULL)+ylab("Predicted seed predation")+
  theme(plot.title=element_text(hjust=-0.15,vjust=1))+ggtitle("C)")+
  theme(legend.justification=c(1.1,0.99),legend.position=c(1.1,0.99),
        legend.direction="horizontal")+labs(colour="April temperature")+
   guides(colour = guide_colourbar(title.position="top",title.hjust = 7,barheight=0.7))+
  theme(legend.background = element_rect(fill=alpha('blue', 0))),
ncol=3,bottom=textGrob("First flowering date",just="center",hjust=0.45,
                       gp=gpar(fontsize=16,fontfamily="serif")))
ggsave(filename=
          "output/figures/Figure_3.tiff",
        plot=fig3,device="tiff",width=30,height=9,units="cm",dpi=300,compression="lzw")
```

# 3. How the three interactions affect fitness

## Phenotypic selection model

Because grazing influences (decreases) the number of seeds per flower, we calculate residuals of number of seeds per flower on grazing to use in the model.


### Classic selection model (Gaussian)

In this model, we use: fitness relativized within years, FFD and n_fl standardized within years,interactions standardized accross years. Main effects of interactions are not included because fitness was relativized within years. 

N = 2376

```{r}
data_selag$n_seeds_per_fl_res<-with(data_selag,ifelse(is.na(n_seeds_per_fl),NA,
                                           residuals(lm(n_seeds_per_fl~grazing_corr,
                                               data=data_selag))))
data_selag_means<-data_selag%>%
  group_by(year)%>%
  dplyr::summarise(n_seeds_per_fl_mean=mean(n_seeds_per_fl,na.rm=T),
                   n_seeds_per_fl_res_mean=mean(n_seeds_per_fl_res,na.rm=T),
                   grazing_mean=mean(grazing_corr,na.rm=T),
                   prop_pred_seeds_mean=mean(prop_pred_seeds,na.rm=T),
                   n_fl_mean=mean(n_fl,na.rm=T),
                   n_fl_sd=sd(n_fl,na.rm=T),
                   n_intact_seeds_mean=mean(n_intact_seeds,na.rm=T))

data_selag<-data_selag%>%left_join(data_selag_means,by="year")
# Standardize interactions accross years
data_selag$n_seeds_per_fl_mean_s<-scale(data_selag$n_seeds_per_fl_mean)
data_selag$n_seeds_per_fl_res_mean_s<-scale(data_selag$n_seeds_per_fl_res_mean)
data_selag$grazing_mean_s<-scale(data_selag$grazing_mean)
data_selag$prop_pred_seeds_mean_s<-scale(data_selag$prop_pred_seeds_mean)

# Relativize fitness within years and standardize FFD and n_fl within years
data_selag$n_intact_seeds_rel_y<-with(data_selag,n_intact_seeds/n_intact_seeds_mean)
data_selag$FFD_s_y<-with(data_selag,(FFD-FFD_mean)/FFD_sd)
data_selag$n_fl_s_y<-with(data_selag,(n_fl-n_fl_mean)/n_fl_sd)
```

```{r}
mod_int_sel_GLMM<-glmmTMB(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y+
                         FFD_s_y:n_seeds_per_fl_res_mean_s+
                         FFD_s_y:grazing_mean_s+
                         FFD_s_y:prop_pred_seeds_mean_s+
                         (1|id),data_selag,family="gaussian")
mod_int_sel_GLMM<-lmer(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y+
                         FFD_s_y:n_seeds_per_fl_res_mean_s+
                         FFD_s_y:grazing_mean_s+
                         FFD_s_y:prop_pred_seeds_mean_s+
                         (1|id),data_selag)
mod_int_sel_LM<-lm(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y+
                         FFD_s_y:n_seeds_per_fl_res_mean_s+
                         FFD_s_y:grazing_mean_s+
                         FFD_s_y:prop_pred_seeds_mean_s,
                   subset(data_selag,!is.na(n_intact_seeds_rel_y)&!is.na(FFD_s_y)&!is.na(n_fl_s_y)&
                            !is.na(n_seeds_per_fl_res_mean_s)&!is.na(grazing_mean_s)&
                            !is.na(prop_pred_seeds_mean_s)))
# Results of models (t-tests)
kable(summary(mod_int_sel_GLMM)$coefficients,digits=c(3,3,1,2,3))
# Analysis of deviance (Wald chi‐square tests for GLMM)
kable(Anova(mod_int_sel_GLMM))
```

Significant effect of grazing on selection (but we have seen that the significance is driven by the year 2017).

#### Model diagnostics with DHARMa

Simulate residuals of the model:

```{r}
simulationOutput_mod_int_sel_GLMM <- 
  simulateResiduals(fittedModel = mod_int_sel_GLMM, n = 5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(simulationOutput_mod_int_sel_GLMM)
```

```{r}
testDispersion(simulationOutput_mod_int_sel_GLMM)
```

```{r}
testZeroInflation(simulationOutput_mod_int_sel_GLMM)
```

```{r}
hist(simulationOutput_mod_int_sel_GLMM)
```

```{r}
testResiduals(simulationOutput_mod_int_sel_GLMM)
```

#### Bootstraped confidence intervals

##### Mixed model

```{r}
b_par<-bootMer(x=mod_int_sel_GLMM,FUN=fixef,nsim=10000)
```


```{r}
confint(b_par,level=0.95, method="boot") # Percentile method
```

##### LM (Elsa's code)

```{r}
# FFD_s_y
slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[2]
b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
FFD_s_y_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# n_fl_s_y
slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[3]
b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
n_fl_s_y_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# FFD_s_y:n_seeds_per_fl_res_mean_s
slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[4]
b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
FFD_s_y_seedl_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# FFD_s_y:grazing_mean_s
slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[5]
b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
FFD_s_y_graz_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# prop_pred_seeds_mean_s
slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[6]
b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
b1 <- boot::boot.ci(b,type="bca")
FFD_s_y_pred_ci <- as.data.frame(b1$bca[1,4:5])
rm(slp, b, b1)
```

```{r}
# Save confidence intervals as a table
lower_A <- rbind(FFD_s_y_ci[1,] ,n_fl_s_y_ci[1,])
lower_B <- rbind(lower_A ,FFD_s_y_seedl_ci[1,])
lower_C <- rbind(lower_B ,FFD_s_y_graz_ci[1,])
lower_D <- rbind(lower_C ,FFD_s_y_pred_ci[1,])
lower <- lower_D

upper_A <- rbind(FFD_s_y_ci[2,] ,n_fl_s_y_ci[2,])
upper_B <- rbind(upper_A ,FFD_s_y_seedl_ci[2,])
upper_C <- rbind(upper_B ,FFD_s_y_graz_ci[2,])
upper_D <- rbind(upper_C ,FFD_s_y_pred_ci[2,])
upper <- upper_D


BCIs_mod_int_sel_LM <- cbind(lower, upper) 
rownames(BCIs_mod_int_sel_LM) <- c("FFD_s_y","n_fl_s_y","FFD_s_y:seedfl",
                                   "FFD_s_y:graz","FFD_s_y:pred")
```

### Negative binomial distribution with offset

```{r message=TRUE}
mod_int_sel_GLMM2<-glmmTMB(round(n_intact_seeds) ~ FFD_s_y+n_fl_s_y+
                  FFD_s_y:n_seeds_per_fl_res_mean_s+
                  FFD_s_y:grazing_mean_s+
                  FFD_s_y:prop_pred_seeds_mean_s+
                  (1|id),data_selag,family="nbinom2",offset=n_intact_seeds_mean)
# Results of models (t-tests)
kable(summary(mod_int_sel_GLMM2)$coefficients,digits=c(3,3,2,3))
# Analysis of deviance (Wald chi‐square tests for GLMM)
kable(Anova(mod_int_sel_GLMM2))
```


### Graphs of the interaction FFD:grazing 

Graph based on GLMMs with non-standardized interactions - to show real values of grazing in the color bar.

```{r echo=FALSE, fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
mod_int_sel_GLMM_nsints<-glmmTMB(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y+
               FFD_s_y:n_seeds_per_fl_res_mean+FFD_s_y:grazing_mean+FFD_s_y:prop_pred_seeds_mean+
                 (1|id),data_selag,family="gaussian")

ggpredict(mod_int_sel_GLMM_nsints,terms = c("FFD_s_y [all]","grazing_mean [0:0.8 by=.1]"))%>%
  ggplot(aes(x,predicted,colour=group,fill=group))+
  geom_line(aes(color=as.numeric(as.character(group))),size=0.6)+my_theme()+
  scale_colour_gradientn(colours = myPalette(100)) +
  theme(legend.position="right")+labs(colour="Grazing")+
  xlab("First flowering date")+ylab("Predicted number of intact seeds")
ggsave(filename=
          "output/figures/Figure_4.tiff",
        device="tiff",width=12,height=9,units="cm",dpi=300,compression="lzw")
```

The slope of the relationship among fitness and FFD is more positive in years with higher proportions of grazing → selection for later flowering in those years

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
mod_int_sel_GLMM_nsints2<-glmmTMB(round(n_intact_seeds) ~ FFD_s_y+n_fl_s_y+
                  FFD_s_y:n_seeds_per_fl_res_mean+FFD_s_y:grazing_mean+FFD_s_y:prop_pred_seeds_mean+
                  offset(n_intact_seeds_mean)+(1|id),data_selag,family="nbinom2")
fig4<-grid.arrange(
ggpredict(mod_int_sel_GLMM_nsints2,terms = c("FFD_s_y [all]","grazing_mean [quart]"))%>%
  ggplot(aes(x,predicted,colour=group,fill=group))+
  geom_line(aes(color=group),size=1)+my_theme()+ggtitle("A)")+
  theme(legend.justification=c(0.95,0.95),legend.position=c(0.95,0.95))+labs(colour="Grazing")+
  scale_color_manual(values=c("#d7191c","#fdae61","#ffffbf","#abdda4","#2b83ba"))+
  xlab("FFD (standardized within years)")+ylab(NULL),
ggpredict(mod_int_sel_GLMM_nsints2,terms = c("FFD_s_y [all]","prop_pred_seeds_mean [quart]"))%>%
  ggplot(aes(x,predicted,colour=group,fill=group))+
  geom_line(aes(color=group),size=1)+my_theme()+ggtitle("B)")+
  theme(legend.justification=c(0.95,0.95),legend.position=c(0.95,0.95))+labs(colour="Seed\npredation")+
  scale_color_manual(values=c("#d7191c","#fdae61","#ffffbf","#abdda4","#2b83ba"))+
  xlab("FFD (standardized within years)")+ylab(NULL),
ncol=2,left=textGrob("Predicted number of intact seeds",just="center",hjust=0.50,
                     gp=gpar(fontsize=16,fontfamily="serif"),rot = 90))
ggsave(filename=
          "output/figures/Figure_4_OLD.tiff",
        plot=fig4,device="tiff",width=260,height=120,units="mm",dpi=100,compression="lzw")
```


### Effects on selection gradients for each year

Calculation of selection gradients for each year

```{r}
selgrads_FFD<-data.frame(data_selag %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y, data = .)) %>% tidy(model))
selgrads_FFD$sig<-ifelse(selgrads_FFD$p.value<0.05,"*","") 
kable(subset(selgrads_FFD,term=="FFD_s_y"),digits=3)  #Linear selection gradients for FFD
#FFD * (selection for early flowering) in 1991,1992,1993,1994,2007,2010,2012,2014 (as in EL paper)
```

Plot selection gradients vs mean interactions

```{r echo=FALSE, fig.height=5, fig.width=18}
data_selag_means<-data_selag_means%>%
  left_join(subset(selgrads_FFD,term=="FFD_s_y")[c(1,3)])
grid.arrange(
  ggplot(data_selag_means,aes(x=n_seeds_per_fl_res_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean number of seeds per flower (residuals)"),
  ggplot(data_selag_means,aes(x=grazing_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean grazing"),
  ggplot(data_selag_means,aes(x=prop_pred_seeds_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean proportion of predated seeds"),
  ncol=3)
```

Models for effects of mean interactions on selection gradients

```{r}
kable(summary(lm(estimate~n_seeds_per_fl_res_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~grazing_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~prop_pred_seeds_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~n_seeds_per_fl_res_mean+grazing_mean+prop_pred_seeds_mean,
                 data_selag_means))$coefficients)
kable(summary(lm(estimate~n_seeds_per_fl_res_mean+grazing_mean+prop_pred_seeds_mean,
                 subset(data_selag_means,year<2017)))$coefficients)
```

No significant effects of yearly mean interactions on yearly selection gradients (but effect of grazing is ALMOST significant)

## Models of fitness vs. the three interactions 

```{r message=FALSE, warning=FALSE}
data_selag_subset4<-subset(data_selag,!is.na(n_intact_seeds)&!is.na(n_seeds_per_fl)&
                             !is.na(grazing_corr)&!is.na(n_fl)&!is.na(FFD_s_y))
data_selag_subset4$n_intact_seeds_pres<-with(data_selag_subset4,
                                             ifelse(is.na(n_intact_seeds),NA,
                                                    ifelse(n_intact_seeds>0,1,0)))

model_fitness_pres<-glmmTMB(n_intact_seeds_pres~scale(grazing_corr)+scale(n_seeds_per_fl)+
                              scale(n_fl)+FFD_s_y+(1|year)+ 
                              # Added random effect of year as suggested by Elsa
                              (1|id),data_selag_subset4,family="binomial") # Very small variance of id if including it as a random effect --> but include it still
# Coefs were very similar to those in GLM

model_fitness_count<-glmmTMB(round(n_intact_seeds)~scale(n_seeds_per_fl)+
                               scale(grazing_corr)+scale(prop_pred_seeds)+scale(n_fl)+
                               FFD_s_y+(1|year),
                             # Added random effect of year as suggested by Elsa
                             subset(data_selag_subset4,n_seeds>0),family="nbinom2")
# Not adding id as random effects because most ids with only one observation

nobs(model_fitness_pres) # All plants
nobs(model_fitness_count) # Plants with > 0 seeds

kable(summary(model_fitness_pres)$coefficients)
kable(summary(model_fitness_count)$coefficients)
```

#### Model diagnostics with DHARMa

Simulate residuals of the model:

```{r}
# simulationOutput_model_fitness_pres <- 
#     simulateResiduals(fittedModel = model_fitness_pres, n = 5000) # Error
simulationOutput_model_fitness_count <- 
   simulateResiduals(fittedModel = model_fitness_count, n = 5000) 
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(simulationOutput_model_fitness_count)
testResiduals(simulationOutput_model_fitness_count)
```

#### Graphs

```{r echo=FALSE, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
ggplot(data_selag_subset4,aes(x=grazing,y=n_intact_seeds_pres))+geom_point()+
  geom_smooth(method="glm",method.args = list(family = "binomial"),color="black")+my_theme()+
  xlab("Grazing")+ylab("Probability of producing intact seeds")

# Predicted probabilities from model with scaled vars
ggpredict(model_fitness_pres,terms = "grazing_corr [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+
  my_theme()+xlab("Grazing")+ylab("Predicted probability of producing seeds")

# Predicted probabilities from model with non-scaled vars
ggpredict(glmmTMB(n_intact_seeds_pres~grazing_corr+n_seeds_per_fl+
                    n_fl+FFD_s_y+(1|id),data_selag_subset4,family="binomial"),
          terms = "grazing_corr [all]")%>%
  ggplot(aes(x,predicted))+geom_ribbon(aes(ymin=conf.low,ymax=conf.high),fill="grey")+
  geom_line(color="black",size=1)+
  my_theme()+xlab("Grazing")+ylab("Predicted probability of producing seeds")

ggplot(data_selag_subset4,aes(x=n_seeds_per_fl,y=n_intact_seeds_pres))+geom_point()+
  geom_smooth(method="glm",method.args = list(family = "binomial"),color="black")+my_theme()+
  xlab("Number of seeds per flower")+ylab("Probability of producing intact seeds")

ggplot(data_selag_subset4,aes(x=n_seeds_per_fl,y=n_intact_seeds))+geom_point()+
  my_theme()+
  xlab("Number of seeds per flower")+ylab("Number of intact seeds")

ggplot(data_selag_subset4,aes(x=prop_pred_seeds,y=n_intact_seeds))+geom_point()+
  my_theme()+
  xlab("Proportion of predated seeds")+ylab("Number of intact seeds")
```

# Different grazing estimates

```{r message=FALSE, warning=FALSE}
data_selag$grazing_type<-with(data_selag,ifelse(year<1997|year>2015,"flowers",
                                                ifelse(year==2006,"shoots","volume")))
summary(lm(n_seeds_per_fl~grazing_corr*grazing_type,data_selag))
Anova(lm(n_seeds_per_fl~grazing_corr*grazing_type,data_selag))
summary(glm(n_seeds_per_fl~grazing_corr*grazing_type,data_selag,family=poisson))
Anova(glm(n_seeds_per_fl~grazing_corr*grazing_type,data_selag,family=poisson))
```

# Variation FFD mean, FFD SD, climatic Variables, and intensities of the three interactions among years.

## Values

```{r}
# FFD mean and SD
data_selag%>%
  dplyr::group_by(year)%>%
  dplyr::summarise(FFD_mean=mean(FFD,na.rm=T),
                   FFD_SD=sd(FFD,na.rm=T))%>%
  dplyr::summarise(FFD_mean_min=min(FFD_mean),
                   FFD_mean_max=max(FFD_mean),
                   FFD_mean_mean=mean(FFD_mean),
                   FFD_mean_sd=sd(FFD_mean),
                   FFD_SD_min=min(FFD_SD),
                   FFD_SD_max=max(FFD_SD),
                   FFD_SD_mean=mean(FFD_SD),
                   FFD_SD_sd=sd(FFD_SD))

# Temperatures
range(unique(data_selag$mean_3))
mean(unique(data_selag$mean_3))
sd(unique(data_selag$mean_3))
range(unique(data_selag$mean_4))
mean(unique(data_selag$mean_4))
sd(unique(data_selag$mean_4))
range(unique(data_selag$mean_5))
mean(unique(data_selag$mean_5))
sd(unique(data_selag$mean_5))
range(unique(data_selag$mean_6))
mean(unique(data_selag$mean_6))
sd(unique(data_selag$mean_6))

# Interactions
data_selag_means%>%
  dplyr::summarise(grazing_mean_min=min(grazing_mean),
                   grazing_mean_max=max(grazing_mean),
                   grazing_mean_mean=mean(grazing_mean),
                   grazing_mean_sd=sd(grazing_mean),
                   n_seeds_per_fl_mean_min=min(n_seeds_per_fl_mean),
                   n_seeds_per_fl_mean_max=max(n_seeds_per_fl_mean),
                   n_seeds_per_fl_mean_mean=mean(n_seeds_per_fl_mean),
                   n_seeds_per_fl_mean_sd=sd(n_seeds_per_fl_mean),
                   prop_pred_seeds_mean_min=min(prop_pred_seeds_mean),
                   prop_pred_seeds_mean_max=max(prop_pred_seeds_mean),
                   prop_pred_seeds_mean_mean=mean(prop_pred_seeds_mean),
                   prop_pred_seeds_mean_sd=sd(prop_pred_seeds_mean))
```

## Plots

Read weather data

```{r}
weather<-read.table("data/weather.csv",
                    header=T,sep="\t",dec=".") 
weather<-subset(subset(weather,year!=1995),year<1997|year>2005)
```

```{r fig.height=4, fig.width=12}
# FFD mean and SD
ggplot(summarySE(data_selag, measurevar="FFD", groupvars="year",na.rm=T),
       aes(x=factor(year),y=FFD))+geom_point(size=3)+
  geom_errorbar(aes(ymin=FFD-sd, ymax=FFD+sd), width=.3)+ geom_point(size=3)+
  xlab("Year")+ylab("First flowering date\n(days after vernal equinox)")+my_theme()
ggsave(filename="output/figures/AppendixS2_1.tiff",
       device="tiff",width=25,height=10,units="cm",dpi=300,compression="lzw")

# Temperatures
weather_all<-read.table("data/weather.csv",
                    header=T,sep="\t",dec=".") 

summarySE(subset(subset(weather_all,year>1986),
                 month==3|month==4|month==5|month==6), 
          measurevar="mean", groupvars=c("year","month"))%>%
  mutate(incl=factor(ifelse(year==1995,0,ifelse(year>1996&year<2006,0,1))))%>%
ggplot(aes(x=year, y=mean, colour=factor(month),ymin=mean-se, ymax=mean+se))+
  geom_errorbar(width=.3, position = position_dodge(width = 0.5))+
  geom_line(position = position_dodge(width = 0.5))+
  geom_point(aes(shape=incl),size=5,position = position_dodge(width = 0.5))+
  xlab("Year")+ylab("Mean daily temperature (ºC)")+
  my_theme_legend()+
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442"),
                    name="Month",labels=c("March","April","May","June"))+
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442"),
                     name="Month",labels=c("March","April","May","June"))+
  scale_shape_manual(values=c(21,19),guide = FALSE)+
  scale_x_continuous(breaks=seq(1987,2017,1))+
  theme(legend.position = c(0.93, 0.15))
ggsave(filename="output/figures/AppendixS2_2.tiff",
       device="tiff",width=350,height=190,units="mm",dpi=300,compression="lzw")
```

```{r fig.height=12, fig.width=12}
# Interactions
S2_3<-grid.arrange(
  ggplot(summarySE(data_selag,measurevar="grazing_corr",groupvars="year",na.rm=T),
         aes(x=factor(year),y=grazing_corr))+geom_point(size=3)+
    geom_errorbar(aes(ymin=grazing_corr-se,ymax=grazing_corr+se), width=.3)+
    xlab("Year")+ylab("Grazing")+my_theme()+ggtitle("A)"),
  ggplot(summarySE(data_selag,measurevar="n_seeds_per_fl",groupvars="year",na.rm=T),
         aes(x=factor(year),y=n_seeds_per_fl))+geom_point(size=3)+
    geom_errorbar(aes(ymin=n_seeds_per_fl-se,ymax=n_seeds_per_fl+se), width=.3)+
    xlab("Year")+ylab("Number of seeds per flower")+my_theme()+ggtitle("B)"),
  ggplot(summarySE(data_selag,measurevar="prop_pred_seeds",groupvars="year",na.rm=T),
         aes(x=factor(year),y=prop_pred_seeds))+geom_point(size=3)+
    geom_errorbar(aes(ymin=prop_pred_seeds-se,ymax=prop_pred_seeds+se), width=.3)+
    xlab("Year")+ylab("Seed predation")+my_theme()+ggtitle("C)"),
  ncol=1)
ggsave(filename="output/figures/AppendixS2_3.tiff",
       plot=S2_3,device="tiff",width=25,height=30,units="cm",dpi=300,compression="lzw")
```

# Correlation table predictors Table 2

```{r}
kable(cor(data_selag[c(16:20,29,32:34)],use="pairwise.complete.obs"),digits=3)
```

# Among-year variation in relationships among interaction intensities and FFD

```{r}
graz_FFD_yrs<-glmmTMB(cbind(grazing_success,grazing_failure)~FFD*as.factor(year)+(1|id),
                      data = data_selag,family=betabinomial)
Anova(graz_FFD_yrs)
```

```{r}
seedfl_FFD_yrs<-glmmTMB(round(n_seeds_per_fl)~FFD*as.factor(year)+(1|id),
                      data = data_selag,family=poisson)
Anova(seedfl_FFD_yrs)
```

```{r}
pred_FFD_yrs<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~FFD*as.factor(year),
                      data = subset(subset(data_selag,n_seeds>0),!is.na(n_intact_seeds)),
                      family=betabinomial)
Anova(pred_FFD_yrs)
```







