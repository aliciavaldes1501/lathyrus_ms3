---
title: "Lathyrus ms3: Selective agents"
output:
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 4
  editor_options:
    chunk_output_type: inline
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggthemes)
library(MuMIn)
library(knitr)
library(gridExtra)
library(lme4)
library(parallel)
library(lmerTest)
library(effects)
library(broom)
library(car)
library(grid)
library(RColorBrewer)
library(ggeffects)
library(piecewiseSEM)
library(glmmTMB)
library(DHARMa)
library(performance)
library(viridis)
library(ggforce)
```

```{r Define ggplot themes and palettes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
```

```{r function to check for overdispersion, include=FALSE}
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
```

```{r function summarySE, include=FALSE}
## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
  library(plyr)
  
  # New version of length which can handle NA's: if na.rm==T, don't count them
  length2 <- function (x, na.rm=FALSE) {
    if (na.rm) sum(!is.na(x))
    else       length(x)
  }
  
  # This does the summary. For each group's data frame, return a vector with
  # N, mean, and sd
  datac <- ddply(data, groupvars, .drop=.drop,
                 .fun = function(xx, col) {
                   c(N    = length2(xx[[col]], na.rm=na.rm),
                     mean = mean   (xx[[col]], na.rm=na.rm),
                     sd   = sd     (xx[[col]], na.rm=na.rm)
                   )
                 },
                 measurevar
  )
  
  # Rename the "mean" column    
  datac <- rename(datac, c("mean" = measurevar))
  
  datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean
  
  # Confidence interval multiplier for standard error
  # Calculate t-statistic for confidence interval: 
  # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
  ciMult <- qt(conf.interval/2 + .5, datac$N-1)
  datac$ci <- datac$se * ciMult
  
  return(datac)
}
```

```{r}
# Load previously saved large objects
load("output/b_par_1.RData")
load("output/b_par_2.RData")
```


# Data preparation

Load data, keep variables needed and merge

```{r Load data}
data_selag<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata_weather_subs.csv",header=T,sep="\t",dec=".") 
mean_weather<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/mean_weather.csv",header=T,sep="\t",dec=".")
```

```{r Keep vars}
data_selag<-data_selag[c(1:7,9:10,12,14:15,17:18,21,22)]
data_selag$n_fl<-data_selag$cum_n_fl
data_selag$cum_n_fl<-NULL
mean_weather<-mean_weather[c(1,115:118)]
data_selag<-merge(data_selag,mean_weather,by="year")%>%
  arrange(id)%>%
  anti_join(subset(data_selag,is.na(FFD)&is.na(grazing)&
                     is.na(shoot_vol)&is.na(n_fr)&is.na(n_ovules)&
                     is.na(n_seeds)&is.na(n_intact_seeds)&
                     is.na(n_fl)))%>% # Remove rows with all these NAs
  filter(year!=1995) # Remove data from 1995 because of problems with predation
names(data_selag)
head(data_selag)
```

List of variables in data set:

- year
- FFD: first flowering date (as number of days from vernal equinox)
- id: individual identifier (including "old" for individuals in period 1987-1996 and "new" for individuals in period 2006-2017)
- ruta, genet: identifiers for plots and ids in old data
- data: 1 if data available, 0 if not
- vernal: date of vernal equinox in each year
- grazing: proportion of grazing by deer
- shoot_vol: shoot volume
- n_fr: number of fruits
- n_ovules: number of ovules
- FFD_corr: first flowering date (as a date)
- period: "old" for 1987-1996 and "new" for 2006-2017
- n_seeds: number of seeds
- n_intact_seeds: number of intact (non-predated) seeds
- n_fl: number of flowers
- mean_3/4/5/6: average of daily mean temperatures for March/April/May/June

Interactions that we will focus on:

- Seed predation: proportion of seeds escaping predation
- Grazing (by deer) before flowering: proportion of grazing

Calculate proportion of predated seeds

```{r calc interactions}
data_selag<-data_selag%>%
  mutate(prop_pred_seeds=ifelse(n_seeds==0,NA,(n_seeds-n_intact_seeds)/n_seeds),
         n_pred_seeds=n_seeds-n_intact_seeds)
```

Using only mean temperatures. Using grazing as a proportion, and for 2008-2015 use values of proportion of aboveground volume. 
- 1987-1996: grazing = proportion of flowers removed
- 2006: grazing = proportion of grazed shoots
- 2007-2015: grazing = proportion of aboveground volume removed
- 2016-2017: grazing = proportion of flowers removed

```{r message=FALSE, warning=FALSE, include=FALSE}
grazing_new<-read.table("data/grazing_new.csv",
                        header=T,sep=",",dec=".") 
data_selag<-left_join(data_selag,grazing_new)%>%
  mutate(grazing_corr=ifelse(is.na(grazing_new),grazing,grazing_new))
```

Calculate successes/failures for grazing (and weights)

```{r}
data_selag$grazing_success<-round(with(data_selag,
                                       ifelse(is.na(grazing_corr),NA,
                                              ifelse(year<1997|year>2015,
                                                     grazing_corr*n_fl,
                                                     ifelse(year>2006&year<2016,
                                                            grazing_corr*shoot_vol,
                                                            999)))))
data_selag$grazing_failure<-round(with(data_selag,
                                       ifelse(is.na(grazing_corr),NA,
                                              ifelse(year<1997|year>2015,
                                                     n_fl-grazing_success,
                                                     ifelse(year>2006&year<2016,
                                                            shoot_vol-grazing_success,
                                                                 999)))))
data_selag$grazing_weights<-round(with(data_selag,
                                       ifelse(is.na(grazing_corr),NA,
                                              ifelse(year<1997|year>2015,
                                                     n_fl,
                                                     ifelse(year>2006&year<2016,
                                                            shoot_vol,
                                                            999)))))

grazing_success_2006<-read.table("data/grazing_success_2006.csv",
                                 header=T,sep=",",dec=".")
grazing_success_2006<-grazing_success_2006%>%
  mutate(weights=gr_success+gr_failure)
data_selag<-data_selag%>%
  left_join(grazing_success_2006)
data_selag$grazing_success<-with(data_selag,
                                 ifelse(year==2006,gr_success,grazing_success))
data_selag$grazing_failure<-with(data_selag,
                                 ifelse(year==2006,gr_failure,grazing_failure))
data_selag$grazing_weights<-with(data_selag,
                                 ifelse(year==2006,weights,grazing_weights))
data_selag$gr_success<-NULL
data_selag$gr_failure<-NULL
data_selag$weights<-NULL
head(data_selag)
```
# H1 and H2: path model

H1: Flowering phenology of individuals influences the intensities of interactions with seed predators and grazers.

H2: These biotic interactions have important effects on fitness, and alter selection on flowering time within years. 

Models include the effects of FFD and n_fl standardized within years (FFD_s_y and n_fl_s_y), grazing and seed predation on fitness relativized within years (fitness_rel_y), as well as the effects of FFD_s_y and n_fl_s_y on grazing and seed predation.  

Calculate FFD_s_y, n_fl_s_y and fitness_rel_y:

```{r}
data_selag<-data_selag%>% 
  group_by(year) %>% 
  mutate(FFD_mean=mean(FFD,na.rm=T),
         FFD_sd=sd(FFD,na.rm=T),
         FFD_s_y=(FFD-FFD_mean)/FFD_sd,
         n_fl_mean=mean(n_fl,na.rm=T),
         n_fl_sd=sd(n_fl,na.rm=T),
         n_fl_s_y=(n_fl-n_fl_mean)/n_fl_sd,
         fitness_mean=mean(n_intact_seeds,na.rm=T),
         fitness_rel_y=n_intact_seeds/fitness_mean)
```

```{r}
data_selag$seeds_01<-with(data_selag,ifelse(is.na(n_seeds),NA,
                                              ifelse(n_seeds>0,1,0)))
```


```{r message=FALSE, warning=FALSE}
path1_mod1<-glmmTMB(seeds_01~FFD_s_y+n_fl_s_y+grazing_corr+(1|id)+(1|year),
                data=data_selag,family="binomial")
path1_mod2<-glmmTMB(fitness_rel_y~FFD_s_y+n_fl_s_y+grazing_corr+prop_pred_seeds+
                   (1|id)+(1|year),data=data_selag)
path1_mod3<-glmmTMB(grazing_corr~FFD_s_y+n_fl_s_y+(1|id)+(1|year),
                  data=data_selag,family="binomial",weights=grazing_weights)
path1_mod4<-glmmTMB(prop_pred_seeds~FFD_s_y+n_fl_s_y+(1|id)+(1|year),
                  data=data_selag,family="binomial",
                  weights=round(n_seeds))
```

```{r}
nobs(path1_mod1)
nobs(path1_mod2)
nobs(path1_mod3)
nobs(path1_mod4)
```

## Model diagnostics
 
```{r message=FALSE, warning=FALSE}
sim_path1_mod1 <- simulateResiduals(fittedModel = path1_mod1, n = 5000) 
sim_path1_mod2 <- simulateResiduals(fittedModel = path1_mod2, n = 5000) 
sim_path1_mod3 <- simulateResiduals(fittedModel = path1_mod3, n = 5000) 
sim_path1_mod4 <- simulateResiduals(fittedModel = path1_mod4, n = 5000) 
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_path1_mod1,quantreg=T) # model OK
plot(sim_path1_mod2,quantreg=T) # not OK - calculate BCA intervals
plot(sim_path1_mod3,quantreg=T) # not OK 
plot(sim_path1_mod4,quantreg=T) # not OK
```

```{r}
testDispersion(sim_path1_mod3) # OK
testDispersion(sim_path1_mod4) # OK
```

```{r}
testZeroInflation(sim_path1_mod3) # significant
testZeroInflation(sim_path1_mod4) # significant
```

## Refit models 3 and 4 with betabinomial distribution.

```{r message=FALSE, warning=FALSE}
path1_mod3_bb<-glmmTMB(grazing_corr~FFD_s_y+n_fl_s_y+(1|id)+(1|year),
                            data=data_selag,family="betabinomial",
                            weights=grazing_weights)
path1_mod4_bb<-glmmTMB(prop_pred_seeds~FFD_s_y+n_fl_s_y+(1|id)+(1|year),
                            data=data_selag,family="betabinomial",
                            weights=round(n_seeds))
```

### Model diagnostics
 
```{r message=FALSE, warning=FALSE}
sim_path1_mod3_bb <- simulateResiduals(fittedModel = path1_mod3_bb, n = 5000) 
sim_path1_mod4_bb <- simulateResiduals(fittedModel = path1_mod4_bb, n = 5000) 
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_path1_mod3_bb,quantreg=T) # not OK 
plot(sim_path1_mod4_bb,quantreg=T) # not OK
```

KS test being significant is probably not a problem.

From https://github.com/florianhartig/DHARMa/issues/181

"the p-value shows you that there is a significant deviation from the assumed distribution, but significance != effect size. In other words, if you have a large number of data points (as you have here), even the slightest deviation will become significant. [...] the qq-plot is nearly linear, suggesting that the overall distribution is roughly OK.

```{r}
testDispersion(sim_path1_mod3_bb) # a bit of underdispersion, probably OK
testDispersion(sim_path1_mod4_bb) # OK
```

```{r}
testZeroInflation(sim_path1_mod3_bb) # OK
testZeroInflation(sim_path1_mod4_bb) # OK
```

```{r}
anova(path1_mod3,path1_mod3_bb)
anova(path1_mod4,path1_mod4_bb)
AIC(path1_mod3,path1_mod3_bb)
AIC(path1_mod4,path1_mod4_bb)
```

Use betabinomial models.

Tested quadratic effects of FFD on grazing and seed predation, and they were not significant in betabinomial models. 

## Boostrapped confidence intervals for model 2:

### Mixed model

```{r}
path1_mod2_glmer<-glmer(fitness_rel_y~FFD_s_y+n_fl_s_y+grazing_corr+
                          prop_pred_seeds+(1|id)+(1|year),data=data_selag)
# We need to use glmer for this
```


```{r eval=FALSE, include=FALSE}
b_par_1<-bootMer(x=path1_mod2_glmer,FUN=fixef,nsim=10000)
save(b_par_1,file="output/b_par_1.RData")
```


```{r}
confint(b_par_1,level=0.95, method="boot") # Percentile method
```

Similar to significances in the lmer model.

### LM (Elsa's code) (not used)

```{r eval=FALSE, include=FALSE}
# path1_mod2_LM<-lm(fitness_rel_y~FFD_s_y+n_fl_s_y+grazing_corr+
#                           prop_pred_seeds,
#                   data=subset(data_selag,!is.na(fitness_rel_y)&
#                                                   !is.na(FFD_s_y)&
#                                                   !is.na(n_fl_s_y)&
#                                                   !is.na(grazing_corr)&
#                                                   !is.na(prop_pred_seeds)))
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # FFD_s_y
# slp <- function(path1_mod2_LM) coef(path1_mod2_LM)[2]
# b <- car::Boot(path1_mod2_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# FFD_s_y_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # n_fl_s_y
# slp <- function(path1_mod2_LM) coef(path1_mod2_LM)[3]
# b <- car::Boot(path1_mod2_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# n_fl_s_y_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # grazing_corr
# slp <- function(path1_mod2_LM) coef(path1_mod2_LM)[4]
# b <- car::Boot(path1_mod2_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# grazing_corr_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # prop_pred_seeds
# slp <- function(path1_mod2_LM) coef(path1_mod2_LM)[5]
# b <- car::Boot(path1_mod2_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# prop_pred_seeds_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # Save confidence intervals as a table
# lower_A <- rbind(FFD_s_y_ci[1,] ,n_fl_s_y_ci[1,])
# lower_B <- rbind(lower_A ,grazing_corr_ci[1,])
# lower_C <- rbind(lower_B ,prop_pred_seeds_ci[1,])
# lower <- lower_C
# 
# upper_A <- rbind(FFD_s_y_ci[2,] ,n_fl_s_y_ci[2,])
# upper_B <- rbind(upper_A ,grazing_corr_ci[2,])
# upper_C <- rbind(upper_B ,prop_pred_seeds_ci[2,])
# upper <- upper_C
# 
# BCIs_path1_mod2_LM <- cbind(lower, upper) 
# rownames(BCIs_path1_mod2_LM) <- c("FFD_s_y","n_fl_s_y",
#                                    "grazing_corr","prop_pred_seeds")
# BCIs_path1_mod2_LM
```

Similar to significances in the lmer model except for grazing, where the CIs overlap zero here. Use only percentile method?

## New path  model

```{r message=FALSE, warning=FALSE}
summary(path1_mod1)$coefficients 
# std coefs if needed from path1 without random effects
summary(path1_mod2)$coefficients 
# get significances from bootstrapped CIs, std coefs from path1 without random effects
summary(path1_mod3_bb)$coefficients 
# significances and ustd coefs from here, std if needed from path1 without random effects
summary(path1_mod4_bb)$coefficients 
# significances and ustd coefs from here, std if needed from path1 without random effects
```
piecewiseSEM does not work with glmmTMB - and that is the only package I found that fits betabinomial mixed models.

```{r message=FALSE, warning=FALSE}
path1_norandom<-psem(
  glm(seeds_01~FFD_s_y+n_fl_s_y+grazing_corr,
                data=data_selag,family="binomial"),
  lm(fitness_rel_y~FFD_s_y+n_fl_s_y+grazing_corr+prop_pred_seeds,
               data=data_selag),
  glm(grazing_corr~FFD_s_y+n_fl_s_y,
                  data=data_selag,family="binomial",weights=grazing_weights),
  glm(prop_pred_seeds~FFD_s_y+n_fl_s_y,
                  data=data_selag,family="binomial",
                  weights=n_seeds))
coefs(path1_norandom) 
plot(path1_norandom)
```

Figure 1: Path diagram (made in Inkscape)

% of grazed plants that produced seeds

```{r}
nrow(subset(data_selag,grazing_corr>0&n_seeds>0))*100/
  nrow(subset(data_selag,grazing_corr>0))
```

% of plants with more than half of their above-ground structures removed that produced seeds

```{r}
nrow(subset(data_selag,grazing_corr>0.5&n_seeds>0))*100/
  nrow(subset(data_selag,grazing_corr>0))
```

Only 29% of plants that experienced any grazing produced seeds, and 6% of plants that had more than half of their above-ground structures removed.

# H3

H3: Variation in climatic conditions during spring among years causes differences in selection on flowering time, through effects mediated by the intensity of biotic interactions. 

# H3 - Part 1

Variation in climatic conditions during spring among years influences the intensity of biotic interactions and the covariance between interaction intensity and plant phenology.

First, models to test the effect of spring temperatures on antagonistic interactions, while accounting for FFD and number of flowers. Using FFD and number of flowers standardized within years, temperatures standardized across years. Including interactions among FFD and temperatures. NOT including a random effect of year because there is only one value of temperature for each year. 

## Grazing

```{r message=FALSE, warning=FALSE}
mod_grazing<-glmmTMB(cbind(grazing_success,grazing_failure)~
                     (scale(mean_3)+scale(mean_4)+scale(mean_5))*FFD_s_y+
                     n_fl_s_y+(1|id),data = data_selag,
                   family="binomial")
summary(mod_grazing)
```

### Model diagnostics

Simulate residuals of the model:

```{r}
sim_mod_grazing <- simulateResiduals(fittedModel=mod_grazing,n=5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_mod_grazing,quantreg=T)
```

```{r}
testDispersion(sim_mod_grazing)
```

Slightly underdispersed.

```{r}
testZeroInflation(sim_mod_grazing)
```

Test of zero inflation is significant.

### Try with betabinomial

```{r}
mod_grazing_bb<-glmmTMB(cbind(grazing_success,grazing_failure)~
                       (scale(mean_3)+scale(mean_4)+scale(mean_5))*FFD_s_y+
                       n_fl_s_y+(1|id),data = data_selag,
                     family="betabinomial")
summary(mod_grazing_bb)
```

### Model diagnostics

Simulate residuals of the model:

```{r}
sim_mod_grazing_bb <- simulateResiduals(fittedModel=mod_grazing_bb,n=5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_mod_grazing_bb,quantreg=T)
```

```{r}
testDispersion(sim_mod_grazing_bb)
```

Still underdispersion.

```{r}
testZeroInflation(sim_mod_grazing_bb)
```

But zero inflation is fixed

```{r}
anova(mod_grazing,mod_grazing_bb)
AIC(mod_grazing,mod_grazing_bb)
```
Keep mod_grazing_bb.

## Seed predation

```{r message=FALSE, warning=FALSE}
mod_seedpred<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                     (scale(mean_3)+scale(mean_4)+scale(mean_5)+scale(mean_6))*
                      FFD_s_y+n_fl_s_y+(1|id),data=subset(data_selag,n_seeds>0),
                    family="binomial")
summary(mod_seedpred)
```

### Model diagnostics

Simulate residuals of the model:

```{r}
sim_mod_seedpred <- simulateResiduals(fittedModel=mod_seedpred,n=5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_mod_seedpred,quantreg=T)
```

```{r}
testDispersion(sim_mod_seedpred)
```
OK.

```{r}
testZeroInflation(sim_mod_seedpred)
```

Zero inflation.

### Try with betabinomial

```{r message=FALSE, warning=FALSE}
mod_seedpred_bb<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                     (scale(mean_3)+scale(mean_4)+scale(mean_5)+scale(mean_6))*
                      FFD_s_y+n_fl_s_y+(1|id),data=subset(data_selag,n_seeds>0),
                    family="betabinomial")
summary(mod_seedpred_bb)
```

### Model diagnostics

Simulate residuals of the model:

```{r}
sim_mod_seedpred_bb <- simulateResiduals(fittedModel=mod_seedpred_bb,n=5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(sim_mod_seedpred_bb,quantreg=T)
```

```{r}
testDispersion(sim_mod_seedpred_bb)
```

Slight underdispersion.

```{r}
testZeroInflation(sim_mod_seedpred_bb)
```

OK.

```{r}
anova(mod_seedpred,mod_seedpred_bb)
AIC(mod_seedpred,mod_seedpred_bb)
```

Keep mod_seedpred_bb.

## Table 1

```{r message=FALSE, warning=FALSE}
kable(summary(mod_grazing_bb)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_seedpred_bb)$coefficients,digits=c(3,3,2,3))
```

## Graphs for Fig 2 - Part 1

```{r}
pred_grazing_mean3<-ggpredict(mod_grazing_bb,
                              terms = c("mean_3 [all]"))
pred_grazing_mean4<-ggpredict(mod_grazing_bb,
                              terms = c("mean_4 [all]"))
pred_grazing_mean5<-ggpredict(mod_grazing_bb,
                              terms = c("mean_5 [all]"))
```

```{r fig.height=4, fig.width=12, message=FALSE, warning=FALSE}
Fig_2_temps_grazing<-grid.arrange(
  ggplot(data_selag,aes(x=mean_3,y=grazing_corr))+
    geom_point(size=3,alpha=0.05)+
    geom_ribbon(data=pred_grazing_mean3,
                aes(x,predicted,ymin=conf.low,ymax=conf.high),
                fill="firebrick2",alpha=0.3)+
    geom_line(data=pred_grazing_mean3,aes(x,predicted),
              color="firebrick2",size=1)+
    my_theme()+xlab("Mean March (ºC)")+ylab(NULL)+
    theme(plot.margin = unit(c(0.3,0.1,0.3,0.1), "cm"))+
    theme(axis.text.y=element_blank()),
  ggplot(data_selag,aes(x=mean_4,y=grazing_corr))+
    geom_point(size=3,alpha=0.05)+
    geom_ribbon(data=pred_grazing_mean4,
                aes(x,predicted,ymin=conf.low,ymax=conf.high),
                fill="firebrick2",alpha=0.3)+
    geom_line(data=pred_grazing_mean4,aes(x,predicted),
              color="firebrick2",size=1)+
    my_theme()+xlab("Mean April (ºC)")+ylab(NULL)+
    theme(plot.margin = unit(c(0.3,0.1,0.3,0.1), "cm"))+
    theme(axis.text.y=element_blank()),
  ggplot(data_selag,aes(x=mean_5,y=grazing_corr))+
    geom_point(size=3,alpha=0.05)+
    geom_ribbon(data=pred_grazing_mean5,
                aes(x,predicted,ymin=conf.low,ymax=conf.high),
                fill="firebrick2",alpha=0.3)+
    geom_line(data=pred_grazing_mean5,aes(x,predicted),
              color="firebrick2",size=1)+
    my_theme()+xlab("Mean May (ºC)")+ylab(NULL)+
    theme(plot.margin = unit(c(0.3,0.1,0.3,0.1), "cm"))+
    theme(axis.text.y=element_blank()),
  ncol=3)
ggsave(filename="output/figures/Fig_2_temps_grazing.tiff",
       plot=Fig_2_temps_grazing,device="tiff",width=15,height=8,units="cm",
       dpi=300,compression="lzw")
```

```{r}
pred_seedpred_mean3_FFD<-ggpredict(mod_seedpred_bb,
                        terms = c("mean_3 [all]","FFD_s_y [-2.6:3.9 by=.5]"))
pred_seedpred_mean4_FFD<-ggpredict(mod_seedpred_bb,
                        terms = c("mean_4 [all]","FFD_s_y [-2.6:3.9 by=.5]"))
pred_seedpred_mean5<-ggpredict(mod_seedpred_bb,
                              terms = c("mean_5 [all]"))
pred_seedpred_mean6<-ggpredict(mod_seedpred_bb,
                              terms = c("mean_6 [all]"))
```

```{r fig.height=4, fig.width=12, message=FALSE, warning=FALSE}
Fig_2_temps_seedpred<-grid.arrange(
  ggplot(pred_seedpred_mean3_FFD,aes(x,predicted,colour=group,fill=group))+
    geom_line(aes(color=as.numeric(as.character(group))),size=0.6)+my_theme()+
    scale_color_viridis()+
    theme(axis.text.y=element_blank())+
    scale_y_continuous(breaks = seq(0, 1, by = 0.25))+ylim(0,1)+
    theme(legend.justification=c(1.1,0.99),legend.position=c(1.07,0.89),
        legend.direction="horizontal",legend.title=element_blank())+
    annotate("text",x=0.8,y=0.98,label="FFD: early          late",
             family="serif",size=5)+
    xlab("Mean March (ºC)")+ylab(NULL)+
    theme(plot.margin = unit(c(0.3,0.1,0.3,0.1), "cm")),
  ggplot(pred_seedpred_mean4_FFD,aes(x,predicted,colour=group,fill=group))+
    geom_line(aes(color=as.numeric(as.character(group))),size=0.6)+my_theme()+
    scale_color_viridis()+
    theme(axis.text.y=element_blank())+
    scale_y_continuous(breaks = seq(0, 1, by = 0.25))+ylim(0,1)+
    xlab("Mean April (ºC)")+ylab(NULL)+
    theme(plot.margin = unit(c(0.3,0.1,0.3,0.1), "cm")),
  ggplot(data_selag,aes(x=mean_5,y=prop_pred_seeds))+
    geom_point(size=3,alpha=0.05)+
    geom_ribbon(data=pred_seedpred_mean5,
                aes(x,predicted,ymin=conf.low,ymax=conf.high),
                fill="firebrick2",alpha=0.3)+
    geom_line(data=pred_seedpred_mean5,aes(x,predicted),
              color="firebrick2",size=1)+
    my_theme()+xlab("Mean May (ºC)")+ylab(NULL)+
    theme(plot.margin = unit(c(0.3,0.1,0.3,0.1), "cm"))+
    theme(axis.text.y=element_blank()),
  ggplot(data_selag,aes(x=mean_6,y=prop_pred_seeds))+
    geom_point(size=3,alpha=0.05)+
    geom_ribbon(data=pred_seedpred_mean6,
                aes(x,predicted,ymin=conf.low,ymax=conf.high),
                fill="firebrick2",alpha=0.3)+
    geom_line(data=pred_seedpred_mean6,aes(x,predicted),
              color="firebrick2",size=1)+
    my_theme()+xlab("Mean June (ºC)")+ylab(NULL)+
    theme(plot.margin = unit(c(0.3,0.1,0.3,0.1), "cm"))+
    theme(axis.text.y=element_blank()),
  ncol=4)
ggsave(filename="output/figures/Fig_2_temps_seedpred.tiff",
       plot=Fig_2_temps_seedpred,device="tiff",width=20,height=8,units="cm",
       dpi=300,compression="lzw")
```

# H3 - Part 2

Differences in the intensity of biotic interactions among years, and in the covariance between FFD and biotic interaction intensities, cause differences in selection on flowering time. 

In this phenotypic selection model, we use: fitness relativized within years, FFD and n_fl standardized within years,interactions and covariances standardized accross years. Main effects of interactions and covariances are not included because fitness was relativized within years. 

N = 2376

```{r message=FALSE, warning=FALSE}
# Add yearly mean values of biotic interaction to dataset 
data_selag_means<-data_selag%>%
  group_by(year)%>%
  dplyr::summarise(grazing_mean=mean(grazing_corr,na.rm=T),
                   prop_pred_seeds_mean=mean(prop_pred_seeds,na.rm=T))
data_selag<-data_selag%>%left_join(data_selag_means,by="year")
```

```{r message=FALSE, warning=FALSE}
# Calculate covariance interactions - fitness for each  year
covar_graz_FFD<-data_selag%>%
  group_by(year)%>%
  do(graz_FFD = tidy(glm(cbind(grazing_success,grazing_failure)~FFD_s_y, 
                             data = .,family="binomial"))) %>% 
  unnest(graz_FFD)%>%
  filter(term=="FFD_s_y")%>%
  select(year,estimate)%>%
  rename(covar_graz_FFD=estimate)

covar_seedpred_FFD<-data_selag%>%
  filter(n_seeds>0)%>%
  filter(!is.na(n_intact_seeds))%>%
  group_by(year)%>%
  do(seedpred_FFD = tidy(glm(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                               FFD_s_y,data = .,
                             family="binomial"))) %>% 
  unnest(seedpred_FFD)%>%
  filter(term=="FFD_s_y")%>%
  select(year,estimate)%>%
  rename(covar_seedpred_FFD=estimate)

data_selag_means<-data_selag_means%>%
  full_join(covar_graz_FFD)%>%
  full_join(covar_seedpred_FFD)

# Add yearly covariances interactions - fitness to dataset 
data_selag<-data_selag%>%left_join(data_selag_means[c(1,4:5)],by="year")
```

```{r message=FALSE, warning=FALSE}
mod_int_sel_GLMM<-glmmTMB(fitness_rel_y ~ FFD_s_y+n_fl_s_y+
                            FFD_s_y:scale(grazing_mean)+
                            FFD_s_y:scale(covar_graz_FFD)+
                            FFD_s_y:scale(prop_pred_seeds_mean)+
                            FFD_s_y:scale(covar_seedpred_FFD)+
                            (1|id),data_selag,family="gaussian")
mod_int_sel_GLMM_lmer<-lmer(fitness_rel_y ~ FFD_s_y+n_fl_s_y+
                              FFD_s_y:scale(grazing_mean)+
                              FFD_s_y:scale(covar_graz_FFD)+
                              FFD_s_y:scale(prop_pred_seeds_mean)+
                              FFD_s_y:scale(covar_seedpred_FFD)+
                              (1|id),data_selag)
mod_int_sel_LM<-lm(fitness_rel_y ~ FFD_s_y+n_fl_s_y+
                         FFD_s_y:scale(grazing_mean)+
                            FFD_s_y:scale(covar_graz_FFD)+
                            FFD_s_y:scale(prop_pred_seeds_mean)+
                            FFD_s_y:scale(covar_seedpred_FFD),
                   subset(data_selag,!is.na(fitness_rel_y)&
                            !is.na(FFD_s_y)&!is.na(n_fl_s_y)&
                            !is.na(grazing_mean)&
                            !is.na(prop_pred_seeds_mean)))
# Results of models (t-tests)
kable(summary(mod_int_sel_GLMM)$coefficients,digits=c(3,3,0,2,3))
# Analysis of deviance (Wald chi‐square tests for GLMM)
kable(Anova(mod_int_sel_GLMM),digits=c(2,1,3))
```

Significant effect of yearly mean grazing on selection (but we have seen that the significance is driven by the year 2017).

## Model diagnostics

Simulate residuals of the model:

```{r}
simulationOutput_mod_int_sel_GLMM <- 
  simulateResiduals(fittedModel = mod_int_sel_GLMM, n = 5000)
```

qq-plot  and plot of residuals vs. predicted:

```{r}
plot(simulationOutput_mod_int_sel_GLMM)
```

Looking bad, calculate bootstrapped CIs.

## Bootstraped confidence intervals

### Mixed model

```{r eval=FALSE, include=FALSE}
b_par_2<-bootMer(x=mod_int_sel_GLMM_lmer,FUN=fixef,nsim=10000)
save(b_par_2,file="output/b_par_2.RData")
```

```{r}
confint(b_par_2,level=0.95, method="boot") # Percentile method
```

Similar to significances in the model

### LM (Elsa's code) (not used)

```{r eval=FALSE, include=FALSE}
# # FFD_s_y
# slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[2]
# b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# FFD_s_y_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # n_fl_s_y
# slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[3]
# b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# n_fl_s_y_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # FFD_s_y:grazing_mean_s
# slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[4]
# b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# FFD_s_y_graz_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # prop_pred_seeds_mean_s
# slp <- function(mod_int_sel_LM) coef(mod_int_sel_LM)[5]
# b <- car::Boot(mod_int_sel_LM,slp, R=10000) # note the capital B
# b1 <- boot::boot.ci(b,type="bca")
# FFD_s_y_pred_ci <- as.data.frame(b1$bca[1,4:5])
# rm(slp, b, b1)
# ```
# 
# ```{r eval=FALSE, include=FALSE}
# # Save confidence intervals as a table
# lower_A <- rbind(FFD_s_y_ci[1,] ,n_fl_s_y_ci[1,])
# lower_B <- rbind(lower_A ,FFD_s_y_graz_ci[1,])
# lower_C <- rbind(lower_B ,FFD_s_y_pred_ci[1,])
# lower <- lower_C
# 
# upper_A <- rbind(FFD_s_y_ci[2,] ,n_fl_s_y_ci[2,])
# upper_B <- rbind(upper_A ,FFD_s_y_graz_ci[2,])
# upper_C <- rbind(upper_B ,FFD_s_y_pred_ci[2,])
# upper <- upper_C
# 
# BCIs_mod_int_sel_LM <- cbind(lower, upper) 
# rownames(BCIs_mod_int_sel_LM) <- c("FFD_s_y","n_fl_s_y",
#                                    "FFD_s_y:graz","FFD_s_y:pred")
# BCIs_mod_int_sel_LM
```

Similar to significances in the model

## Graph for Fig 2 - Part 2

```{r}
pred_fitness<-ggpredict(mod_int_sel_GLMM,
                        terms = c("FFD_s_y [all]","grazing_mean [0:0.8 by=.05]"))
```

```{r fig.height=4, fig.width=6}
Fig_2_fitness<-ggplot(pred_fitness,aes(x,predicted,colour=group,fill=group))+
  geom_line(aes(color=as.numeric(as.character(group))),size=0.6)+my_theme()+
  scale_color_viridis()+
  theme(legend.position="top")+labs(colour="Mean grazing\nprobability")+
  xlab("First flowering date")+ylab("Predicted fitness")
Fig_2_fitness
ggsave(filename="output/figures/Fig_2_fitness.tiff",
       plot=Fig_2_fitness,device="tiff",width=9,height=10,units="cm",
       dpi=300,compression="lzw")
```

The slope of the relationship among fitness and FFD is more positive in years with higher proportions of grazing → selection for later flowering in those years

## Effects on selection gradients for each year (not used)

Calculation of selection gradients for each year

```{r}
selgrads_FFD<-data.frame(data_selag %>% group_by(year) %>% 
  do(tidy(lm(fitness_rel_y ~ FFD_s_y+n_fl_s_y, data = .))))
selgrads_FFD$sig<-ifelse(selgrads_FFD$p.value<0.05,"*","") 
kable(subset(selgrads_FFD,term=="FFD_s_y"),
      digits=3)  #Linear selection gradients for FFD
#FFD * (selection for early flowering) 
# in 1991,1992,1993,1994,2007,2010,2012,2014 (as in EL paper)
```
Plot selection gradients vs mean interactions

```{r echo=FALSE, fig.height=5, fig.width=18}
data_selag_means<-data_selag_means%>%
  left_join(subset(selgrads_FFD,term=="FFD_s_y")[c(1,3)])
grid.arrange(
  ggplot(data_selag_means,aes(x=grazing_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean grazing"),
  ggplot(data_selag_means,aes(x=prop_pred_seeds_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean proportion of predated seeds"),
  ncol=3)
```

Models for effects of mean interactions on selection gradients

```{r}
kable(summary(lm(estimate~grazing_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~prop_pred_seeds_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~grazing_mean+prop_pred_seeds_mean,
                 data_selag_means))$coefficients)
kable(summary(lm(estimate~grazing_mean+prop_pred_seeds_mean,
                 subset(data_selag_means,year<2017)))$coefficients)
```

No significant effects of yearly mean interactions on yearly selection gradients (but effect of grazing is ALMOST significant)

# Appendix S1: Variation FFD, climatic Variables and intensities of the three interactions among years.

## Values

```{r}
# # FFD mean and SD
# data_selag%>%
#   dplyr::group_by(year)%>%
#   dplyr::summarise(FFD_mean=mean(FFD,na.rm=T),
#                    FFD_SD=sd(FFD,na.rm=T))%>%
#   dplyr::summarise(FFD_mean_min=min(FFD_mean),
#                    FFD_mean_max=max(FFD_mean),
#                    FFD_mean_mean=mean(FFD_mean),
#                    FFD_mean_sd=sd(FFD_mean),
#                    FFD_SD_min=min(FFD_SD),
#                    FFD_SD_max=max(FFD_SD),
#                    FFD_SD_mean=mean(FFD_SD),
#                    FFD_SD_sd=sd(FFD_SD))

# Temperatures
range(unique(data_selag$mean_3))
mean(unique(data_selag$mean_3))
sd(unique(data_selag$mean_3))
range(unique(data_selag$mean_4))
mean(unique(data_selag$mean_4))
sd(unique(data_selag$mean_4))
range(unique(data_selag$mean_5))
mean(unique(data_selag$mean_5))
sd(unique(data_selag$mean_5))
range(unique(data_selag$mean_6))
mean(unique(data_selag$mean_6))
sd(unique(data_selag$mean_6))

# Interactions
data_selag_means%>%
  dplyr::summarise(grazing_mean_min=min(grazing_mean),
                   grazing_mean_max=max(grazing_mean),
                   grazing_mean_mean=mean(grazing_mean),
                   grazing_mean_sd=sd(grazing_mean),
                   prop_pred_seeds_mean_min=min(prop_pred_seeds_mean),
                   prop_pred_seeds_mean_max=max(prop_pred_seeds_mean),
                   prop_pred_seeds_mean_mean=mean(prop_pred_seeds_mean),
                   prop_pred_seeds_mean_sd=sd(prop_pred_seeds_mean))
```

## Plots

Variation in number of plants flowering and producing seeds, flowering time, temperatures and interaction intensities during the study period. 

Read weather data

```{r}
weather<-read.table("data/weather.csv",
                    header=T,sep="\t",dec=".") 
weather<-subset(subset(weather,year!=1995),year<1997|year>2005)
```

### Fig. S1

```{r fig.height=4, fig.width=12}
# How many plants flowered each year, and how many produced seeds
data_selag%>%
  filter(!is.na(FFD)|!is.na(n_fl))%>%
  group_by(year)%>%
  dplyr::summarise(n_flowered=n(),n_prod_seeds=sum(seeds_01))%>%
  pivot_longer(cols=n_flowered:n_prod_seeds,
               names_to="category",values_to="number")%>%
  ggplot(aes(x=factor(year),y=number,fill=category))+
  geom_histogram(stat = "identity",position = "dodge",color="black")+
  xlab("Year")+ylab("Number of plants")+my_theme_legend()+
  theme(legend.position = c(0.90, 0.88))+
  scale_fill_manual(values = c("#568fe9", "#c7e6f8"),
                    name=NULL,labels=c("flowering","producing seeds"))
ggsave(filename="output/figures/AppendixS1_1.tiff",
       device="tiff",width=25,height=10,units="cm",dpi=300,compression="lzw")
```

### Fig. S2

```{r fig.height=4, fig.width=12}
# FFD
ggplot(summarySE(data_selag, measurevar="FFD", groupvars="year",na.rm=T),
       aes(x=factor(year),y=FFD))+geom_point(size=3)+
  geom_errorbar(aes(ymin=FFD-sd, ymax=FFD+sd), width=.3)+ geom_point(size=3)+
  xlab("Year")+ylab("First flowering date\n(days after vernal equinox)")+
  my_theme()
ggsave(filename="output/figures/AppendixS1_2.tiff",
       device="tiff",width=25,height=10,units="cm",dpi=300,compression="lzw")
```

### Fig. S3

```{r fig.height=4, fig.width=12}
# Temperatures
weather_all<-read.table("data/weather.csv",
                    header=T,sep="\t",dec=".") 

summarySE(subset(subset(weather_all,year>1986),
                 month==3|month==4|month==5|month==6), 
          measurevar="mean", groupvars=c("year","month"))%>%
  mutate(incl=factor(ifelse(year==1995,0,ifelse(year>1996&year<2006,0,1))))%>%
ggplot(aes(x=year, y=mean, colour=factor(month),ymin=mean-se, ymax=mean+se))+
  geom_errorbar(width=.3, position = position_dodge(width = 0.5))+
  geom_line(position = position_dodge(width = 0.5))+
  geom_point(aes(shape=incl),size=5,position = position_dodge(width = 0.5))+
  xlab("Year")+ylab("Mean daily temperature (ºC)")+
  my_theme_legend()+
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442"),
                    name="Month",labels=c("March","April","May","June"))+
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442"),
                     name="Month",labels=c("March","April","May","June"))+
  scale_shape_manual(values=c(21,19),guide = FALSE)+
  scale_x_continuous(breaks=seq(1987,2017,1))+
  theme(legend.position = c(0.93, 0.15))
ggsave(filename="output/figures/AppendixS1_3.tiff",
       device="tiff",width=350,height=190,units="mm",dpi=300,compression="lzw")
```

### Fig. S4

```{r fig.height=12, fig.width=12}
# Interactions
S1_4<-grid.arrange(
  ggplot(summarySE(data_selag,measurevar="grazing_corr",
                   groupvars="year",na.rm=T),
         aes(x=factor(year),y=grazing_corr))+geom_point(size=3)+
    geom_errorbar(aes(ymin=grazing_corr-se,ymax=grazing_corr+se),
                  width=.3)+
    xlab("Year")+ylab("Grazing")+my_theme()+ggtitle("A)"),
  ggplot(summarySE(data_selag,measurevar="prop_pred_seeds",
                   groupvars="year",na.rm=T),
         aes(x=factor(year),y=prop_pred_seeds))+geom_point(size=3)+
    geom_errorbar(aes(ymin=prop_pred_seeds-se,ymax=prop_pred_seeds+se),
                  width=.3)+
    xlab("Year")+ylab("Seed predation")+my_theme()+ggtitle("B)"),
  ncol=1)
ggsave(filename="output/figures/AppendixS1_4.tiff",plot=S1_4,device="tiff"
       ,width=25,height=20,units="cm",dpi=300,compression="lzw")
```

# Appendix S2: Raw relationships biotic interactions ~ FFD in different years

## Fig. S1: Raw relationships grazing ~ FFD in different years

```{r echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
ggplot(subset(data_selag,year<2009),
       aes(x=FFD,y=grazing_success/(grazing_success+grazing_failure),
                      succ=grazing_success, fail=grazing_failure))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Grazing")+
  xlab("First flowering date (days after vernal equinox)")
ggsave(filename="output/figures/AppendixS2_1A.tiff",device="tiff",width=168,
       height=210,units="mm",dpi=300,compression="lzw")
ggplot(subset(data_selag,year>2008),
       aes(x=FFD,y=grazing_success/(grazing_success+grazing_failure),
                      succ=grazing_success, fail=grazing_failure))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Grazing")+
  xlab("First flowering date (days after vernal equinox)")
ggsave(filename="output/figures/AppendixS2_1B.tiff",device="tiff",width=168,
       height=158,units="mm",dpi=300,compression="lzw")
```

See which models are significant and add asterisks in Inkscape.

```{r}
data_selag%>%
  group_by(year)%>%
  do(models = tidy(glm(cbind(grazing_success,grazing_failure)~FFD,
                       family="binomial", data = .))) %>% 
  unnest(models)%>%
  kable()
```

## Fig. S2: Raw relationships predation ~ FFD in different years

```{r echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
ggplot(subset(data_selag,year<2009),
       aes(x=FFD,y=n_pred_seeds/(n_pred_seeds+n_intact_seeds),
                      succ=n_pred_seeds, fail=n_intact_seeds))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Seed predation")+
  xlab("First flowering date (days after vernal equinox)")
ggsave(filename="output/figures/AppendixS2_2A.tiff",device="tiff",width=168,
       height=210,units="mm",dpi=300,compression="lzw")
ggplot(subset(data_selag,year>2008),
       aes(x=FFD,y=n_pred_seeds/(n_pred_seeds+n_intact_seeds),
                      succ=n_pred_seeds, fail=n_intact_seeds))+my_theme()+
  geom_point(size=1,alpha=0.1)+
  geom_smooth(method="glm",method.args=list(family="binomial"),
              formula=cbind(succ,fail)~x,se=T,color="black",size=0.5)+
  facet_wrap(~year,ncol=3,scales="free")+ylab("Seed predation")+
  xlab("First flowering date (days after vernal equinox)")
ggsave(filename="output/figures/AppendixS2_2B.tiff",device="tiff",width=168,
       height=158,units="mm",dpi=300,compression="lzw")
```

See which models are significant and add asterisks in Inkscape.

```{r}
data_selag%>%
  group_by(year)%>%
  do(models = tidy(glm(cbind(round(n_pred_seeds),round(n_intact_seeds))~FFD,
                       family="binomial", data = .))) %>% 
  unnest(models)%>%
  kable()
```

# Appendix S3: Variation in the relationships among interaction intensities and individual flowering time among years

Table: Models with interaction FFD x year

```{r}
graz_FFD_yrs<-glmmTMB(cbind(grazing_success,grazing_failure)~
                        FFD*as.factor(year)+(1|id),
                      data = data_selag,family="betabinomial")
Anova(graz_FFD_yrs)
```

```{r}
pred_FFD_yrs<-glmmTMB(cbind(round(n_pred_seeds),round(n_intact_seeds))~
                        FFD*as.factor(year),
                      data=subset(subset(data_selag,n_seeds>0),
                                  !is.na(n_intact_seeds)),family="betabinomial")
Anova(pred_FFD_yrs)
```

# Appendix S4:Relationships between temperatures and predicted seed predation for different parts of the distribution of flowering dates

```{r}
mean(subset(data_selag,n_seeds>0&FFD_s_y<=-0.84)$FFD_s_y) 
# Mean cat 1 = -1.247518
mean(subset(data_selag,n_seeds>0&FFD_s_y>-0.84&FFD_s_y<=-0.28)$FFD_s_y) 
# Mean cat 2 = -0.5992093
mean(subset(data_selag,n_seeds>0&FFD_s_y>-0.28&FFD_s_y<=0.26)$FFD_s_y) 
# Mean cat 3 = -0.008394325
mean(subset(data_selag,n_seeds>0&FFD_s_y>0.16)$FFD_s_y) 
# Mean cat 4 = 0.7891997

pred_seedpred_mean3<-rbind(
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_3 [all]","FFD_s_y [-1.247518]")))%>%
     mutate(FFD_s_y_cat=1)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)),
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_3 [all]","FFD_s_y [-0.5992093]")))%>%
     mutate(FFD_s_y_cat=2)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)),
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_3 [all]","FFD_s_y [-0.008394325]")))%>%
     mutate(FFD_s_y_cat=3)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)),
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_3 [all]","FFD_s_y [0.7891997]")))%>%
     mutate(FFD_s_y_cat=4)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)))%>%
  mutate(month="3")
pred_seedpred_mean4<-rbind(
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_4 [all]","FFD_s_y [-1.247518]")))%>%
     mutate(FFD_s_y_cat=1)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)),
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_4 [all]","FFD_s_y [-0.5992093]")))%>%
     mutate(FFD_s_y_cat=2)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)),
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_4 [all]","FFD_s_y [-0.008394325]")))%>%
     mutate(FFD_s_y_cat=3)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)),
  (data.frame(ggpredict(mod_seedpred_bb,
                        terms = c("mean_4 [all]","FFD_s_y [0.7891997]")))%>%
     mutate(FFD_s_y_cat=4)%>%
     dplyr::rename(temp=x, prop_pred_seeds=predicted,FFD_s_y=group)))%>%
  mutate(month="4")
pred_seedpred<-rbind(pred_seedpred_mean3,pred_seedpred_mean4)

label_names1 <- list(
  '1'="First quarter\nMean FFD = -1.25",
  '2'="Second quarter\nMean FFD = -0.60",
  '3'="Third quarter\nMean FFD = -0.01",
  '4'="Fourth quarter\nMean FFD = 0.79"
)

label_names2 <- list(
  '3'="March",
  '4'="April"
)

labeller_function1 <- function(variable,value){
  return(label_names1[value])
}

labeller_function2 <- function(variable,value){
  return(label_names2[value])
}
```

```{r}
ggplot(subset(data_selag,n_seeds>0&!is.na(FFD_s_y))%>%
         ungroup()%>%
         # Define 4 FFD_s_y categories based on quartiles
         mutate(FFD_s_y_cat=as.factor(
           ifelse(FFD_s_y<=-0.84,1,
                  ifelse(FFD_s_y>-0.84&FFD_s_y<=-0.28,2,
                         ifelse(FFD_s_y>-0.28&FFD_s_y<=0.26,3,4)))))%>%
         select(mean_3,mean_4,prop_pred_seeds,FFD_s_y_cat)%>%
         dplyr::rename(March=mean_3,April=mean_4)%>%
         pivot_longer(cols=March:April,names_to="month",values_to="temp")%>%
         mutate(month=ifelse(month=="March",3,4)),
       aes(x=temp,y=prop_pred_seeds))+
  facet_grid(month~FFD_s_y_cat,scales="free",
             labeller=labeller(FFD_s_y_cat=labeller_function1,
                               month=labeller_function2))+
  geom_jitter(size=1.5,alpha=0.3,width=0.05)+
  geom_line(data=pred_seedpred,
            aes(x=temp,y=prop_pred_seeds,color=FFD_s_y_cat),size=1)+
  geom_ribbon(data=pred_seedpred,aes(x=temp,y=prop_pred_seeds,
                                     ymin=conf.low,ymax=conf.high,
                                     fill=FFD_s_y_cat),alpha=0.3)+
  my_theme()+scale_color_viridis(labels=NULL)+scale_fill_viridis(labels=NULL)+
  theme(legend.position="top")+labs(colour="First flowering date      ")+
  xlab("Mean temperature (ºC)")+
  ylab("Predicted seed predation")+
  scale_x_continuous(breaks=c(-4,-2,0,2,4,6,8))+
  theme(strip.text.x=element_text(margin=margin(2,0,2,0)))+
  guides(fill=FALSE)
ggsave(filename="output/figures/AppendixS4.tiff",
       device="tiff",width=350,height=190,units="mm",dpi=300,compression="lzw")
```


# Appendix S5: Relationships fitness-FFD for each level of mean grazing (separately for each year).

```{r message=FALSE, warning=FALSE}
pred_fitness_all<-ggpredict(mod_int_sel_GLMM,
                        terms = c("FFD_s_y [all]","grazing_mean [all]"))
data_grazing_cats<-subset(data_selag,!is.na(FFD_s_y)&!is.na(fitness_rel_y))%>%
  ungroup()%>%
  select("year","FFD_s_y","fitness_rel_y","grazing_mean")%>%
  mutate(grazing_mean=round(grazing_mean,3))
pred_fitness_all_df<-data.frame(pred_fitness_all)%>%
  dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group)%>%
  mutate(cat="prediction",
         grazing_mean=as.numeric(as.character(grazing_mean)))%>%
  left_join(data_grazing_cats[c(1,4)])
pred_fitness_byyear<-
  rbind(
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.011]")))%>%
      mutate(year=1993)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.016]")))%>%
      mutate(year=1992)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.02]")))%>%
      mutate(year=2011)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.024]")))%>%
      mutate(year=2014)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.025]")))%>%
      mutate(year=2010)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.025]")))%>%
      mutate(year=2013)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.04]")))%>%
      mutate(year=1996)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.043]")))%>%
      mutate(year=1990)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.047]")))%>%
      mutate(year=1989)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.054]")))%>%
      mutate(year=1987)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.063]")))%>%
      mutate(year=2008)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.07]")))%>%
      mutate(year=1988)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.071]")))%>%
      mutate(year=2007)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.078]")))%>%
      mutate(year=2012)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.129]")))%>%
      mutate(year=2009)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.134]")))%>%
      mutate(year=1991)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.242]")))%>%
      mutate(year=2015)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.258]")))%>%
      mutate(year=2006)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.26]")))%>%
      mutate(year=2016)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.261]")))%>%
      mutate(year=1994)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group),
    data.frame(ggpredict(mod_int_sel_GLMM,
                         terms = c("FFD_s_y [all]","grazing_mean [0.756]")))%>%
      mutate(year=2017)%>%
      dplyr::rename(FFD_s_y=x, fitness_rel_y=predicted,grazing_mean=group)
  )
```

```{r fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
ggplot(data=subset(data_grazing_cats))+
  geom_jitter(aes(x=FFD_s_y,y=fitness_rel_y),size=1.5,alpha=0.3,width=0.05)+
  facet_wrap_paginate(~grazing_mean+year,scales="free",nrow=4,ncol=3,page=1,
             labeller = labeller(label_value,.multi_line=F))+
  geom_line(data=pred_fitness_all_df,
            aes(FFD_s_y,fitness_rel_y,
                color=as.numeric(as.character(grazing_mean))),size=1)+
  geom_ribbon(data=pred_fitness_byyear,
            aes(x=FFD_s_y,y=fitness_rel_y,ymin=conf.low,ymax=conf.high,
                fill=as.numeric(as.character(grazing_mean))),alpha=0.3)+
  my_theme()+scale_color_viridis(direction = -1)+
  scale_fill_viridis(direction = -1)+
  theme(legend.position="top")+labs(colour="Mean grazing probability")+
  xlab("First flowering date")+
  ylab("Predicted fitness (number of intact seeds)")+
  theme(strip.text.x=element_text(margin=margin(2,0,2,0)))+
  guides(fill=FALSE)
ggsave(filename="output/figures/AppendixS5_A.tiff",device="tiff",width=168,
       height=210,units="mm",dpi=300,compression="lzw")

ggplot(data=subset(data_grazing_cats))+
  geom_jitter(aes(x=FFD_s_y,y=fitness_rel_y),size=1.5,alpha=0.3,width=0.05)+
  facet_wrap_paginate(~grazing_mean+year,scales="free",nrow=4,ncol=3,page=2,
                      labeller = labeller(label_value,.multi_line=F))+
  geom_line(data=pred_fitness_all_df,
            aes(FFD_s_y,fitness_rel_y,
                color=as.numeric(as.character(grazing_mean))),size=1)+
  geom_ribbon(data=pred_fitness_byyear,
              aes(x=FFD_s_y,y=fitness_rel_y,ymin=conf.low,ymax=conf.high,
                  fill=as.numeric(as.character(grazing_mean))),alpha=0.3)+
  my_theme()+scale_color_viridis(direction = -1)+
  scale_fill_viridis(direction = -1)+
  theme(legend.position="top")+labs(colour="Mean grazing probability")+
  xlab("First flowering date")+
  ylab("Predicted fitness (number of intact seeds)")+
  theme(strip.text.x=element_text(margin=margin(2,0,2,0)))+
  guides(fill=FALSE)
ggsave(filename="output/figures/AppendixS5_B.tiff",device="tiff",width=168,
       height=210,units="mm",dpi=300,compression="lzw")
```

# Appendix X: Relationship between flowering frequency and FFD

```{r message=FALSE, warning=FALSE}
# fl_freq=proportion of years that a plant flowered
# (number of years flowering / number of years studied).
# Using plants that were followed for 8-10 years (old period)
# or 12  years (new period)
fl_freq<-read.table("data/fl_freq.csv",header=T,sep=",",dec=".")
data_fl_freq<-data_selag%>%
  right_join(fl_freq[c(3,6)])%>%
  group_by(id)%>%
  dplyr::summarise(mean_FFD=mean(FFD,na.rm=T),fl_freq=mean(fl_freq))
ggplot(data_fl_freq,aes(x=fl_freq,y=mean_FFD))+
  geom_jitter(width=0.007,height=0,size=2,alpha=0.15)+
  geom_smooth(method="lm",color="firebrick2",fill="firebrick2",size=1)+
  xlab("Flowering frequency")+ylab("Mean first flowering date")+
  my_theme()
# Show this one
ggsave(filename="output/figures/Appendix_X.tiff",
       device="tiff",width=12,height=10,units="cm",dpi=300,compression="lzw")
summary(lm(mean_FFD~fl_freq,data=data_fl_freq))
```

# Effects of variance in temperatures on interactions (not used)

```{r message=FALSE, warning=FALSE}
temp_variance<-read.table("data/temp_variance.csv",
                          header=T,sep="\t",dec=".") 
data_selag<-data_selag%>%
  left_join(temp_variance)
```

```{r}
mod_grazing_tempvar_bb<-glmmTMB(
  cbind(grazing_success,grazing_failure)~scale(var_3)+scale(var_4)+
    scale(var_5)+FFD_s_y+n_fl_s_y+(1|id),data = data_selag,
  family="betabinomial")
summary(mod_grazing_tempvar_bb)
```

```{r message=FALSE, warning=FALSE}
mod_seedpred_tempvar_bb<-glmmTMB(
  cbind(round(n_pred_seeds),round(n_intact_seeds))~ scale(var_3)+scale(var_4)+
    scale(var_5)+scale(var_6)+FFD_s_y+n_fl_s_y+(1|id),data = data_selag,
  family="betabinomial")
summary(mod_seedpred_tempvar_bb)
```

Significant effects, but we probably do not want to get into this. 

# Period effect

```{r}
mod_grazing_period_bb<-glmmTMB(
  cbind(grazing_success,grazing_failure)~scale(mean_3)+scale(mean_4)+
    scale(mean_5)+FFD_s_y+n_fl_s_y+period+(1|id),data = data_selag,
  family="betabinomial")
summary(mod_grazing_period_bb)
```

Significant period effect (disappears when removing 2017).

```{r message=FALSE, warning=FALSE}
mod_seedpred_period_bb<-glmmTMB(
  cbind(round(n_pred_seeds),round(n_intact_seeds))~ scale(mean_3)+scale(mean_4)+
    scale(mean_5)+scale(mean_6)+FFD_s_y+n_fl_s_y+period+(1|id),data = data_selag,
  family="betabinomial")
summary(mod_seedpred_period_bb)
```









