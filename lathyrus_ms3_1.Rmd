---
title: "Lathyrus ms3: Selective agents"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggthemes)
library(MuMIn)
library(plyr)
library(knitr)
library(gridExtra)
library(lme4)
library(parallel)
library(lmerTest)
library(RPushbullet)
library(effects)
library(broom)
library(car)
library(grid)
library(blme)
library(RColorBrewer)
```

```{r Define ggplot themes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
```

# Data preparation

Load data, keep variables needed and merge

```{r Load data}
data_selag<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata_weather_subs.csv",header=T,sep="\t",dec=".") 
mean_weather<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/mean_weather.csv",header=T,sep="\t",dec=".")
```

```{r Keep vars}
data_selag<-data_selag[c(1:7,9:10,12,14:15,17:18,21,22)]
data_selag$n_fl<-data_selag$cum_n_fl
data_selag$cum_n_fl<-NULL
mean_weather<-mean_weather[c(1,115:118)]
data_selag<-merge(data_selag,mean_weather,by="year")%>%
  arrange(.,id)

data_selag<-anti_join(data_selag,subset(data_selag,is.na(FFD)&is.na(grazing)&
                                          is.na(shoot_vol)&is.na(n_fr)&is.na(n_ovules)&
                                          is.na(n_seeds)&is.na(n_intact_seeds)&
                                          is.na(n_fl))) # Remove rows with all these NAs
names(data_selag)
data_selag<-subset(data_selag,year!=1995) # Remove data from 1995 due to problems with predation
```

List of variables in data set:

- year
- FFD: first flowering date (as number of days from vernal equinox)
- id: individual identifier (including "old" for individuals in period 1987-1996 and "new" for individuals in period 2006-2017)
- ruta, genet: identifiers for plots and ids in old data
- data: 1 if data available, 0 if not
- vernal: date of vernal equinox in each year
- grazing: proportion of grazing by deer
- shoot_vol: shoot volume
- n_fr: number of fruits
- n_ovules: number of ovules
- FFD_corr: first flowering date (as a date)
- period: "old" for 1987-1996 and "new" for 2006-2017
- n_seeds: number of seeds
- n_intact_seeds: number of intact (non-predated) seeds
- n_fl: number of flowers
- mean_3/4/5/6: average of daily mean temperatures for March/April/May/June

Interactions that we will focus on:

- Pollination: number of seeds per flower
- Seed predation: proportion of seeds escaping predation
- Grazing (by deer) before flowering: proportion of grazing

Calculate fruit set, seed set, number of seeds per fruit, number of seeds per flower, proportion of predated seeds

```{r calc interactions}
data_selag<-data_selag%>%
  mutate(fruit_set=n_fr/n_fl,seed_set=ifelse(fruit_set==0,0,n_seeds/n_ovules),
         n_seeds_per_fr=ifelse(fruit_set==0,0,n_seeds/n_fr),
         n_seeds_per_fl=n_seeds/n_fl,
         prop_seeds_esc=ifelse(n_seeds==0,NA,1-((n_seeds-n_intact_seeds)/n_seeds)),
         n_pred_seeds=n_seeds-n_intact_seeds)
```

# Histograms for interaction variables

```{r echo=FALSE, fig.height=9, fig.width=9, message=FALSE, warning=FALSE}
data_selag %>%
  pivot_longer(c(fruit_set:prop_seeds_esc,grazing), 
               names_to = "variable", values_to = "value") %>%
  ggplot(aes(x=value))+ geom_histogram(colour="black", fill="white")+
  facet_wrap(vars(variable), ncol = 2,scales="free") + my_theme()
```

Using only mean temperatures. Using grazing as a proportion, and for 2008-2015 use values of proportion of aboveground volume. 

- 1987-1996: grazing = proportion of flowers removed
- 2006: grazing = proportion of grazed shoots
- 2007-2015: grazing = proportion of aboveground volume removed
- 2016-2017: grazing = proportion of flowers removed

```{r message=FALSE, warning=FALSE, include=FALSE}
grazing_new<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/data/grazing_new.csv",header=T,sep=",",dec=".") 
data_selag<-left_join(data_selag,grazing_new)%>%
  mutate(grazing_corr=ifelse(is.na(grazing_new),grazing,grazing_new))
```

# 1. Effects of yearly intensity of interactions on selection

Because grazing influences (decreases) the number of seeds per flower, we calculate residuals of number of seeds per flower on grazing to use in the model.

In this model, we use: fitness relativized within years, FFD and n_fl standardized within years,interactions standardized accross years. Main effects of interactions are not included because fitness was relativized within years. 

N = 2376

```{r}
data_selag$n_seeds_per_fl_res<-with(data_selag,ifelse(is.na(n_seeds_per_fl),NA,
                                           residuals(lm(n_seeds_per_fl~grazing_corr,
                                               data=data_selag))))
data_selag_means<-data_selag%>%
  group_by(year)%>%
  dplyr::summarise(n_seeds_per_fl_mean=mean(n_seeds_per_fl,na.rm=T),
                   n_seeds_per_fl_res_mean=mean(n_seeds_per_fl_res,na.rm=T),
                   grazing_mean=mean(grazing_corr,na.rm=T),
                   prop_seeds_esc_mean=mean(prop_seeds_esc,na.rm=T),
                   FFD_mean=mean(FFD,na.rm=T),
                   FFD_sd=sd(FFD,na.rm=T),
                   n_fl_mean=mean(n_fl,na.rm=T),
                   n_fl_sd=sd(n_fl,na.rm=T),
                   n_intact_seeds_mean=mean(n_intact_seeds,na.rm=T))

data_selag<-data_selag%>%left_join(data_selag_means,by="year")
# Standardize interactions accross years
data_selag$n_seeds_per_fl_mean_s<-scale(data_selag$n_seeds_per_fl_mean)
data_selag$n_seeds_per_fl_res_mean_s<-scale(data_selag$n_seeds_per_fl_res_mean)
data_selag$grazing_mean_s<-scale(data_selag$grazing_mean)
data_selag$prop_seeds_esc_mean_s<-scale(data_selag$prop_seeds_esc_mean)

# Relativize fitness within years and standardize FFD and n_fl within years
data_selag$n_intact_seeds_rel_y<-with(data_selag,n_intact_seeds/n_intact_seeds_mean)
data_selag$FFD_s_y<-with(data_selag,(FFD-FFD_mean)/FFD_sd)
data_selag$n_fl_s_y<-with(data_selag,(n_fl-n_fl_mean)/n_fl_sd)
```

```{r}
mod_int_sel_GLM<-lm(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y+
               FFD_s_y:n_seeds_per_fl_res_mean_s+FFD_s_y:grazing_mean_s+FFD_s_y:prop_seeds_esc_mean_s,
               data_selag)
mod_int_sel_GLMM<-lmer(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y+
               FFD_s_y:n_seeds_per_fl_res_mean_s+FFD_s_y:grazing_mean_s+FFD_s_y:prop_seeds_esc_mean_s+
                 (1|id),data_selag)
# Results of models (t-tests)
kable(summary(mod_int_sel_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_int_sel_GLMM)$coefficients,digits=c(3,3,1,2,3))
# Analysis of variance/ deviance (F-test for GLM, Wald chi‐square tests for GLMM)
kable(Anova(mod_int_sel_GLM))
kable(Anova(mod_int_sel_GLM))
```

Significant effect of grazing on selection (but we have seen that the significance is driven by the year 2017).

### Graph of the interaction FFD:grazing 

Graph based on GLMM with non-standardized interactions - to show real values of grazing in the color bar.

```{r echo=FALSE, fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
mod_int_sel_GLMM_nsints<-lmer(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y+
               FFD_s_y:n_seeds_per_fl_res_mean+FFD_s_y:grazing_mean+FFD_s_y:prop_seeds_esc_mean+
                 (1|id),data_selag)
interaction1_nsints<-data.frame(effect(term="FFD_s_y:grazing_mean",mod=mod_int_sel_GLMM_nsints,
                       xlevels=list(FFD_s_y=seq(-3.9,4.16,0.1),
                                    grazing_mean=seq(0.01,0.75,0.01))))

myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))

ggplot(interaction1_nsints, aes(FFD_s_y,fit, group = as.factor(grazing_mean)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_s_y,fit,color=grazing_mean))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Proportion of grazing")
```

- The slope of the relationship among fitness and FFD is more positive in years with higher proportions of grazing → selection for later flowering in those years

## Effects on selection gradients for each year

Calculation of selection gradients for each year

```{r}
selgrads_FFD<-data.frame(data_selag %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel_y ~ FFD_s_y+n_fl_s_y, data = .)) %>% tidy(model))
selgrads_FFD$sig<-ifelse(selgrads_FFD$p.value<0.05,"*","") 
kable(subset(selgrads_FFD,term=="FFD_s_y"),digits=3)  #Linear selection gradients for FFD
#FFD * (selection for early flowering) in 1991,1992,1993,1994,2007,2010,2012,2014 (as in EL paper)
```

Plot selection gradients vs mean interactions

```{r echo=FALSE, fig.height=5, fig.width=18}
data_selag_means<-data_selag_means%>%
  left_join(subset(selgrads_FFD,term=="FFD_s_y")[c(1,3)])
grid.arrange(
  ggplot(data_selag_means,aes(x=n_seeds_per_fl_res_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean number of seeds per flower (residuals)"),
  ggplot(data_selag_means,aes(x=grazing_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean grazing"),
  ggplot(data_selag_means,aes(x=prop_seeds_esc_mean,y=estimate))+my_theme()+
  geom_point()+geom_smooth(method="lm")+ylab("Selection gradient for FFD")+
  xlab("Mean proportion of seeds escaping predation"),
  ncol=3)
```

Models for effects of mean interactions on selection gradients

```{r}
kable(summary(lm(estimate~n_seeds_per_fl_res_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~grazing_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~prop_seeds_esc_mean,data_selag_means))$coefficients)
kable(summary(lm(estimate~n_seeds_per_fl_res_mean+grazing_mean+prop_seeds_esc_mean,
                 data_selag_means))$coefficients)
```

No significant effects of yearly mean interactions on yearly selection gradients (but effect of grazing is ALMOST significant)

# 2. Models interactions ~ climate (across years)

Model selections for later constructing a path diagram.

Calculate successes/failures for grazing

```{r}
data_selag$grazing_success<-round(with(data_selag,ifelse(is.na(grazing_corr),NA,
                                                   ifelse(year<1997|year>2015,grazing_corr*n_fl,
                                                   ifelse(year>2006&year<2016,grazing_corr*shoot_vol,
                                                          999)))))
data_selag$grazing_failure<-round(with(data_selag,ifelse(is.na(grazing_corr),NA,
                                                   ifelse(year<1997|year>2015,n_fl-grazing_success,
                                                          ifelse(year>2006&year<2016,
                                                                 shoot_vol-grazing_success,
                                                                 999)))))
grazing_success_2006<-read.table(
  "C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/data/grazing_success_2006.csv",
  header=T,sep=",",dec=".")
data_selag<-data_selag%>%
  left_join(grazing_success_2006)
data_selag$grazing_success<-with(data_selag,ifelse(year==2006,gr_success,grazing_success))
data_selag$grazing_failure<-with(data_selag,ifelse(year==2006,gr_failure,grazing_failure))
data_selag$gr_success<-NULL
data_selag$gr_failure<-NULL
```

In these models, we use: fitness relativized accross years, FFD standardized accross years, n_fl, climatic variables and interactions not standardized. 

```{r}
data_selag$n_intact_seeds_rel<-data_selag$n_intact_seeds/mean(data_selag$n_intact_seeds,na.rm=T)
data_selag$FFD_s<-(data_selag$FFD-mean(data_selag$FFD,na.rm=T))/sd(data_selag$FFD,na.rm=T)
data_selag$n_fl_s<-(data_selag$n_fl-mean(data_selag$n_fl,na.rm=T))/sd(data_selag$n_fl,na.rm=T)
data_selag$mean_3_s<-(data_selag$mean_3-mean(data_selag$mean_3,na.rm=T))/sd(data_selag$mean_3,na.rm=T)
data_selag$mean_4_s<-(data_selag$mean_4-mean(data_selag$mean_4,na.rm=T))/sd(data_selag$mean_4,na.rm=T)
data_selag$mean_5_s<-(data_selag$mean_5-mean(data_selag$mean_5,na.rm=T))/sd(data_selag$mean_5,na.rm=T)
data_selag$mean_6_s<-(data_selag$mean_6-mean(data_selag$mean_6,na.rm=T))/sd(data_selag$mean_6,na.rm=T)
```

## Number of seeds per flower

```{r message=FALSE, warning=FALSE}
data_selag_subset1<-subset(data_selag,!is.na(n_seeds_per_fl)&!is.na(FFD_s))
globmod_n_seeds_per_fl_path_GLM<-glm(round(n_seeds_per_fl)~mean_3+mean_4+mean_5+
                                       FFD_s+n_fl+grazing_corr,data=data_selag_subset1,
                                     family="poisson",na.action="na.fail")
globmod_n_seeds_per_fl_path_GLMM<-glmer(round(n_seeds_per_fl)~mean_3+mean_4+mean_5+
                                       FFD_s+n_fl+grazing_corr+(1|id),data=data_selag_subset1,
                                       family="poisson",na.action="na.fail")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "data_selag_subset1")
clusterEvalQ(clust1, library(lme4))
modsel_n_seeds_per_fl_path_GLM<-pdredge(globmod_n_seeds_per_fl_path_GLM,cluster=clust1)
modsel_n_seeds_per_fl_path_GLMM<-pdredge(globmod_n_seeds_per_fl_path_GLMM,cluster=clust1)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(model.avg(modsel_n_seeds_per_fl_path_GLM,
                        subset=delta<2))$coefmat.full,digits=c(3,3,3,2,3)) # Coefs averaged model
kable(summary(model.avg(modsel_n_seeds_per_fl_path_GLMM,
                        subset=delta<2))$coefmat.full,digits=c(3,3,3,2,3)) # Coefs averaged model
r.squaredGLMM(get.models(modsel_n_seeds_per_fl_path_GLM,
                         subset=1)$"59") # R square of best model
r.squaredGLMM(get.models(modsel_n_seeds_per_fl_path_GLMM,
                         subset=1)$"59") # R square of best model
```

## Proportion of seeds escaping predation

```{r message=FALSE, warning=FALSE}
data_selag_subset2<-subset(subset(data_selag,n_seeds>0),!is.na(n_intact_seeds)&!is.na(n_fl_s)&!is.na(FFD_s))
globmod_prop_seeds_esc_path_GLM<-glm(cbind(round(n_intact_seeds),round(n_pred_seeds))~
                                     mean_3+mean_4+mean_5+mean_6+n_fl+FFD_s,
                                     data=data_selag_subset2,family="binomial",na.action="na.fail")
globmod_prop_seeds_esc_path_GLMM<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~
                                     mean_3+mean_4+mean_5+mean_6+n_fl+FFD_s+
                                     (1|id),data=data_selag_subset2,family="binomial",na.action="na.fail")
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust2 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust2, "data_selag_subset2")
clusterEvalQ(clust2, library(lme4))
modsel_prop_seeds_esc_path_GLM<-pdredge(globmod_prop_seeds_esc_path_GLM,cluster=clust2)
modsel_prop_seeds_esc_path_GLMM<-pdredge(globmod_prop_seeds_esc_path_GLMM,cluster=clust2)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_prop_seeds_esc_path_GLM,
                         subset=1)$"63")$coefficients,digits=c(3,3,2,3)) # Coefs best model
kable(summary(get.models(modsel_prop_seeds_esc_path_GLMM,subset=1)$"63")$coefficients,
      digits=c(3,3,2,3)) # Coefs best model, failed to converge
r.squaredGLMM(get.models(modsel_prop_seeds_esc_path_GLM,
                         subset=1)$"63") # R square of best model
r.squaredGLMM(get.models(modsel_prop_seeds_esc_path_GLMM,
                         subset=1)$"63") # R square of best model, failed to converge
```

## Grazing

```{r message=FALSE, warning=FALSE}
data_selag_subset3<-subset(data_selag,!is.na(grazing_success)&!is.na(FFD_s)&!is.na(n_fl))
globmod_grazing_path_GLM<-glm(cbind(grazing_success,grazing_failure)~mean_3+mean_4+mean_5+
                                n_fl+FFD_s,data = data_selag_subset3,
                              family="binomial",na.action="na.fail")
globmod_grazing_path_GLMM<-glmer(cbind(grazing_success,grazing_failure)~mean_3+mean_4+mean_5+
                                   n_fl+FFD_s+(1|id),data = data_selag_subset3,
                                 family="binomial",na.action="na.fail", nAGQ = 0)
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust3 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust3, "data_selag_subset3")
clusterEvalQ(clust3, library(lme4))
modsel_grazing_path_GLM<-pdredge(globmod_grazing_path_GLM,cluster=clust3)
modsel_grazing_path_GLMM<-pdredge(globmod_grazing_path_GLMM,cluster=clust3)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_grazing_path_GLM,subset=1)$"31")$coefficients,
      digits=c(3,3,2,3)) # Coefs best model
kable(summary(get.models(modsel_grazing_path_GLMM,subset=1)$"31")$coefficients,
      digits=c(3,3,2,3)) # Coefs best model
r.squaredGLMM(get.models(modsel_grazing_path_GLM,
                         subset=1)$"31") # R square of best model
r.squaredGLMM(get.models(modsel_grazing_path_GLMM,
                         subset=1)$"31") # R square of best model
```

## FFD

```{r message=FALSE, warning=FALSE}
data_selag_subset4<-subset(data_selag,!is.na(FFD_s))
globmod_FFD_path_GLM<-lm(FFD_s~mean_3+mean_4+mean_5,data = data_selag_subset4,na.action="na.fail")
globmod_FFD_path_GLMM<-lmer(FFD_s~mean_3+mean_4+mean_5+(1|id),
                            data = data_selag_subset4,na.action="na.fail")
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust4 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust4, "data_selag_subset4")
clusterEvalQ(clust4, library(lme4))
modsel_FFD_path_GLM<-pdredge(globmod_FFD_path_GLM,cluster=clust4)
modsel_FFD_path_GLMM<-pdredge(globmod_FFD_path_GLMM,cluster=clust4)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_FFD_path_GLM,
                         subset=1)$"7")$coefficients,digits=c(3,3,2,3)) # Coefs best model
kable(summary(get.models(modsel_FFD_path_GLMM,
                         subset=1)$"7")$coefficients,digits=c(3,3,1,2,3)) # Coefs best model
r.squaredGLMM(get.models(modsel_FFD_path_GLM,
                         subset=1)$"7") # R square of best model
r.squaredGLMM(get.models(modsel_FFD_path_GLMM,
                         subset=1)$"7") # R square of best model
```

## Fitness

```{r}
mod_n_intact_seeds1_GLM<-glm(round(n_intact_seeds_rel)~n_fl,data_selag,family="poisson")
mod_n_intact_seeds2_GLM<-glm(round(n_intact_seeds_rel)~n_seeds_per_fl,data_selag,
              family="poisson")
mod_n_intact_seeds3_GLM<-glm(round(n_intact_seeds_rel)~prop_seeds_esc,data_selag,
                           family="poisson")
mod_n_intact_seeds1_GLMM<-glmer(round(n_intact_seeds_rel)~n_fl+(1|id),data_selag,family="poisson",nAGQ=0)
mod_n_intact_seeds2_GLMM<-glmer(round(n_intact_seeds_rel)~n_seeds_per_fl+(1|id),data_selag,
              family="poisson")
mod_n_intact_seeds3_GLMM<-glmer(round(n_intact_seeds_rel)~prop_seeds_esc+(1|id),data_selag,
                           family="poisson")
kable(summary(mod_n_intact_seeds1_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds1_GLMM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds2_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds2_GLMM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds3_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds3_GLMM)$coefficients,digits=c(3,3,2,3))
```

## Correlation n fl - FFD

```{r}
with(data_selag,cor.test(n_fl,FFD_s))  # -0.372 *
```



# 3. Models interactions ~ climate (within years)

Model selections for later constructing a path diagram.

In these models, we use: fitness relativized within years, FFD and n_fl standardized within years and climatic variables standardized accross years, interactions not standardized (because interactions cannot be standardized when used as responses, so we do not standardize them at all). 

In this model, we do not include effects of temperature on FFD.


## Number of seeds per flower

```{r message=FALSE, warning=FALSE}
globmod_n_seeds_per_fl_path_GLM_y<-glm(round(n_seeds_per_fl)~mean_3+mean_4+mean_5+
                                       FFD_s_y+n_fl+grazing_corr,data=data_selag_subset1,
                                     family="poisson",na.action="na.fail")
globmod_n_seeds_per_fl_path_GLMM_y<-glmer(round(n_seeds_per_fl)~mean_3+mean_4+mean_5+
                                       FFD_s_y+n_fl+grazing_corr+(1|id),data=data_selag_subset1,
                                       family="poisson",na.action="na.fail")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "data_selag_subset1")
clusterEvalQ(clust1, library(lme4))
modsel_n_seeds_per_fl_path_GLM_y<-pdredge(globmod_n_seeds_per_fl_path_GLM_y,cluster=clust1)
modsel_n_seeds_per_fl_path_GLMM_y<-pdredge(globmod_n_seeds_per_fl_path_GLMM_y,cluster=clust1)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(model.avg(modsel_n_seeds_per_fl_path_GLM_y,
                        subset=delta<2))$coefmat.full,digits=c(3,3,3,2,3)) # Coefs averaged model
kable(summary(model.avg(modsel_n_seeds_per_fl_path_GLMM_y,
                        subset=delta<2))$coefmat.full,digits=c(3,3,3,2,3)) # Coefs averaged model
r.squaredGLMM(get.models(modsel_n_seeds_per_fl_path_GLM_y,
                         subset=1)$"59") # R square of best model
r.squaredGLMM(get.models(modsel_n_seeds_per_fl_path_GLMM_y,
                         subset=1)$"51") # R square of best model, failed to converge
```

## Proportion of seeds escaping predation

```{r message=FALSE, warning=FALSE}
globmod_prop_seeds_esc_path_GLM_y<-glm(cbind(round(n_intact_seeds),round(n_pred_seeds))~
                                     mean_3+mean_4+mean_5+mean_6+FFD_s_y+n_fl,
                                     data=data_selag_subset2,family="binomial",na.action="na.fail")
globmod_prop_seeds_esc_path_GLMM_y<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~
                                     mean_3+mean_4+mean_5+mean_6+FFD_s_y+n_fl+
                                     (1|id),data=data_selag_subset2,family="binomial",na.action="na.fail")
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust2 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust2, "data_selag_subset2")
clusterEvalQ(clust2, library(lme4))
modsel_prop_seeds_esc_path_GLM_y<-pdredge(globmod_prop_seeds_esc_path_GLM_y,cluster=clust2)
modsel_prop_seeds_esc_path_GLMM_y<-pdredge(globmod_prop_seeds_esc_path_GLMM_y,cluster=clust2)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_prop_seeds_esc_path_GLM_y,
                         subset=1)$"63")$coefficients,digits=c(3,3,2,3)) # Coefs best model
kable(summary(model.avg(modsel_prop_seeds_esc_path_GLMM_y,subset=delta<2))$coefmat.full,
      digits=c(3,3,2,3)) # Coefs averaged model, failed to converge
r.squaredGLMM(get.models(modsel_prop_seeds_esc_path_GLM_y,
                         subset=1)$"63") # R square of best model
r.squaredGLMM(get.models(modsel_prop_seeds_esc_path_GLMM_y,
                         subset=1)$"31") # R square of best model, failed to converge
```

## Grazing

```{r message=FALSE, warning=FALSE}
data_selag_subset3<-subset(data_selag,!is.na(grazing_success)&!is.na(FFD_s)&!is.na(n_fl))
globmod_grazing_path_GLM_y<-glm(cbind(grazing_success,grazing_failure)~mean_3+mean_4+mean_5+
                                n_fl+FFD_s_y,data = data_selag_subset3,
                              family="binomial",na.action="na.fail")
globmod_grazing_path_GLMM_y<-glmer(cbind(grazing_success,grazing_failure)~mean_3+mean_4+mean_5+
                                   n_fl+FFD_s_y+(1|id),data = data_selag_subset3,
                                 family="binomial",na.action="na.fail",nAGQ=0)
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust3 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust3, "data_selag_subset3")
clusterEvalQ(clust3, library(lme4))
modsel_grazing_path_GLM_y<-pdredge(globmod_grazing_path_GLM_y,cluster=clust3)
modsel_grazing_path_GLMM_y<-pdredge(globmod_grazing_path_GLMM_y,cluster=clust3)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_grazing_path_GLM_y,subset=1)$"31")$coefficients,
      digits=c(3,3,2,3)) # Coefs best model
kable(summary(get.models(modsel_grazing_path_GLMM_y,subset=1)$"31")$coefficients,
      digits=c(3,3,2,3)) # Coefs best model
r.squaredGLMM(get.models(modsel_grazing_path_GLM_y,
                         subset=1)$"31") # R square of best model
r.squaredGLMM(get.models(modsel_grazing_path_GLMM_y,
                         subset=1)$"31") # R square of best model
```

## Fitness

```{r}
mod_n_intact_seeds1_GLM_y<-glm(round(n_intact_seeds_rel_y)~n_fl,data_selag,family="poisson")
mod_n_intact_seeds2_GLM_y<-glm(round(n_intact_seeds_rel_y)~n_seeds_per_fl,data_selag,
              family="poisson")
mod_n_intact_seeds3_GLM_y<-glm(round(n_intact_seeds_rel_y)~prop_seeds_esc,data_selag,
                           family="poisson")
mod_n_intact_seeds1_GLMM_y<-glmer(round(n_intact_seeds_rel_y)~n_fl+(1|id),data_selag,
                                  family="poisson",nAGQ=0)
mod_n_intact_seeds2_GLMM_y<-glmer(round(n_intact_seeds_rel_y)~n_seeds_per_fl+(1|id),data_selag,
              family="poisson")
mod_n_intact_seeds3_GLMM_y<-glmer(round(n_intact_seeds_rel_y)~prop_seeds_esc+(1|id),data_selag,
                           family="poisson")
kable(summary(mod_n_intact_seeds1_GLM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds1_GLMM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds2_GLM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds2_GLMM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds3_GLM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_intact_seeds3_GLMM_y)$coefficients,digits=c(3,3,2,3))
```

## Correlation n fl - FFD

```{r}
with(data_selag,cor.test(n_fl,FFD_s_y))  # -0.366 *
```

# 4. Models without climate (across years)

```{r}
mod_n_seeds_per_fl_noclim_GLM<-glm(round(n_seeds_per_fl)~FFD_s+grazing_corr+n_fl,data_selag,
                          family="poisson")
mod_n_seeds_per_fl_noclim_GLMM<-glmer(round(n_seeds_per_fl)~FFD_s+grazing_corr+n_fl+(1|id),data_selag,
                          family="poisson")
kable(summary(mod_n_seeds_per_fl_noclim_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_seeds_per_fl_noclim_GLMM)$coefficients,digits=c(3,3,2,3))

mod_prop_seeds_esc_noclim_GLM<-glm(cbind(round(n_intact_seeds),round(n_pred_seeds))~FFD_s+n_fl,
                                   subset(data_selag,n_seeds>0),family="binomial")
mod_prop_seeds_esc_noclim_GLMM<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~FFD_s+n_fl+(1|id),
                                      subset(data_selag,n_seeds>0),family="binomial")
kable(summary(mod_prop_seeds_esc_noclim_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_prop_seeds_esc_noclim_GLMM)$coefficients,,digits=c(3,3,2,3))

mod_grazing_noclim_GLM<-glm(cbind(grazing_success,grazing_failure)~n_fl+FFD_s,data_selag,
                   family="binomial") 
mod_grazing_noclim_GLMM<-glmer(cbind(grazing_success,grazing_failure)~n_fl+FFD_s+(1|id),data_selag,
                   family="binomial",nAGQ=0) 
kable(summary(mod_grazing_noclim_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_grazing_noclim_GLMM)$coefficients,digits=c(3,3,2,3))
```

# 5. Models without climate (within years)

```{r}
mod_n_seeds_per_fl_noclim_GLM_y<-glm(round(n_seeds_per_fl)~FFD_s_y+grazing_corr+n_fl,data_selag,
                          family="poisson")
mod_n_seeds_per_fl_noclim_GLMM_y<-glmer(round(n_seeds_per_fl)~FFD_s_y+grazing_corr+n_fl+(1|id),
                                        data_selag,family="poisson",nAGQ=0)
kable(summary(mod_n_seeds_per_fl_noclim_GLM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_seeds_per_fl_noclim_GLMM_y)$coefficients,digits=c(3,3,2,3))

mod_prop_seeds_esc_noclim_GLM_y<-glm(cbind(round(n_intact_seeds),round(n_pred_seeds))~FFD_s_y+n_fl,
                                   subset(data_selag,n_seeds>0),family="binomial")
mod_prop_seeds_esc_noclim_GLMM_y<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~FFD_s_y+n_fl+
                                          (1|id),subset(data_selag,n_seeds>0),family="binomial",nAGQ=0)
kable(summary(mod_prop_seeds_esc_noclim_GLM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_prop_seeds_esc_noclim_GLMM_y)$coefficients,,digits=c(3,3,2,3))

mod_grazing_noclim_GLM_y<-glm(cbind(grazing_success,grazing_failure)~n_fl+FFD_s_y,data_selag,
                   family="binomial")
mod_grazing_noclim_GLMM_y<-glmer(cbind(grazing_success,grazing_failure)~n_fl+FFD_s_y+(1|id),data_selag,
                   family="binomial",nAGQ=0)
kable(summary(mod_grazing_noclim_GLM_y)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_grazing_noclim_GLMM_y)$coefficients,digits=c(3,3,2,3))
```

####################################################################################

<!-- # Graphs to be included in the paper (to be modified based on final path model) -->

<!-- ```{r message=FALSE, warning=FALSE} -->
<!-- mod_FFD_ns<-blmer(FFD~mean_4+mean_5+(1|id),data_selag) -->
<!-- mod_grazing_ns<-bglmer(grazing_corr~mean_4+FFD+ -->
<!--                 (1|id),data_selag,family="binomial") -->
<!-- mod_n_seeds_per_fl_ns<-bglmer(n_seeds_per_fl_round~FFD+ -->
<!--                             grazing_corr+(1|id),data_selag,family="poisson") -->
<!-- mod_prop_pred_seeds_ns<-bglmer(prop_pred_seeds~mean_6+FFD+(1|id), -->
<!--                            data_selag,family="binomial") -->
<!-- mod_n_intact_seeds1_ns<-bglmer(n_intact_seeds_round~n_fl+(1|id),data_selag,family="poisson") -->
<!-- mod_n_intact_seeds2_ns<-bglmer(n_intact_seeds_round~n_seeds_per_fl_round+(1|id),data_selag, -->
<!--               family="poisson") -->
<!-- mod_n_intact_seeds3_ns<-bglmer(n_intact_seeds_round~prop_pred_seeds+(1|id),data_selag, -->
<!--                            family="poisson") -->
<!-- ``` -->

<!-- ## FFD -->

<!-- ```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE} -->
<!-- fig1<- -->
<!--   grid.arrange( -->
<!--   ggplot()+my_theme()+xlab("Mean daily temperature April (ºC)")+ggtitle("A)")+ -->
<!--     ylab("First flowering date")+ -->
<!--     geom_point(data=data_selag,aes(mean_4,FFD),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "mean_4",mod= mod_FFD_ns,xlevels=10)), -->
<!--               aes(x=mean_4, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "mean_4",mod= mod_FFD_ns,xlevels=10)), -->
<!--                 aes(x=mean_4, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ggplot()+my_theme()+xlab("Mean daily temperature May (ºC)")+ylab(NULL)+ -->
<!--     theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+ -->
<!--     geom_point(data=data_selag,aes(mean_5,FFD),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "mean_5",mod= mod_FFD_ns,xlevels=10)), -->
<!--               aes(x=mean_5, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "mean_5",mod= mod_FFD_ns,xlevels=10)), -->
<!--                 aes(x=mean_5, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ncol=2) -->
<!-- ggsave(filename= -->
<!--          "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig1.tiff", -->
<!--        plot=fig1,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw") -->
<!-- ``` -->

<!-- ## Grazing -->

<!-- ```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE} -->
<!-- fig2<- -->
<!--   grid.arrange( -->
<!--   ggplot()+my_theme()+xlab("Mean daily temperature April (ºC)")+ylab("Proportion of grazing")+ -->
<!--     ggtitle("A)")+ -->
<!--     geom_point(data=data_selag,aes(mean_4,grazing_corr),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "mean_4",mod= mod_grazing_ns,xlevels=10)), -->
<!--               aes(x=mean_4, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "mean_4",mod= mod_grazing_ns,xlevels=10)), -->
<!--                 aes(x=mean_4, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ggplot()+my_theme()+xlab("First flowering date")+ylab(NULL)+ -->
<!--     theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+ -->
<!--     geom_point(data=data_selag,aes(FFD,grazing_corr),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_grazing_ns,xlevels=10)), -->
<!--               aes(x=FFD, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_grazing_ns,xlevels=10)), -->
<!--                 aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ncol=2) -->
<!-- ggsave(filename= -->
<!--          "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig2.tiff", -->
<!--        plot=fig2,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw") -->
<!-- ``` -->

<!-- ## N seeds per fl -->

<!-- ```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE} -->
<!-- fig3<- -->
<!--   grid.arrange( -->
<!--   ggplot()+my_theme()+xlab("First flowering date")+ggtitle("A)")+ -->
<!--     ylab("Number of seeds per flower")+ -->
<!--     geom_point(data=data_selag,aes(FFD,n_seeds_per_fl),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_n_seeds_per_fl_ns,xlevels=10)), -->
<!--               aes(x=FFD, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_n_seeds_per_fl_ns,xlevels=10)), -->
<!--                 aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ggplot()+my_theme()+xlab("Proportion of grazing")+ylab(NULL)+ -->
<!--     theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+ -->
<!--     geom_point(data=data_selag,aes(grazing_corr,n_seeds_per_fl),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "grazing_corr", -->
<!--                                         mod= mod_n_seeds_per_fl_ns,xlevels=10)), -->
<!--               aes(x=grazing_corr, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", -->
<!--                                           mod= mod_n_seeds_per_fl_ns,xlevels=10)), -->
<!--                 aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ncol=2) -->
<!-- ggsave(filename= -->
<!--          "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig3.tiff", -->
<!--        plot=fig3,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw") -->
<!-- ``` -->

<!-- ## Prop pred seeds -->

<!-- ```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE} -->
<!-- fig4<- -->
<!--   grid.arrange( -->
<!--   ggplot()+my_theme()+xlab("Mean daily temperature June (ºC)")+ -->
<!--     ylab("Proportion of predated seeds")+ -->
<!--     theme(axis.text.y=element_text(color="white"))+ggtitle("A)")+ -->
<!--     geom_point(data=data_selag,aes(mean_6,prop_pred_seeds),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "mean_6",mod= mod_prop_pred_seeds_ns,xlevels=10)), -->
<!--               aes(x=mean_6, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "mean_6", -->
<!--                                           mod= mod_prop_pred_seeds_ns,xlevels=10)), -->
<!--                 aes(x=mean_6, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ggplot()+my_theme()+xlab("First flowering date")+ylab(NULL)+ -->
<!--     theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+ -->
<!--     geom_point(data=data_selag,aes(FFD,prop_pred_seeds),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_prop_pred_seeds_ns,xlevels=10)), -->
<!--               aes(x=FFD, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_prop_pred_seeds_ns,xlevels=10)), -->
<!--                 aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ncol=2) -->
<!-- ggsave(filename= -->
<!--          "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig4.tiff", -->
<!--        plot=fig4,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw") -->
<!-- ``` -->

<!-- ## Number of intact seeds -->

<!-- ```{r echo=FALSE, fig.height=4.5, fig.width=13, message=FALSE, warning=FALSE} -->
<!-- fig5<- -->
<!--   grid.arrange( -->
<!--   ggplot()+my_theme()+xlab("Number of flowers")+ggtitle("A)")+ -->
<!--     ylab("Number of intact seeds")+ -->
<!--     geom_point(data=data_selag,aes(n_fl,n_intact_seeds_round),size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "n_fl",mod= mod_n_intact_seeds1_ns,xlevels=30)), -->
<!--               aes(x=n_fl, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "n_fl", -->
<!--                                           mod= mod_n_intact_seeds1_ns,xlevels=30)), -->
<!--                 aes(x=n_fl, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ggplot()+my_theme()+xlab("Number of seeds per flower")+ggtitle("B)")+ -->
<!--     ylab(NULL)+ -->
<!--     geom_point(data=data_selag,aes(n_seeds_per_fl_round,n_intact_seeds_round), -->
<!--                size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "n_seeds_per_fl_round", -->
<!--                                         mod= mod_n_intact_seeds2_ns,xlevels=30)), -->
<!--               aes(x=n_seeds_per_fl_round, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "n_seeds_per_fl_round", -->
<!--                                           mod= mod_n_intact_seeds2_ns,xlevels=30)), -->
<!--                 aes(x=n_seeds_per_fl_round, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ggplot()+my_theme()+xlab("Proportion of predated seeds")+ggtitle("C)")+ -->
<!--     ylab(NULL)+ -->
<!--     geom_point(data=data_selag,aes(prop_pred_seeds,n_intact_seeds_round), -->
<!--                size=2.5,alpha=0.1) + -->
<!--     geom_line(data=as.data.frame(effect(term= "prop_pred_seeds", -->
<!--                                         mod= mod_n_intact_seeds3_ns,xlevels=30)), -->
<!--               aes(x=prop_pred_seeds, y=fit),size=1) + -->
<!--     geom_ribbon(data=as.data.frame(effect(term= "prop_pred_seeds", -->
<!--                                           mod= mod_n_intact_seeds3_ns,xlevels=30)), -->
<!--                 aes(x=prop_pred_seeds, ymin=lower, ymax=upper), alpha= 0.3), -->
<!--   ncol=3) -->
<!-- ggsave(filename= -->
<!--          "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig5.tiff", -->
<!--        plot=fig5,device="tiff",width=30,height=10,units="cm",dpi=300,compression="lzw") -->
<!-- ``` -->







