---
title: "Lathyrus ms3: Selective agents"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggthemes)
library(MuMIn)
library(plyr)
library(knitr)
library(gridExtra)
library(lme4)
library(parallel)
library(lmerTest)
library(RPushbullet)
library(effects)
library(broom)
library(car)
library(grid)
library(blme)
library(RColorBrewer)
```

```{r Define ggplot themes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
```

# Data preparation

Load data, keep variables needed and merge

```{r Load data}
data_selag<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata_weather_subs.csv",header=T,sep="\t",dec=".") 
mean_weather<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/mean_weather.csv",header=T,sep="\t",dec=".")
```

```{r Keep vars}
data_selag<-data_selag[c(1:7,9:10,12,14:15,17:18,21,22)]
data_selag$n_fl<-data_selag$cum_n_fl
data_selag$cum_n_fl<-NULL
mean_weather<-mean_weather[c(1,7:10,19:22,31:34,43:46,103:106,115:118,127:130,139:142,
                             146:155)]
data_selag<-merge(data_selag,mean_weather,by="year")%>%
  arrange(.,id)

data_selag<-anti_join(data_selag,subset(data_selag,is.na(FFD)&is.na(grazing)&
                                          is.na(shoot_vol)&is.na(n_fr)&is.na(n_ovules)&
                                          is.na(n_seeds)&is.na(n_intact_seeds)&
                                          is.na(n_fl))) # Remove rows with all these NAs
names(data_selag)

```

List of variables in data set:

- year
- FFD: first flowering date (as number of days from vernal equinox)
- id: individual identifier (including "old" for individuals in period 1987-1996 and "new" for individuals in period 2006-2017)
- ruta, genet: identifiers for plots and ids in old data
- data: 1 if data available, 0 if not
- vernal: date of vernal equinox in each year
- grazing: proportion of grazing by deer
- shoot_vol: shoot volume
- n_fr: number of fruits
- n_ovules: number of ovules
- FFD_corr: first flowering date (as a date)
- period: "old" for 1987-1996 and "new" for 2006-2017
- n_seeds: number of seeds
- n_intact_seeds: number of intact (non-predated) seeds
- n_fl: number of flowers
- GDD3/5/7/10_3/4/5/6: number of growing degree days (base 3/5/7/10 ºC) in March/April/May/June
- max_3/4/5/6: average of daily maximum temperatures for March/April/May/June
- mean_3/4/5/6: average of daily mean temperatures for March/April/May/June
- min_3/4/5/6: average of daily minimum temperatures for March/April/May/June
- precipitation_3/4/5/6: sum of precipitation for March/April/May/June

Interactions that we will focus on:

- Pollination: fruit set (number of fruits per flower), seed set (number of seeds per ovule), number of seeds per fruit ´(not used so far), number of seeds per flower
- Seed predation: proportion of predated seeds
- Grazing (by deer) before flowering: proportion of grazing (probably converted to a binomial variable)

Calculate fruit set, seed set, number of seeds per fruit, number of seeds per flower, proportion of predated seeds

```{r calc interactions}
data_selag<-data_selag%>%
  mutate(fruit_set=n_fr/n_fl,seed_set=ifelse(fruit_set==0,0,n_seeds/n_ovules),
         n_seeds_per_fr=ifelse(fruit_set==0,0,n_seeds/n_fr),
         n_seeds_per_fl=n_seeds/n_fl,
         prop_seeds_esc=ifelse(n_seeds==0,NA,1-((n_seeds-n_intact_seeds)/n_seeds)),
         n_pred_seeds=n_seeds-n_intact_seeds)
```

# Histograms for interaction variables

```{r echo=FALSE, fig.height=9, fig.width=9, message=FALSE, warning=FALSE}
data_selag %>%
  pivot_longer(c(fruit_set:prop_seeds_esc,grazing), 
               names_to = "variable", values_to = "value") %>%
  ggplot(aes(x=value))+ geom_histogram(colour="black", fill="white")+
  facet_wrap(vars(variable), ncol = 2,scales="free") + my_theme()
```

# Models interactions ~ climate (mean temps only)

Using only mean temperatures. Using grazing as a proportion, and for 2008-2015 use values of proportion of aboveground volume. 

- 1987-1996: grazing = proportion of flowers removed
- 2006: grazing = proportion of grazed shoots
- 2007-2015: grazing = proportion of aboveground volume removed
- 2016-2017: grazing = proportion of flowers removed

Using blmer/bglmer (Maximum a posteriori estimation for linear and generalized linear mixed-effects models in a Bayesian setting) instead of lmer/glmer because the latter gave warning "singular fit" in some cases.

```{r message=FALSE, warning=FALSE}
grazing_new<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/data/grazing_new.csv",header=T,sep=",",dec=".") 
data_selag<-left_join(data_selag,grazing_new)%>%
  mutate(grazing_corr=ifelse(is.na(grazing_new),grazing,grazing_new))
```

Model selections for constructing path diagram

### Number of seeds per flower

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset21<-subset(data_selag[c(2:3,16,37:39,62,66)],!is.na(n_seeds_per_fl)&!is.na(FFD)) 
subset21[,c(1,3:6,8)]<-scale(subset21[,c(1,3:6,8)]) 

globmod_n_seeds_per_fl_path_GLM<-glm(round(n_seeds_per_fl)~mean_3+mean_4+mean_5+FFD+n_fl+grazing_corr,
                                     data=subset21,family="poisson",na.action="na.fail")
globmod_n_seeds_per_fl_path_GLMM<-glmer(round(n_seeds_per_fl)~mean_3+mean_4+mean_5+FFD+n_fl+grazing_corr+
                                     (1|id),data=subset21,family="poisson",na.action="na.fail")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust21 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust21, "subset21")
clusterEvalQ(clust21, library(lme4))
modsel_n_seeds_per_fl_path_GLM<-pdredge(globmod_n_seeds_per_fl_path_GLM,cluster=clust21)
modsel_n_seeds_per_fl_path_GLMM<-pdredge(globmod_n_seeds_per_fl_path_GLMM,cluster=clust21)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(model.avg(modsel_n_seeds_per_fl_path_GLM,
                        subset=delta<2))$coefmat.full,digits=c(3,3,3,2,3)) # Coefs averaged model
kable(summary(model.avg(modsel_n_seeds_per_fl_path_GLMM,
                        subset=delta<2))$coefmat.full,digits=c(3,3,3,2,3)) # Coefs averaged model
r.squaredGLMM(get.models(modsel_n_seeds_per_fl_path_GLM,
                         subset=1)$"59") # R square of best model
r.squaredGLMM(get.models(modsel_n_seeds_per_fl_path_GLMM,
                         subset=1)$"59") # R square of best model
```

### Proportion of seeds escaping predation

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset22<-subset(subset(data_selag,n_seeds>0)[c(2:3,15,16,37:40,64)],
                 !is.na(n_intact_seeds)&!is.na(FFD)&!is.na(n_fl)) 
subset22[,c(1,4:8)]<-scale(subset22[,c(1,4:8)]) 

globmod_prop_seeds_esc_path_GLM<-glm(cbind(round(n_intact_seeds),round(n_pred_seeds))~
                                     mean_3+mean_4+mean_5+mean_6+n_fl+FFD,
                                     data=subset22,family="binomial",na.action="na.fail")
globmod_prop_seeds_esc_path_GLMM<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~
                                     mean_3+mean_4+mean_5+mean_6+n_fl+FFD+
                                     (1|id),data=subset22,family="binomial",na.action="na.fail")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust22 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust22, "subset22")
clusterEvalQ(clust22, library(lme4))
modsel_prop_seeds_esc_path_GLM<-pdredge(globmod_prop_seeds_esc_path_GLM,cluster=clust22)
modsel_prop_seeds_esc_path_GLMM<-pdredge(globmod_prop_seeds_esc_path_GLMM,cluster=clust22)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_prop_seeds_esc_path_GLM,
                         subset=1)$"63")$coefficients,digits=c(3,3,2,3)) # Coefs best model
kable(summary(get.models(modsel_prop_seeds_esc_path_GLMM,
                         subset=1)$"63")$coefficients,digits=c(3,3,2,3)) # Coefs best model
r.squaredGLMM(get.models(modsel_prop_seeds_esc_path_GLM,
                         subset=1)$"63") # R square of best model
r.squaredGLMM(get.models(modsel_prop_seeds_esc_path_GLMM,
                         subset=1)$"63") # R square of best model
```

### Grazing (successes/failures)

```{r}
data_selag$grazing_success<-round(with(data_selag,ifelse(is.na(grazing_corr),NA,
                                                   ifelse(year<1997|year>2015,grazing_corr*n_fl,
                                                   ifelse(year>2006&year<2016,grazing_corr*shoot_vol,
                                                          999)))))
data_selag$grazing_failure<-round(with(data_selag,ifelse(is.na(grazing_corr),NA,
                                                   ifelse(year<1997|year>2015,n_fl-grazing_success,
                                                          ifelse(year>2006&year<2016,
                                                                 shoot_vol-grazing_success,
                                                                 999)))))
grazing_success_2006<-read.table(
  "C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/data/grazing_success_2006.csv",
  header=T,sep=",",dec=".")
data_selag<-data_selag%>%
  left_join(grazing_success_2006)
data_selag$grazing_success<-with(data_selag,ifelse(year==2006,gr_success,grazing_success))
data_selag$grazing_failure<-with(data_selag,ifelse(year==2006,gr_failure,grazing_failure))
```

```{r}
data_selag$gr_success<-NULL
data_selag$gr_failure<-NULL
```

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset24<-subset(data_selag[c(2:3,16,37:39,67:68)],!is.na(grazing_success)&!is.na(FFD)&
                   !is.na(n_fl)) 
subset24[,c(1,3:6)]<-scale(subset24[,c(1,3:6)]) 

globmod_grazing_path_sf_GLM<-glm(cbind(grazing_success,grazing_failure)~mean_3+mean_4+mean_5+FFD+n_fl,
                                 data = subset24,family="binomial",na.action="na.fail")
globmod_grazing_path_sf_GLMM<-glmer(cbind(grazing_success,grazing_failure)~mean_3+mean_4+mean_5+FFD+n_fl+
                              (1|id),data = subset24,family="binomial",na.action="na.fail")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust24 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust24, "subset24")
clusterEvalQ(clust24, library(lme4))
modsel_grazing_path_sf_GLM<-pdredge(globmod_grazing_path_sf_GLM,cluster=clust24)
modsel_grazing_path_sf_GLMM<-pdredge(globmod_grazing_path_sf_GLMM,cluster=clust24)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_grazing_path_sf_GLM,
                         subset=1)$"31")$coefficients,digits=c(3,3,2,3)) # Coefs best model
kable(summary(get.models(modsel_grazing_path_sf_GLMM,
                         subset=1)$"31")$coefficients,digits=c(3,3,2,3)) # Coefs best model
r.squaredGLMM(get.models(modsel_grazing_path_sf_GLMM,
                         subset=1)$"31") # R square of best model
r.squaredGLMM(get.models(modsel_grazing_path_sf_GLMM,
                         subset=1)$"31") # R square of best model
```

### FFD

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset26<-subset(data_selag[c(2:3,37:39)],!is.na(FFD)) 
subset26[,c(3:5)]<-scale(subset26[,c(3:5)]) 

globmod_FFD_path_GLM<-lm(FFD~mean_3+mean_4+mean_5,data = subset26,na.action="na.fail")
globmod_FFD_path_GLMM<-lmer(FFD~mean_3+mean_4+mean_5+(1|id),data = subset26,na.action="na.fail")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust26 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust26, "subset26")
clusterEvalQ(clust26, library(lme4))
modsel_FFD_path_GLM<-pdredge(globmod_FFD_path_GLM,cluster=clust26)
modsel_FFD_path_GLMM<-pdredge(globmod_FFD_path_GLMM,cluster=clust26)
```

Coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
kable(summary(get.models(modsel_FFD_path_GLM,
                         subset=1)$"7")$coefficients,digits=c(3,3,2,3)) # Coefs best model
kable(summary(get.models(modsel_FFD_path_GLMM,
                         subset=1)$"7")$coefficients,digits=c(3,3,1,2,3)) # Coefs best model
r.squaredGLMM(get.models(modsel_FFD_path_GLM,
                         subset=1)$"7") # R square of best model
r.squaredGLMM(get.models(modsel_FFD_path_GLMM,
                         subset=1)$"7") # R square of best model
```

# Models to build path diagram (to be modified based on final model selections)

```{r}
data_selag$mean_3_s<-scale(data_selag$mean_3)
data_selag$mean_4_s<-scale(data_selag$mean_4)
data_selag$mean_5_s<-scale(data_selag$mean_5)
data_selag$mean_6_s<-scale(data_selag$mean_6)
data_selag$FFD_s<-scale(data_selag$FFD)
data_selag$grazing_corr_s<-scale(data_selag$grazing_corr)
data_selag$n_fl_s<-scale(data_selag$n_fl)
data_selag$n_seeds_per_fl_round<-round(data_selag$n_seeds_per_fl)
data_selag$n_seeds_per_fl_round_s<-scale(round(data_selag$n_seeds_per_fl))
data_selag$prop_seeds_esc_s<-scale(data_selag$prop_seeds_esc)
data_selag<-as.data.frame(data_selag %>% group_by(year) %>%
  mutate(n_intact_seeds_rel=n_intact_seeds/mean(n_intact_seeds,na.rm=T))%>%  #Relative fitness
  mutate(FFD_std=(FFD-mean(FFD,na.rm=T))/sd(FFD,na.rm=T)) %>%                #Standardized FFD
  mutate(n_fl_std=(n_fl-mean(n_fl,na.rm=T))/sd(n_fl,na.rm=T)))               #Standardized n_fl
```

```{r}
with(data_selag,cor.test(n_fl,FFD)) 
# Correlation n_fl ~~ FFD -0.372 *

mod_n_intact_seeds1_GLM<-glm(round(n_intact_seeds_rel)~n_fl_s,data_selag,family="poisson")
mod_n_intact_seeds2_GLM<-glm(round(n_intact_seeds_rel)~n_seeds_per_fl_round_s,data_selag,
              family="poisson")
mod_n_intact_seeds3_GLM<-glm(round(n_intact_seeds_rel)~prop_seeds_esc_s,data_selag,
                           family="poisson")
mod_n_intact_seeds1_GLMM<-glmer(round(n_intact_seeds_rel)~n_fl_s+(1|id),data_selag,family="poisson")
mod_n_intact_seeds2_GLMM<-glmer(round(n_intact_seeds_rel)~n_seeds_per_fl_round_s+(1|id),data_selag,
              family="poisson")
mod_n_intact_seeds3_GLMM<-glmer(round(n_intact_seeds_rel)~prop_seeds_esc_s+(1|id),data_selag,
                           family="poisson")
kable(summary(mod_n_intact_seeds1_GLM)$coefficients)
kable(summary(mod_n_intact_seeds1_GLMM)$coefficients)
kable(summary(mod_n_intact_seeds2_GLM)$coefficients)
kable(summary(mod_n_intact_seeds2_GLMM)$coefficients)
kable(summary(mod_n_intact_seeds3_GLM)$coefficients)
kable(summary(mod_n_intact_seeds3_GLMM)$coefficients)

# Number of intact seeds <- n_fl 0.326 *
# Number of intact seeds <- n_seeds_per_fl_round 0.520 *
# Number of intact seeds <- prop_pred_seeds 0.705 *
```

# Relationship N seeds per fl ~ grazing with different measures

```{r}
# All years
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),data_selag,family="poisson")) 
# Years with grazing = proportion of flowers removed
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
              subset(data_selag,year<1997|year>2015),family="poisson")) 
# Years with grazing = proportion of grazed shoots
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
              subset(data_selag,year==2006),family="poisson")) 
# Years with grazing = proportion aboveground volume removed
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
              subset(data_selag,year>2006&year<2016),family="poisson")) 
# Coefs: -2.213, -2.667, -0.055 (NS), -3.311
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot()+my_theme()+
    geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
             aes(x=grazing_corr, y=fit), color="black") +  
  ylab("N seeds per fl (model estimate)") +
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
            aes(x=grazing_corr, y=fit), color="black") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="black")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="blue") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="blue") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="blue")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="green") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="green") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="green")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="red") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="red") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="red")
```

# Graphs to be included in the paper (to be modified based on final path model)

```{r message=FALSE, warning=FALSE}
mod_FFD_ns<-blmer(FFD~mean_4+mean_5+(1|id),data_selag)
mod_grazing_ns<-bglmer(grazing_corr~mean_4+FFD+
                (1|id),data_selag,family="binomial")
mod_n_seeds_per_fl_ns<-bglmer(n_seeds_per_fl_round~FFD+
                            grazing_corr+(1|id),data_selag,family="poisson")
mod_prop_pred_seeds_ns<-bglmer(prop_pred_seeds~mean_6+FFD+(1|id),
                           data_selag,family="binomial")
mod_n_intact_seeds1_ns<-bglmer(n_intact_seeds_round~n_fl+(1|id),data_selag,family="poisson")
mod_n_intact_seeds2_ns<-bglmer(n_intact_seeds_round~n_seeds_per_fl_round+(1|id),data_selag,
              family="poisson")
mod_n_intact_seeds3_ns<-bglmer(n_intact_seeds_round~prop_pred_seeds+(1|id),data_selag,
                           family="poisson")
```

## FFD

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig1<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Mean daily temperature April (ºC)")+ggtitle("A)")+
    ylab("First flowering date")+
    geom_point(data=data_selag,aes(mean_4,FFD),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_4",mod= mod_FFD_ns,xlevels=10)),
              aes(x=mean_4, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_4",mod= mod_FFD_ns,xlevels=10)),
                aes(x=mean_4, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Mean daily temperature May (ºC)")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(mean_5,FFD),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_5",mod= mod_FFD_ns,xlevels=10)),
              aes(x=mean_5, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_5",mod= mod_FFD_ns,xlevels=10)),
                aes(x=mean_5, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig1.tiff",
       plot=fig1,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## Grazing

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig2<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Mean daily temperature April (ºC)")+ylab("Proportion of grazing")+
    ggtitle("A)")+
    geom_point(data=data_selag,aes(mean_4,grazing_corr),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_4",mod= mod_grazing_ns,xlevels=10)),
              aes(x=mean_4, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_4",mod= mod_grazing_ns,xlevels=10)),
                aes(x=mean_4, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("First flowering date")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(FFD,grazing_corr),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_grazing_ns,xlevels=10)),
              aes(x=FFD, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_grazing_ns,xlevels=10)),
                aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig2.tiff",
       plot=fig2,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## N seeds per fl

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig3<-
  grid.arrange(
  ggplot()+my_theme()+xlab("First flowering date")+ggtitle("A)")+
    ylab("Number of seeds per flower")+
    geom_point(data=data_selag,aes(FFD,n_seeds_per_fl),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_n_seeds_per_fl_ns,xlevels=10)),
              aes(x=FFD, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_n_seeds_per_fl_ns,xlevels=10)),
                aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Proportion of grazing")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(grazing_corr,n_seeds_per_fl),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= mod_n_seeds_per_fl_ns,xlevels=10)),
              aes(x=grazing_corr, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr",
                                          mod= mod_n_seeds_per_fl_ns,xlevels=10)),
                aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig3.tiff",
       plot=fig3,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## Prop pred seeds

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig4<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Mean daily temperature June (ºC)")+
    ylab("Proportion of predated seeds")+
    theme(axis.text.y=element_text(color="white"))+ggtitle("A)")+
    geom_point(data=data_selag,aes(mean_6,prop_pred_seeds),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_6",mod= mod_prop_pred_seeds_ns,xlevels=10)),
              aes(x=mean_6, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_6",
                                          mod= mod_prop_pred_seeds_ns,xlevels=10)),
                aes(x=mean_6, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("First flowering date")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(FFD,prop_pred_seeds),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_prop_pred_seeds_ns,xlevels=10)),
              aes(x=FFD, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_prop_pred_seeds_ns,xlevels=10)),
                aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig4.tiff",
       plot=fig4,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## Number of intact seeds

```{r echo=FALSE, fig.height=4.5, fig.width=13, message=FALSE, warning=FALSE}
fig5<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Number of flowers")+ggtitle("A)")+
    ylab("Number of intact seeds")+
    geom_point(data=data_selag,aes(n_fl,n_intact_seeds_round),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "n_fl",mod= mod_n_intact_seeds1_ns,xlevels=30)),
              aes(x=n_fl, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "n_fl",
                                          mod= mod_n_intact_seeds1_ns,xlevels=30)),
                aes(x=n_fl, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Number of seeds per flower")+ggtitle("B)")+
    ylab(NULL)+
    geom_point(data=data_selag,aes(n_seeds_per_fl_round,n_intact_seeds_round),
               size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "n_seeds_per_fl_round",
                                        mod= mod_n_intact_seeds2_ns,xlevels=30)),
              aes(x=n_seeds_per_fl_round, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "n_seeds_per_fl_round",
                                          mod= mod_n_intact_seeds2_ns,xlevels=30)),
                aes(x=n_seeds_per_fl_round, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Proportion of predated seeds")+ggtitle("C)")+
    ylab(NULL)+
    geom_point(data=data_selag,aes(prop_pred_seeds,n_intact_seeds_round),
               size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "prop_pred_seeds",
                                        mod= mod_n_intact_seeds3_ns,xlevels=30)),
              aes(x=prop_pred_seeds, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "prop_pred_seeds",
                                          mod= mod_n_intact_seeds3_ns,xlevels=30)),
                aes(x=prop_pred_seeds, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=3)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig5.tiff",
       plot=fig5,device="tiff",width=30,height=10,units="cm",dpi=300,compression="lzw")
```


# Path model without climatic variables

```{r}
mod_grazing_noclim_GLM<-glm(cbind(grazing_success,grazing_failure)~n_fl_s+FFD_s,data_selag,
                   family="binomial")
mod_grazing_noclim_GLMM<-glmer(cbind(grazing_success,grazing_failure)~n_fl_s+FFD_s+(1|id),data_selag,
                   family="binomial")
kable(summary(mod_grazing_noclim_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_grazing_noclim_GLMM)$coefficients,digits=c(3,3,2,3))

mod_n_seeds_per_fl_noclim_GLM<-glm(n_seeds_per_fl_round~FFD_s+grazing_corr_s+n_fl_s,data_selag,
                          family="poisson")
mod_n_seeds_per_fl_noclim_GLMM<-glmer(n_seeds_per_fl_round~FFD_s+grazing_corr_s+n_fl_s+(1|id),data_selag,
                          family="poisson")
kable(summary(mod_n_seeds_per_fl_noclim_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_n_seeds_per_fl_noclim_GLMM)$coefficients,digits=c(3,3,2,3))

mod_prop_seeds_esc_noclim_GLM<-glm(cbind(round(n_intact_seeds),round(n_pred_seeds))~FFD_s+n_fl_s,
                                   subset(data_selag,n_seeds>0),family="binomial")
mod_prop_seeds_esc_noclim_GLMM<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~FFD_s+n_fl_s+(1|id),
                                      subset(data_selag,n_seeds>0),family="binomial")
kable(summary(mod_prop_seeds_esc_noclim_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_prop_seeds_esc_noclim_GLMM)$coefficients,,digits=c(3,3,2,3))
```

# Effects of yearly intensity of interactions on selection

## Model with pollination (residuals) and grazing

Because grazing influences (decreases) the number of seeds per flower. 

```{r}
data_selag$n_seeds_per_fl_res<-with(data_selag,ifelse(is.na(n_seeds_per_fl),NA,
                                           residuals(lm(n_seeds_per_fl~grazing_corr,
                                               data=data_selag))))
mod_int_sel1_GLM<-lm(n_intact_seeds_rel ~ FFD_std+n_fl_std+n_seeds_per_fl_res+grazing_corr+
               FFD_std:n_seeds_per_fl_res+FFD_std:grazing_corr,data_selag)
mod_int_sel1_GLMM<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+n_seeds_per_fl_res+grazing_corr+
               FFD_std:n_seeds_per_fl_res+FFD_std:grazing_corr+(1|id),data_selag)
kable(summary(mod_int_sel1_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_int_sel1_GLMM)$coefficients,digits=c(3,3,1,2,3))
```

Significant effect of grazing, but not of pollination, on selection.

## Model with all three interactions (residuals of pollination)

```{r}
mod_int_sel2_GLM<-lm(n_intact_seeds_rel ~ FFD_std+n_fl_std+
                     n_seeds_per_fl_res+grazing_corr+prop_seeds_esc+
                     FFD_std:n_seeds_per_fl_res+FFD_std:grazing_corr+FFD_std:prop_seeds_esc,
                     data_selag)
mod_int_sel2_GLMM<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+
                     n_seeds_per_fl_res+grazing_corr+prop_seeds_esc+
                     FFD_std:n_seeds_per_fl_res+FFD_std:grazing_corr+FFD_std:prop_seeds_esc+
                     (1|id),data_selag)
kable(summary(mod_int_sel2_GLM)$coefficients,digits=c(3,3,2,3))
kable(summary(mod_int_sel2_GLMM)$coefficients,digits=c(3,3,1,2,3))
```

### Graphs of interaction effects (to be modified based on choice of GLMs or GLMMs)

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction1<-data.frame(effect(term="FFD_std:grazing_corr",mod=mod_int_sel1_GLMM,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1),
                                    grazing_corr=seq(0,1,0.05))))
interaction1$fit_mod<-with(interaction1,ifelse(fit<0,0,fit))

myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
ggplot(interaction1, aes(FFD_std,fit_mod, group = as.factor(grazing_corr)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=grazing_corr))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Proportion of grazing")
```

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction2<-data.frame(effect(term="FFD_std:prop_seeds_esc",mod=mod_int_sel2_GLMM,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1),
                                    prop_seeds_esc=seq(0,1,0.05))))
interaction2$fit_mod<-with(interaction2,ifelse(fit<0,0,fit))

ggplot(interaction2, aes(FFD_std,fit_mod, group = as.factor(prop_seeds_esc)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=prop_seeds_esc))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Proportion of seeds that escaped predation")
```







