---
title: "Lathyrus ms3: Selective agents"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggthemes)
library(MuMIn)
library(plyr)
library(knitr)
library(gridExtra)
library(lme4)
library(parallel)
library(lmerTest)
library(RPushbullet)
library(effects)
library(broom)
library(car)
library(grid)
library(blme)
library(RColorBrewer)
```

```{r Define ggplot themes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
```

# Data preparation

Load data, keep variables needed and merge

```{r Load data}
data_selag<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata_weather_subs.csv",header=T,sep="\t",dec=".") 
mean_weather<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/mean_weather.csv",header=T,sep="\t",dec=".")
```

```{r Keep vars}
data_selag<-data_selag[c(1:7,9:10,12,14:15,17:18,21,22)]
data_selag$n_fl<-data_selag$cum_n_fl
data_selag$cum_n_fl<-NULL
mean_weather<-mean_weather[c(1,7:10,19:22,31:34,43:46,103:106,115:118,127:130,139:142,
                             146:155)]
data_selag<-merge(data_selag,mean_weather,by="year")%>%
  arrange(.,id)

data_selag<-anti_join(data_selag,subset(data_selag,is.na(FFD)&is.na(grazing)&
                                          is.na(shoot_vol)&is.na(n_fr)&is.na(n_ovules)&
                                          is.na(n_seeds)&is.na(n_intact_seeds)&
                                          is.na(n_fl))) # Remove rows with all these NAs
names(data_selag)

```

List of variables in data set:

- year
- FFD: first flowering date (as number of days from vernal equinox)
- id: individual identifier (including "old" for individuals in period 1987-1996 and "new" for individuals in period 2006-2017)
- ruta, genet: identifiers for plots and ids in old data
- data: 1 if data available, 0 if not
- vernal: date of vernal equinox in each year
- grazing: proportion of grazing by deer
- shoot_vol: shoot volume
- n_fr: number of fruits
- n_ovules: number of ovules
- FFD_corr: first flowering date (as a date)
- period: "old" for 1987-1996 and "new" for 2006-2017
- n_seeds: number of seeds
- n_intact_seeds: number of intact (non-predated) seeds
- n_fl: number of flowers
- GDD3/5/7/10_3/4/5/6: number of growing degree days (base 3/5/7/10 ºC) in March/April/May/June
- max_3/4/5/6: average of daily maximum temperatures for March/April/May/June
- mean_3/4/5/6: average of daily mean temperatures for March/April/May/June
- min_3/4/5/6: average of daily minimum temperatures for March/April/May/June
- precipitation_3/4/5/6: sum of precipitation for March/April/May/June

Interactions that we will focus on:

- Pollination: fruit set (number of fruits per flower), seed set (number of seeds per ovule), number of seeds per fruit ´(not used so far), number of seeds per flower
- Seed predation: proportion of predated seeds
- Grazing (by deer) before flowering: proportion of grazing (probably converted to a binomial variable)

Calculate fruit set, seed set, number of seeds per fruit, number of seeds per flower, proportion of predated seeds

```{r calc interactions}
data_selag<-data_selag%>%
  mutate(fruit_set=n_fr/n_fl,seed_set=ifelse(fruit_set==0,0,n_seeds/n_ovules),
         n_seeds_per_fr=ifelse(fruit_set==0,0,n_seeds/n_fr),
         n_seeds_per_fl=n_seeds/n_fl,
         prop_seeds_esc=ifelse(n_seeds==0,NA,1-((n_seeds-n_intact_seeds)/n_seeds)),
         n_pred_seeds=n_seeds-n_intact_seeds)
```

# Histograms for interaction variables

```{r echo=FALSE, fig.height=9, fig.width=9, message=FALSE, warning=FALSE}
data_selag %>%
  pivot_longer(c(fruit_set:prop_seeds_esc,grazing), 
               names_to = "variable", values_to = "value") %>%
  ggplot(aes(x=value))+ geom_histogram(colour="black", fill="white")+
  facet_wrap(vars(variable), ncol = 2,scales="free") + my_theme()
```

# Models interactions ~ climate (mean temps only)

Using only mean temperatures. Using grazing as a proportion, and for 2008-2015 use values of proportion of aboveground volume. 

- 1987-1996: grazing = proportion of flowers removed
- 2006: grazing = proportion of grazed shoots
- 2007-2015: grazing = proportion of aboveground volume removed
- 2016-2017: grazing = proportion of flowers removed

Using blmer/bglmer (Maximum a posteriori estimation for linear and generalized linear mixed-effects models in a Bayesian setting) instead of lmer/glmer because the latter gave warning "singular fit" in some cases.

```{r message=FALSE, warning=FALSE}
grazing_new<-read.table("C:/Users/user/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/data/grazing_new.csv",header=T,sep=",",dec=".") 
data_selag<-left_join(data_selag,grazing_new)%>%
  mutate(grazing_corr=ifelse(is.na(grazing_new),grazing,grazing_new))
```

Model selections for constructing path diagram

### Number of seeds per flower

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset21<-subset(data_selag[c(2:3,16,37:39,62,66)],!is.na(n_seeds_per_fl)&!is.na(FFD)) 
subset21[,c(1,3:6,8)]<-scale(subset21[,c(1,3:6,8)]) 

globmod_n_seeds_per_fl_path<-glmer(round(n_seeds_per_fl)~mean_3+mean_4+mean_5+FFD+n_fl+grazing_corr+
                                     (1|id),data=subset21,family="poisson",na.action="na.fail")

# Excluding collinear variables with r > 0.4
smat21 <- abs(cor(subset21[, -c(2,7)])) <= .4 # TRUE: cor<=0.4,FALSE: cor>0.4
smat21[!lower.tri(smat21)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust21 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust21, "subset21")
clusterEvalQ(clust21, library(lme4))
modsel_n_seeds_per_fl_path<-pdredge(globmod_n_seeds_per_fl_path,subset=smat21,cluster=clust21)
```

Variable importance, coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
importance(modsel_n_seeds_per_fl_path) # Variable importance
kable(summary(get.models(modsel_n_seeds_per_fl_path,
                         subset=1)$"43")$coefficients) # Coefs best model
r.squaredGLMM(get.models(modsel_n_seeds_per_fl_path,
                         subset=1)$"43") # R square of best model
```

### Proportion of seeds escaping predation

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset22<-subset(subset(data_selag,n_seeds>0)[c(2:3,15,16,37:40,64)],
                 !is.na(n_intact_seeds)&!is.na(FFD)&!is.na(n_fl)) 
subset22[,c(1,4:8)]<-scale(subset22[,c(1,4:8)]) 

globmod_prop_seeds_esc_path<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~
                                     mean_3+mean_4+mean_5+mean_6+n_fl+FFD+
                                     (1|id),data=subset22,family="binomial",na.action="na.fail")

# Excluding collinear variables with r > 0.4
smat22 <- abs(cor(subset22[, -c(2:3,9)])) <= .4 # TRUE: cor<=0.4,FALSE: cor>0.4
smat22[!lower.tri(smat22)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust22 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust22, "subset22")
clusterEvalQ(clust22, library(lme4))
modsel_prop_seeds_esc_path<-pdredge(globmod_prop_seeds_esc_path,subset=smat22,cluster=clust22)
```

Variable importance, coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
importance(modsel_prop_seeds_esc_path) # Variable importance
kable(summary(model.avg(modsel_prop_seeds_esc_path,
                         subset=delta<2))$coefmat.full) # Coefs averaged model
r.squaredGLMM(get.models(modsel_prop_seeds_esc_path,
                         subset=1)$"18") # R square of best model
```

### Grazing (proportion)

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset23<-subset(data_selag[c(2:3,16,37:39,66)],!is.na(grazing_corr)&!is.na(FFD)&
                   !is.na(n_fl)) 
subset23[,c(1,3:6)]<-scale(subset23[,c(1,3:6)]) 

globmod_grazing_path<-glmer(grazing_corr~mean_3+mean_4+mean_5+FFD+n_fl+
                              (1|id),data = subset23,family="binomial",na.action="na.fail")

# Excluding collinear variables with r > 0.4
smat23 <- abs(cor(subset23[, -c(2,7)])) <= .4 # TRUE: cor<=0.4,FALSE: cor>0.4
smat23[!lower.tri(smat23)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust23 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust23, "subset23")
clusterEvalQ(clust23, library(lme4))
modsel_grazing_path<-pdredge(globmod_grazing_path,subset=smat23,cluster=clust23)
```

Variable importance, coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
importance(modsel_grazing_path) # Variable importance
kable(summary(model.avg(modsel_grazing_path,subset=delta<2))$coefmat.full) # Coefs averaged model
r.squaredGLMM(get.models(modsel_grazing_path,
                         subset=1)$"18") # R square of best model
```

### Grazing (success/failure)

```{r message=FALSE, warning=FALSE}
data_selag$grazing_success<-round(data_selag$grazing_corr*100)
data_selag$grazing_failure<-100-data_selag$grazing_success
# Variables to use (march-may)
subset23<-subset(data_selag[c(2:3,16,37:39,67:68)],!is.na(grazing_success)&!is.na(FFD)&
                   !is.na(n_fl)) 
#subset23<-subset(data_selag[c(2:3,16,37:39,66)],!is.na(grazing_corr)&!is.na(FFD)&
#                   !is.na(n_fl)) 
subset23[,c(1,3:6)]<-scale(subset23[,c(1,3:6)]) 

globmod_grazing_path<-glmer(cbind(grazing_success,grazing_failure)~mean_3+mean_4+mean_5+FFD+n_fl+
#globmod_grazing_path<-glmer(grazing_corr~mean_3+mean_4+mean_5+FFD+n_fl+
                              (1|id),data = subset23,family="binomial",na.action="na.fail")

# Excluding collinear variables with r > 0.4
smat23 <- abs(cor(subset23[, -c(2,7:8)])) <= .4 # TRUE: cor<=0.4,FALSE: cor>0.4
#smat23 <- abs(cor(subset23[, -c(2,7)])) <= .4 # TRUE: cor<=0.4,FALSE: cor>0.4
smat23[!lower.tri(smat23)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust23 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust23, "subset23")
clusterEvalQ(clust23, library(lme4))
modsel_grazing_path<-pdredge(globmod_grazing_path,subset=smat23,cluster=clust23)
```

Variable importance, coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
importance(modsel_grazing_path) # Variable importance
kable(summary(get.models(modsel_grazing_path,
                         subset=1)$"28")$coefficients) # Coefs best model
r.squaredGLMM(get.models(modsel_grazing_path,
                         subset=1)$"28") # R square of best model
```

### FFD

```{r message=FALSE, warning=FALSE}
# Variables to use (march-may)
subset24<-subset(data_selag[c(2:3,37:39)],!is.na(FFD)) 
subset24[,c(3:5)]<-scale(subset24[,c(3:5)]) 

globmod_FFD_path<-lmer(FFD~mean_3+mean_4+mean_5+(1|id),data = subset24,na.action="na.fail")

# Excluding collinear variables with r > 0.4
smat24 <- abs(cor(subset24[, -c(1:2)])) <= .4 # TRUE: cor<=0.4,FALSE: cor>0.4
smat24[!lower.tri(smat24)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust24 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust24, "subset24")
clusterEvalQ(clust24, library(lme4))
modsel_FFD_path<-pdredge(globmod_FFD_path,subset=smat24,cluster=clust24)
```

Variable importance, coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
importance(modsel_FFD_path) # Variable importance
kable(summary(get.models(modsel_FFD_path,
                         subset=1)$"6")$coefficients) # Coefs best model
r.squaredGLMM(get.models(modsel_FFD_path,
                         subset=1)$"6") # R square of best model
```

# Models to build path diagram

```{r}
data_selag$mean_3_s<-scale(data_selag$mean_3)
data_selag$mean_4_s<-scale(data_selag$mean_4)
data_selag$mean_5_s<-scale(data_selag$mean_5)
data_selag$mean_6_s<-scale(data_selag$mean_6)
data_selag$FFD_s<-scale(data_selag$FFD)
data_selag$grazing_corr_s<-scale(data_selag$grazing_corr)
data_selag$n_fl_s<-scale(data_selag$n_fl)
data_selag$n_seeds_per_fl_round<-round(data_selag$n_seeds_per_fl)
data_selag$n_seeds_per_fl_round_s<-scale(round(data_selag$n_seeds_per_fl))
data_selag$prop_seeds_esc_s<-scale(data_selag$prop_seeds_esc)
data_selag$n_intact_seeds_round<-round(data_selag$n_intact_seeds)
data_selag<-as.data.frame(data_selag %>% group_by(year) %>%
  mutate(n_intact_seeds_rel_round=round(n_intact_seeds/mean(n_intact_seeds,na.rm=T))))
```

```{r}
with(data_selag,cor.test(n_fl,FFD)) 
# Correlation n_fl ~~ FFD -0.372 *

mod_FFD<-lmer(FFD~mean_4_s+mean_5_s+(1|id),data_selag)
summary(mod_FFD) 
# FFD <- mean_4 -2.305 * 
# FFD <- mean_5 -4.774 * 

mod_grazing<-glmer(cbind(grazing_success,grazing_failure)~mean_4_s+mean_5_s+n_fl_s+(1|id),data_selag,
                   family="binomial")
summary(mod_grazing) 
# Grazing <- mean_4 -0.472 * 
# Grazing <- mean_5 -0.939 * 
# Grazing <- n_fl 0.074* 

mod_n_seeds_per_fl<-glmer(n_seeds_per_fl_round~FFD_s+grazing_corr_s+mean_4_s+n_fl_s+(1|id),data_selag,
                          family="poisson")
summary(mod_n_seeds_per_fl) 
# Number of seeds per flower <- FFD -0.210 * 
# Number of seeds per flower <- grazing -0.718 * 
# Number of seeds per flower <- mean_4 -0.053 *
# Number of seeds per flower <- n_fl -0.237 *

mod_prop_seeds_esc<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~mean_6_s+FFD_s+n_fl_s+
                            (1|id),data_selag,family="binomial")
summary(mod_prop_seeds_esc)
# Proportion of seeds escaping predation<- mean_6 -0.788 * 
# Proportion of seeds escaping predation <- FFD -0.534 * 
# Proportion of seeds escaping predation <- n_fl -0.083 *

mod_n_intact_seeds1<-glmer(n_intact_seeds_rel_round~n_fl_s+(1|id),data_selag,family="poisson")
mod_n_intact_seeds2<-glmer(n_intact_seeds_rel_round~n_seeds_per_fl_round_s+(1|id),data_selag,
              family="poisson")
mod_n_intact_seeds3<-glmer(n_intact_seeds_rel_round~prop_seeds_esc_s+(1|id),data_selag,
                           family="poisson")
summary(mod_n_intact_seeds1)
summary(mod_n_intact_seeds2)
summary(mod_n_intact_seeds3)

# Number of intact seeds <- n_fl 0.323 *
# Number of intact seeds <- n_seeds_per_fl_round 0.520 *
# Number of intact seeds <- prop_pred_seeds 0.705 *
```

# Relationship N seeds per fl ~ grazing with different measures

```{r}
# All years
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),data_selag,family="poisson")) 
# Years with grazing = proportion of flowers removed
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
              subset(data_selag,year<1997|year>2015),family="poisson")) 
# Years with grazing = proportion of grazed shoots
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
              subset(data_selag,year==2006),family="poisson")) 
# Years with grazing = proportion aboveground volume removed
summary(bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
              subset(data_selag,year>2006&year<2016),family="poisson")) 
# Coefs: -2.213, -2.667, -0.055 (NS), -3.311
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot()+my_theme()+
    geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
             aes(x=grazing_corr, y=fit), color="black") +  
  ylab("N seeds per fl (model estimate)") +
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
            aes(x=grazing_corr, y=fit), color="black") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="black")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="blue") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="blue") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="blue")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="green") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="green") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="green")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="red") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="red") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="red")
```

# Correct grazing in 2006 (not used)

In 2006, grazing was measured as the proportion of grazed shoots. This might overestimate grazing if for example a plant with one shoot was only a bit grazed, as the proportion of grazed shoots, i.e. the value of grazing, would still be 1. To correct for this, I calculated the mean grazing in grazed plants (grazing > 0) with one shoot in 2007-2017, which was 0.8382075472. I then multiply grazing in 2006 by this value to correct for overestimation. 


```{r}
data_selag$grazing_corr2<-with(data_selag,
                               ifelse(year==2006,grazing_corr*0.8382075472,grazing_corr))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot()+my_theme()+
    geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
             aes(x=grazing_corr, y=fit), color="black") +  
  ylab("N seeds per fl (model estimate)") +
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
            aes(x=grazing_corr, y=fit), color="black") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                data_selag,family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="black")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="blue") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="blue") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year<1997|year>2015),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="blue")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr2",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr2+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
             aes(x=grazing_corr2, y=fit), color="green") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr2",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr2+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
            aes(x=grazing_corr2, y=fit), color="green") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr2", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr2+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
              aes(x=grazing_corr2, ymin=lower, ymax=upper), alpha= 0.3, fill="green")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="red") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="red") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year>2006&year<2016),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="red")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
subset(data_selag,year==2006) %>% 
  gather(key=Type, value=Value,c(grazing_corr,grazing_corr2)) %>% 
  ggplot(aes(x=Value,fill=Type)) + geom_histogram(position="identity",alpha=0.5,bins=10)+
  ggtitle("Distribution of grazing in 2006")+my_theme_legend()+
  scale_fill_discrete(name = "Grazing", labels = c("Before correction", "After correction"))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot()+my_theme()+
    geom_point(data=as.data.frame(effect(term= "grazing_corr",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
             aes(x=grazing_corr, y=fit), color="green") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
            aes(x=grazing_corr, y=fit), color="green") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
              aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3, fill="green")+
  geom_point(data=as.data.frame(effect(term= "grazing_corr2",
                                      mod=bglmer(n_seeds_per_fl_round~grazing_corr2+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
             aes(x=grazing_corr2, y=fit), color="orange") +   
    geom_line(data=as.data.frame(effect(term= "grazing_corr2",
                                        mod= bglmer(n_seeds_per_fl_round~grazing_corr2+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
            aes(x=grazing_corr2, y=fit), color="orange") +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr2", 
                                          mod= bglmer(n_seeds_per_fl_round~grazing_corr2+(1|id),
                                                subset(data_selag,year==2006),
                                                family="poisson"))),
              aes(x=grazing_corr2, ymin=lower, ymax=upper), alpha= 0.3, fill="orange")+
  ylab("N seeds per fl (model estimate)")+ggtitle("2006")
```

# Graphs to be included in the paper (to be modified based on final path model)

```{r message=FALSE, warning=FALSE}
mod_FFD_ns<-blmer(FFD~mean_4+mean_5+(1|id),data_selag)
mod_grazing_ns<-bglmer(grazing_corr~mean_4+FFD+
                (1|id),data_selag,family="binomial")
mod_n_seeds_per_fl_ns<-bglmer(n_seeds_per_fl_round~FFD+
                            grazing_corr+(1|id),data_selag,family="poisson")
mod_prop_pred_seeds_ns<-bglmer(prop_pred_seeds~mean_6+FFD+(1|id),
                           data_selag,family="binomial")
mod_n_intact_seeds1_ns<-bglmer(n_intact_seeds_round~n_fl+(1|id),data_selag,family="poisson")
mod_n_intact_seeds2_ns<-bglmer(n_intact_seeds_round~n_seeds_per_fl_round+(1|id),data_selag,
              family="poisson")
mod_n_intact_seeds3_ns<-bglmer(n_intact_seeds_round~prop_pred_seeds+(1|id),data_selag,
                           family="poisson")
```

## FFD

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig1<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Mean daily temperature April (ºC)")+ggtitle("A)")+
    ylab("First flowering date")+
    geom_point(data=data_selag,aes(mean_4,FFD),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_4",mod= mod_FFD_ns,xlevels=10)),
              aes(x=mean_4, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_4",mod= mod_FFD_ns,xlevels=10)),
                aes(x=mean_4, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Mean daily temperature May (ºC)")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(mean_5,FFD),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_5",mod= mod_FFD_ns,xlevels=10)),
              aes(x=mean_5, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_5",mod= mod_FFD_ns,xlevels=10)),
                aes(x=mean_5, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig1.tiff",
       plot=fig1,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## Grazing

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig2<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Mean daily temperature April (ºC)")+ylab("Proportion of grazing")+
    ggtitle("A)")+
    geom_point(data=data_selag,aes(mean_4,grazing_corr),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_4",mod= mod_grazing_ns,xlevels=10)),
              aes(x=mean_4, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_4",mod= mod_grazing_ns,xlevels=10)),
                aes(x=mean_4, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("First flowering date")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(FFD,grazing_corr),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_grazing_ns,xlevels=10)),
              aes(x=FFD, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_grazing_ns,xlevels=10)),
                aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig2.tiff",
       plot=fig2,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## N seeds per fl

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig3<-
  grid.arrange(
  ggplot()+my_theme()+xlab("First flowering date")+ggtitle("A)")+
    ylab("Number of seeds per flower")+
    geom_point(data=data_selag,aes(FFD,n_seeds_per_fl),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_n_seeds_per_fl_ns,xlevels=10)),
              aes(x=FFD, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_n_seeds_per_fl_ns,xlevels=10)),
                aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Proportion of grazing")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(grazing_corr,n_seeds_per_fl),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "grazing_corr",
                                        mod= mod_n_seeds_per_fl_ns,xlevels=10)),
              aes(x=grazing_corr, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "grazing_corr",
                                          mod= mod_n_seeds_per_fl_ns,xlevels=10)),
                aes(x=grazing_corr, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig3.tiff",
       plot=fig3,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## Prop pred seeds

```{r echo=FALSE, fig.height=4.5, fig.width=9, message=FALSE, warning=FALSE}
fig4<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Mean daily temperature June (ºC)")+
    ylab("Proportion of predated seeds")+
    theme(axis.text.y=element_text(color="white"))+ggtitle("A)")+
    geom_point(data=data_selag,aes(mean_6,prop_pred_seeds),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "mean_6",mod= mod_prop_pred_seeds_ns,xlevels=10)),
              aes(x=mean_6, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "mean_6",
                                          mod= mod_prop_pred_seeds_ns,xlevels=10)),
                aes(x=mean_6, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("First flowering date")+ylab(NULL)+
    theme(axis.text.y=element_text(color="white"))+ggtitle("B)")+
    geom_point(data=data_selag,aes(FFD,prop_pred_seeds),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "FFD",mod= mod_prop_pred_seeds_ns,xlevels=10)),
              aes(x=FFD, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "FFD",mod= mod_prop_pred_seeds_ns,xlevels=10)),
                aes(x=FFD, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=2)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig4.tiff",
       plot=fig4,device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

## Number of intact seeds

```{r echo=FALSE, fig.height=4.5, fig.width=13, message=FALSE, warning=FALSE}
fig5<-
  grid.arrange(
  ggplot()+my_theme()+xlab("Number of flowers")+ggtitle("A)")+
    ylab("Number of intact seeds")+
    geom_point(data=data_selag,aes(n_fl,n_intact_seeds_round),size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "n_fl",mod= mod_n_intact_seeds1_ns,xlevels=30)),
              aes(x=n_fl, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "n_fl",
                                          mod= mod_n_intact_seeds1_ns,xlevels=30)),
                aes(x=n_fl, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Number of seeds per flower")+ggtitle("B)")+
    ylab(NULL)+
    geom_point(data=data_selag,aes(n_seeds_per_fl_round,n_intact_seeds_round),
               size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "n_seeds_per_fl_round",
                                        mod= mod_n_intact_seeds2_ns,xlevels=30)),
              aes(x=n_seeds_per_fl_round, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "n_seeds_per_fl_round",
                                          mod= mod_n_intact_seeds2_ns,xlevels=30)),
                aes(x=n_seeds_per_fl_round, ymin=lower, ymax=upper), alpha= 0.3),
  ggplot()+my_theme()+xlab("Proportion of predated seeds")+ggtitle("C)")+
    ylab(NULL)+
    geom_point(data=data_selag,aes(prop_pred_seeds,n_intact_seeds_round),
               size=2.5,alpha=0.1) + 
    geom_line(data=as.data.frame(effect(term= "prop_pred_seeds",
                                        mod= mod_n_intact_seeds3_ns,xlevels=30)),
              aes(x=prop_pred_seeds, y=fit),size=1) +
    geom_ribbon(data=as.data.frame(effect(term= "prop_pred_seeds",
                                          mod= mod_n_intact_seeds3_ns,xlevels=30)),
                aes(x=prop_pred_seeds, ymin=lower, ymax=upper), alpha= 0.3),
  ncol=3)
ggsave(filename=
         "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms3/results/figures/fig5.tiff",
       plot=fig5,device="tiff",width=30,height=10,units="cm",dpi=300,compression="lzw")
```

# Repeat model selections with grazing = binomial

## Grazing

```{r message=FALSE, warning=FALSE}
data_selag$grazing_bin<-with(data_selag,ifelse(grazing_corr>0,1,ifelse(grazing_corr==0,0,NA)))
# Variables to use (march-may)
subset25<-subset(data_selag[c(2:3,16,37:39,81)],!is.na(grazing_bin)&!is.na(FFD)&
                   !is.na(n_fl)) 
subset25[,c(1,3:6)]<-scale(subset25[,c(1,3:6)]) 

globmod_grazing_bin_path<-glmer(grazing_bin~mean_3+mean_4+mean_5+FFD+n_fl+
                              (1|id),data = subset25,family="binomial",na.action="na.fail")

# Excluding collinear variables with r > 0.4
smat25 <- abs(cor(subset25[, -c(2,7)])) <= .4 # TRUE: cor<=0.4,FALSE: cor>0.4
smat25[!lower.tri(smat25)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust25 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust25, "subset25")
clusterEvalQ(clust25, library(lme4))
modsel_grazing_bin_path<-pdredge(globmod_grazing_bin_path,subset=smat25,cluster=clust25)
```

Variable importance, coefficients of averaged model and R square of the best model

```{r message=FALSE, warning=FALSE}
importance(modsel_grazing_bin_path) # Variable importance
kable(summary(get.models(modsel_grazing_bin_path,
                         subset=1)$"18")$coefficients) # Coefs averaged model
r.squaredGLMM(get.models(modsel_grazing_bin_path,
                         subset=1)$"18") # R square of best model
```

# Path model without climatic variables

```{r}
mod_grazing_noclim<-glmer(grazing_corr~n_fl_s+FFD_s+(1|id),data_selag,
                   family="binomial")
summary(mod_grazing_noclim) 
# Grazing <- FFD_s -0.279 * vs NS

mod_grazing_bin_noclim<-glmer(grazing_bin~n_fl_s+FFD_s+(1|id),data_selag,
                   family="binomial")
summary(mod_grazing_bin_noclim) 
# Grazing <- FFD_s -0.244 * vs NS
# Grazing <- n_fl 0.200 * vs 0.074*

mod_n_seeds_per_fl_noclim<-glmer(n_seeds_per_fl_round~FFD_s+grazing_corr_s+n_fl_s+(1|id),data_selag,
                          family="poisson")
summary(mod_n_seeds_per_fl_noclim) 
# Number of seeds per flower <- FFD -0.184 * vs -0.210 *
# Number of seeds per flower <- grazing -0.714 * vs -0.718 *
# Number of seeds per flower <- n_fl -0.226 * vs -0.237 *

mod_prop_seeds_esc_noclim<-glmer(cbind(round(n_intact_seeds),round(n_pred_seeds))~FFD_s+n_fl_s+
                            (1|id),subset(data_selag,n_seeds>0),family="binomial")
summary(mod_prop_seeds_esc_noclim)
# Proportion of seeds escaping predation <- FFD -0.316 * vs -0.534 *
# Proportion of seeds escaping predation <- n_fl -0.075 * vs -0.083 *
```

# Effects of interactions on selection

```{r}
data_selag<-as.data.frame(data_selag %>% group_by(year) %>%
  mutate(n_intact_seeds_rel=n_intact_seeds/mean(n_intact_seeds,na.rm=T))%>%  #Relative fitness
  mutate(FFD_std=(FFD-mean(FFD,na.rm=T))/sd(FFD,na.rm=T)) %>%                #Standardized FFD
  mutate(n_fl_std=(n_fl-mean(n_fl,na.rm=T))/sd(n_fl,na.rm=T)))               #Standardized n_fl
```

## Model with the three interactions

## Grazing as proportion

```{r}
mod_int_sel1<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+
                     n_seeds_per_fl+prop_seeds_esc+grazing_corr+
               FFD_std:n_seeds_per_fl+FFD_std:prop_seeds_esc+FFD_std:grazing_corr+(1|id),data_selag)
summary(mod_int_sel1)
```

## Grazing as 0/1

```{r}
data_selag$grazing_bin_factor<-as.factor(data_selag$grazing_bin)
mod_int_sel2<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+
                     n_seeds_per_fl+prop_seeds_esc+grazing_bin_factor+
               FFD_std:n_seeds_per_fl+FFD_std:prop_seeds_esc+FFD_std:grazing_bin_factor+
                 (1|id),data_selag)
summary(mod_int_sel2)
```

### Graphs of interaction effects

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction1<-data.frame(effect(term="FFD_std:n_seeds_per_fl",mod=mod_int_sel1,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1),
                                    n_seeds_per_fl=seq(0,11,0.5))))
interaction1$fit_mod<-with(interaction1,ifelse(fit<0,0,fit))

myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
ggplot(interaction1, aes(FFD_std,fit_mod, group = as.factor(n_seeds_per_fl)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=n_seeds_per_fl))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Number of seeds per flower")
```

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction2<-data.frame(effect(term="FFD_std:prop_seeds_esc",mod=mod_int_sel1,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1),
                                    prop_seeds_esc=seq(0,1,0.05))))
interaction2$fit_mod<-with(interaction2,ifelse(fit<0,0,fit))

ggplot(interaction2, aes(FFD_std,fit_mod, group = as.factor(prop_seeds_esc)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=prop_seeds_esc))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Proportion of seeds that escaped predation")
```

## Single models with each interaction

### Pollination

```{r}
mod_int_sel3<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+n_seeds_per_fl+
                     FFD_std:n_seeds_per_fl+(1|id),data_selag)
summary(mod_int_sel3)
```

### Seed predation

```{r}
mod_int_sel4<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+prop_seeds_esc+
                     FFD_std:prop_seeds_esc+(1|id),data_selag)
summary(mod_int_sel4)
```

### Grazing (as proportion)

```{r}
mod_int_sel5<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+grazing_corr+
                     FFD_std:grazing_corr+(1|id),data_selag)
summary(mod_int_sel5)
```

### Grazing (as binomial)

```{r}
mod_int_sel6<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+grazing_bin_factor+
                     FFD_std:grazing_bin_factor+(1|id),data_selag)
summary(mod_int_sel6)
```

### Graphs of interaction effects

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction3<-data.frame(effect(term="FFD_std:n_seeds_per_fl",mod=mod_int_sel3,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1),
                                    n_seeds_per_fl=seq(0,11,0.5))))
interaction3$fit_mod<-with(interaction3,ifelse(fit<0,0,fit))

myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
ggplot(interaction3, aes(FFD_std,fit_mod, group = as.factor(n_seeds_per_fl)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=n_seeds_per_fl))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Number of seeds per flower")
```

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction4<-data.frame(effect(term="FFD_std:prop_seeds_esc",mod=mod_int_sel4,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1),
                                    prop_seeds_esc=seq(0,1,0.05))))
interaction4$fit_mod<-with(interaction4,ifelse(fit<0,0,fit))

myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
ggplot(interaction4, aes(FFD_std,fit_mod, group = as.factor(prop_seeds_esc)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=prop_seeds_esc))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Proportion of seeds escaping predation")
```

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction5<-data.frame(effect(term="FFD_std:grazing_corr",mod=mod_int_sel5,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1),
                                    grazing_corr=seq(0,1,0.05))))
interaction5$fit_mod<-with(interaction5,ifelse(fit<0,0,fit))

myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
ggplot(interaction5, aes(FFD_std,fit_mod, group = as.factor(grazing_corr)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=grazing_corr))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Proportion of grazing")
```

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
interaction6<-data.frame(effect(term="FFD_std:grazing_bin_factor",mod=mod_int_sel6,
                       xlevels=list(FFD_std=seq(-2.8,3.3,0.1))))
interaction6$fit_mod<-with(interaction6,ifelse(fit<0,0,fit))

ggplot(interaction6, aes(FFD_std,fit_mod, group =grazing_bin_factor))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=grazing_bin_factor))+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()+
  theme(legend.position="top")+labs(colour="Grazing")
```





